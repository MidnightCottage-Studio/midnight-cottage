<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ Midnight Cottage</title>
    <style>
        :root {
            --bg: #09090d; --card: #12121a; --accent: #bb9af7; --gold: #ff9e64;
            --neon-blue: #7aa2f7; --heart: #f7768e; --text: #c0caf5; --border: rgba(187, 154, 247, 0.2);
            --female-bg: rgba(255, 182, 193, 0.35); --male-bg: rgba(135, 206, 235, 0.35);
            --healing: #50fa7b; --danger: #ff5555;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: #050507; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--text); overflow: hidden; user-select: none; }
        
        /* PC ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        #app { width: 98%; max-width: 1350px; height: 96vh; background: var(--bg); border-radius: 24px; display: flex; flex-direction: column; position: relative; transition: all 0.5s ease; box-shadow: 0 0 80px rgba(0,0,0,1); box-sizing: border-box; }
        
        .app-header { padding: 15px 30px; display: grid; grid-template-columns: 350px 1fr 500px; align-items: center; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--border); border-radius: 24px 24px 0 0; z-index: 10; height: auto; min-height: 60px; }
        .header-left { display: flex; flex-direction: column; gap: 8px; }
        .budget-display { font-size: 32px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }
        #news-banner { font-size: 12px; color: var(--neon-blue); font-weight: 700; background: rgba(122, 162, 247, 0.1); padding: 4px 10px; border-radius: 6px; margin-top: 2px; border-left: 3px solid var(--neon-blue); width: fit-content; max-width: 320px; }
        
        /* PC ì „ìš© ìƒíƒœì°½ */
        #pc-city-status { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        #city-name-display { font-size: 17px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
        .dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        #dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }

        /* ëª¨ë°”ì¼ ì „ìš© ìƒíƒœì°½ */
        #mobile-city-status { display: none; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 5px; flex-direction: column; gap: 4px; }
        #mob-city-name-display { font-size: 15px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
        .mob-dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); margin-top: 2px; }
        #mob-dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }
        
        .res-area { display: flex; justify-content: center; gap: 10px; }
        .res-card { display: flex; flex-direction: column; align-items: center; width: 85px; cursor: pointer; position: relative; transition: 0.2s; }
        .res-card:hover { transform: translateY(-5px); }
        .res-icon-box { width: 50px; height: 50px; border-radius: 14px; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; font-size: 24px; position: relative; }
        .stress-box { width: 100%; height: 5px; background: #222; border-radius: 3px; margin-top: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .stress-fill { height: 100%; background: var(--heart); transition: width 0.3s ease; }
        .res-name { font-size: 13px; margin-top: 4px; font-weight: 800; color: #fff; }
        .res-job { font-size: 9px; color: var(--neon-blue); font-weight: 700; margin-top: 1px; }
        .res-rel { font-size: 9px; color: var(--heart); font-weight: 800; text-align: center; min-height: 24px; margin-top: 2px; line-height: 1.2; }
        
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .top-buttons { display: flex; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; transition: 0.3s; position: relative; }
        .icon-btn:hover { background: var(--border); transform: scale(1.1); }
        .noti-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg); display: none; }
        
        /* PC ì´ë²¤íŠ¸ ë¡œê·¸ */
        #event-log { 
            font-size: 19px; 
            color: var(--accent); 
            font-weight: 800; 
            text-align: right; 
            line-height: 1.3; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            justify-content: flex-end;
            word-break: keep-all; 
            min-height: 50px; 
        }

        .content-container { flex: 1; display: flex; overflow: hidden; }
        .main-panel { flex: 1.8; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
        #desk-clicker { width: 100%; max-width: 480px; cursor: pointer; transition: transform 0.1s ease, filter 0.3s ease; filter: drop-shadow(0 0 30px rgba(187, 154, 247, 0.2)); margin-top: 40px; margin-bottom: 20px; }
        #desk-clicker:active { transform: scale(0.95); }
        .hit-effect { position: absolute; pointer-events: none; font-size: 65px; z-index: 100; animation: hit-star 0.3s ease-out forwards; }
        @keyframes hit-star { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.1); opacity: 0; } }
        
        /* ëŒ€í™”ì°½ ì»¨í…Œì´ë„ˆ */
        #dialogue-stack { 
            position: absolute; bottom: 120px; z-index: 50; width: 90%; max-width: 500px; 
            display: flex; flex-direction: column-reverse; align-items: center; gap: 8px; pointer-events: none; 
        }
        .dialogue-bubble { 
            background: rgba(0,0,0,0.85); border: 2px solid var(--accent); border-radius: 20px; padding: 12px 20px; 
            font-size: 15px; font-weight: 700; color: #fff; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            animation: slide-up-fade 0.3s ease-out forwards; max-width: 100%; pointer-events: none;
        }
        .dialogue-bubble.event { border-color: var(--gold); color: var(--gold); }
        @keyframes slide-up-fade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out-bubble {
            to { opacity: 0; transform: translateY(-10px); }
        }

        .side-menu { flex: 1.1; background: rgba(0,0,0,0.4); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; border-left: 1px solid var(--border); }
        .menu-title { font-size: 17px; font-weight: 800; color: var(--gold); border-left: 4px solid var(--gold); padding-left: 12px; margin-bottom: 10px; }
        
        /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        .up-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 12px 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.03); width: 100%; box-sizing: border-box; min-height: 80px; }
        .up-info { flex: 1; min-width: 0; margin-right: 10px; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .up-info h4 { margin: 0; font-size: 15px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .up-info p { margin: 0; font-size: 13px; color: #aaa; white-space: nowrap; }
        .tags { display: flex; gap: 5px; margin-top: 0; }
        .tag-dev { font-size: 9px; background: rgba(255, 158, 100, 0.2); color: var(--gold); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
        .tag-healing { font-size: 10px; background: rgba(80, 250, 123, 0.2); color: var(--healing); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
        .buy-btn { background: transparent; border: 1.5px solid var(--gold); color: var(--gold); padding: 8px 10px; border-radius: 10px; font-size: 13px; font-weight: 900; cursor: pointer; min-width: 80px; flex-shrink: 0; text-align: center; }
        .buy-btn:disabled { border-color: #2a2a2a; color: #444; }
        
        .toast { background: var(--gold); color: #000; padding: 12px 24px; border-radius: 50px; font-weight: 900; font-size: 18px; box-shadow: 0 0 30px var(--gold); animation: toast-pop 3s forwards; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .evo-toast { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #000; padding: 20px 40px; border-radius: 15px; font-size: 24px; font-weight: 900; z-index: 2000; animation: evo-pop 4s forwards; box-shadow: 0 0 50px var(--accent); text-align: center; border: 4px solid #fff; }
        .center-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 10, 15, 0.95); border: 2px solid var(--gold); color: var(--gold); padding: 25px 50px; border-radius: 20px; font-size: 22px; font-weight: 900; z-index: 2000; animation: fade-in-out 3s forwards; box-shadow: 0 0 40px rgba(255, 158, 100, 0.4); text-align: center; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        @keyframes fade-in-out { 0% { opacity:0; transform:translate(-50%, -40%); } 15% { opacity:1; transform:translate(-50%, -50%); } 85% { opacity:1; transform:translate(-50%, -50%); } 100% { opacity:0; transform:translate(-50%, -60%); } }
        @keyframes evo-pop { 0% { opacity:0; transform:translate(-50%, -30%) scale(0.8); } 10% { opacity:1; transform:translate(-50%, -50%) scale(1.1); } 20% { transform:translate(-50%, -50%) scale(1); } 90% { opacity:1; } 100% { opacity:0; transform:translate(-50%, -70%) scale(0.8); } }
        @keyframes toast-pop { 0% { opacity:0; transform:translateY(20px); } 15% { opacity:1; transform:translateY(0); } 85% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-20px); } }
        
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; padding: 40px; text-align: center; border-radius: 24px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal h2 { margin-top: 0; margin-bottom: 30px; font-size: 28px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 90%; overflow-y: auto; padding: 10px; max-height: 70vh; box-sizing: border-box; }
        .gallery-item { cursor: pointer; border-radius: 12px; border: 2px solid transparent; transition: 0.3s; overflow: hidden; position: relative; background: #181820; display: flex; flex-direction: column; padding-bottom: 10px; height: auto; }
        .gallery-item img { width: 100%; height: 110px; object-fit: cover; opacity: 0.4; display: block; border-bottom: 1px solid #333; }
        .gallery-item.unlocked img { opacity: 1; }
        .gallery-item.active { border-color: var(--gold); box-shadow: 0 0 20px rgba(255, 158, 100, 0.3); }
        .gallery-item div { padding: 5px 10px; box-sizing: border-box; line-height: 1.2; }
        .gallery-item.locked img { display: block; opacity: 0.15; filter: blur(3px) grayscale(100%); }
        .gallery-item.locked::before { content: 'ğŸ”’'; font-size: 24px; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 5; opacity: 0.7; }
        .museum-container { display: flex; flex-direction: column; align-items: center; gap: 30px; width: 100%; height: 100%; justify-content: center; pointer-events: none; }
        .museum-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 10px; pointer-events: auto; }
        .artifact-slot { width: 85px; height: 85px; background: #111; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; border-radius: 15px; cursor: pointer; font-size: 32px; transition: 0.3s; pointer-events: auto; }
        .artifact-slot.found { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 158, 100, 0.3); }
        #artifact-desc { pointer-events: auto; color:#aaa; font-style:italic; font-size: 18px; margin-top: 20px; }
        #history-list li { margin-bottom: 12px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px; color: #ccc; }
        
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050507; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text); }
        .start-form { background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); width: 400px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 700; color: var(--gold); }
        .form-group input, .form-group select { background: #1a1a24; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; font-family: 'Pretendard'; outline: none; }
        .form-group input::placeholder { color: #666; font-style: italic; }
        .form-group input:focus, .form-group select:focus { border-color: var(--neon-blue); }
        .nav-btns { display: flex; gap: 10px; margin-top: 15px; }
        .start-btn { flex: 1; background: var(--accent); color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; }
        .start-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--accent); }
        .prev-btn { flex: 0.4; background: #333; color: #fff; border-radius: 12px; font-weight: 700; border:none; cursor: pointer; }
        .finish-btn { flex: 1; background: #50fa7b; color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; display: none; }
        .finish-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px #50fa7b; }
        #char-count { position: absolute; top: 20px; right: 20px; font-size: 14px; color: #666; font-weight: 900; }
        .sns-container { width: 450px; height: 600px; background: var(--card); border: 2px solid var(--border); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .sns-header { background: rgba(0,0,0,0.5); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sns-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .sns-post { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .sns-user { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .sns-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        .sns-name { font-size: 14px; font-weight: 700; color: #fff; }
        .sns-time { font-size: 11px; color: #666; margin-left: auto; }
        .sns-text { font-size: 13px; color: #ccc; line-height: 1.4; }
        
        .gacha-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 400px; text-align: center; }
        .gacha-btn { background: var(--accent); color: #000; padding: 20px; border-radius: 15px; font-weight: 900; font-size: 20px; border: none; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(187, 154, 247, 0.4); display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .gacha-btn:hover { transform: scale(1.05); }
        .gacha-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; transform: none; }
        .gacha-cost { font-size: 14px; opacity: 0.8; }
        
        .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; max-height: 500px; overflow-y: auto; }
        .ach-item { background: #1a1a24; padding: 15px; border-radius: 12px; border: 1px solid #333; opacity: 0.5; transition: 0.3s; }
        .ach-item.unlocked { opacity: 1; border-color: var(--gold); background: rgba(255, 158, 100, 0.05); }
        .ach-icon { font-size: 24px; margin-bottom: 5px; }
        .ach-title { font-weight: 800; color: #fff; font-size: 14px; }
        .ach-desc { font-size: 11px; color: #aaa; margin-top: 3px; }
        
        /* ğŸ’Œ ì—”ë”© ì‹œí€€ìŠ¤ ìŠ¤íƒ€ì¼ */
        #ending-sequence { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .rolling-container { text-align: center; opacity: 0; transform: translateY(20px); transition: 1s ease; display: flex; flex-direction: column; align-items: center; }
        .rolling-container.show { opacity: 1; transform: translateY(0); }
        .end-emoji { font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--accent)); }
        .end-name { font-size: 24px; font-weight: 800; color: var(--gold); margin-bottom: 20px; }
        .end-msg { font-size: 22px; color: #fff; font-weight: 300; line-height: 1.6; max-width: 80%; margin: 0 auto; word-break: keep-all; font-family: 'Pretendard', serif; }
        .ending-btn { background: var(--gold); color: #000; padding: 15px 30px; border-radius: 30px; font-weight: 900; font-size: 18px; border: none; cursor: pointer; transition: 0.3s; }
        .ending-btn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        /* ğŸŒŸ 2. ëª¨ë°”ì¼ ë°˜ì‘í˜• CSS */
        @media (max-width: 768px) {
            body { height: 100vh; overflow: hidden; position: fixed; width: 100%; }
            #app { height: 100%; width: 100%; border-radius: 0; display: flex; flex-direction: column; }

            /* ğŸ› ï¸ [ëª¨ë°”ì¼] í—¤ë” ìˆœì„œ ì¬ë°°ì¹˜: ëˆ(1) -> ë©”ë‰´(2) -> ì£¼ë¯¼(3) */
            .app-header { display: flex; flex-direction: column; padding: 5px 15px 15px 15px; gap: 2px; height: auto; flex-shrink: 0; align-items: center; border-bottom: none; }
            
            .header-left { width: 100%; order: 1; align-items: flex-start; margin-bottom: 0px; }
            .budget-display { font-size: 24px; margin: 0; justify-content: flex-start; white-space: nowrap; width: 100%; }
            #news-banner { display: none; }
            #pc-city-status { display: none; }

            /* ğŸ› ï¸ [ëª¨ë°”ì¼] ìƒë‹¨ ë©”ë‰´ ì•„ì´ì½˜ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            .header-right { width: 100%; order: 2; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; margin-top: 5px; }
            .top-buttons { width: 100%; display: flex; gap: 12px; margin: 0; flex-wrap: nowrap; overflow-x: auto; justify-content: center; }
            .icon-btn { width: 38px; height: 38px; font-size: 18px; flex-shrink: 0; }
            
            /* [ëª¨ë°”ì¼] ì´ë²¤íŠ¸ ë¡œê·¸ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
            #event-log { display: none !important; }

            /* ğŸ› ï¸ [ëª¨ë°”ì¼] ì£¼ë¯¼ ëª©ë¡ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            .res-area { order: 3; width: 100%; margin-top: 10px; padding-bottom: 2px; overflow-x: auto; justify-content: center; display: flex; }
            .res-card { min-width: 55px; margin-right: 5px; transform: none !important; transition: none !important; }
            .res-card:hover, .res-card:active { transform: none !important; margin-top: 0 !important; }
            .res-icon-box { width: 40px; height: 40px; font-size: 20px; }
            .res-name { font-size: 10px; margin-top: 2px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
            /* ğŸ› ï¸ [ëª¨ë°”ì¼ ìˆ˜ì •] ì§ì—…ê³¼ ê´€ê³„(ì†”ë¡œ/ì»¤í”Œ) ëª¨ë‘ í‘œì‹œ */
            .res-job { 
                display: block !important; 
                font-size: 8px; 
                color: var(--neon-blue); 
                margin-top: 1px;
                white-space: nowrap;
            }
            .res-rel { 
                display: block !important; 
                font-size: 8px; 
                color: var(--heart); 
                margin-top: 0px;
                white-space: nowrap;
            }

            .content-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

            .main-panel { flex: 0 0 35%; padding: 0; order: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
            #desk-clicker { width: 100%; height: 100%; object-fit: contain; margin: 0; }
            /* ëŒ€í™”ì°½ ìœ„ì¹˜ ì¡°ì • */
            #dialogue-stack { bottom: 10px; width: 90%; gap: 6px; }
            .dialogue-bubble { font-size: 13px; padding: 10px; }

            /* ğŸ› ï¸ [ëª¨ë°”ì¼] ì‚¬ì´ë“œ ë©”ë‰´(ì •ë³´ì°½) ì—¬ë°± íƒ€ì´íŠ¸í•˜ê²Œ ì¡°ì • */
            .side-menu { flex: 1; order: 2; height: auto; overflow-y: auto; border-top: 2px solid var(--border); background: rgba(0,0,0,0.9); padding: 10px 15px 80px 15px; }
            #mobile-city-status { display: flex; margin-bottom: 5px; padding: 8px; } 
            
            /* ğŸ”¥ [ìˆ˜ì •] 1. ê°œë°œì¼ì§€ ì™¼ìª½ ì •ë ¬ */
            .menu-title { margin-bottom: 5px; text-align: left; border-left: none; padding-left: 0; }
            
            /* ğŸ”¥ [ìˆ˜ì •] 2. ì—…ê·¸ë ˆì´ë“œ ì¹´ë“œ ì„¸ë¡œ ì •ë ¬ ë° ë²„íŠ¼ í•˜ë‹¨ ë°°ì¹˜ */
            .up-card { flex-direction: column; align-items: flex-start; padding: 12px; min-height: auto; margin-bottom: 8px; gap: 8px; }
            .up-info { width: 100%; margin-right: 0; }
            .up-info h4, .up-info p { white-space: normal; word-break: keep-all; overflow: visible; } /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
            .buy-btn { width: 100%; margin-top: 5px; height: 40px; } /* ë²„íŠ¼ í•˜ë‹¨ ê½‰ ì±„ìš°ê¸° */

            .evo-toast { width: 85%; min-width: unset; white-space: nowrap; font-size: 16px; padding: 12px 10px; bottom: 35%; border-width: 2px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

            .modal h2, #history-modal h2 { margin-top: 0 !important; margin-bottom: 15px !important; padding-top: 0 !important; line-height: 1.2; transform: translateY(-10px); }
            #history-list { padding-top: 0 !important; margin-top: 0 !important; }

            .sns-container { width: 100%; height: 75%; margin-top: -20px; margin-bottom: 20px; }

            .museum-container { width: 100%; display: flex; flex-direction: column; padding: 10px 0; overflow-x: hidden; height: 100%; }
            .museum-container h2 { order: 1; flex-shrink: 0; }
            #artifact-desc { order: 2; margin-bottom: 10px; margin-top: 0; font-size: 13px; color: var(--neon-blue); min-height: 20px; flex-shrink: 0; }
            .museum-grid { order: 3; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 95%; margin: 0 auto; padding: 0 5px 100px 5px; box-sizing: border-box; overflow-y: auto; }
            .artifact-slot { width: 100%; aspect-ratio: 1 / 1; font-size: 14px; } 

            .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 5px 80px 5px; width: 100%; box-sizing: border-box; overflow-y: auto; }
            .gallery-item { width: 100%; height: auto; display: flex; flex-direction: column; }
            .gallery-item img { width: 100%; height: auto; aspect-ratio: 16 / 9; object-fit: cover; }

            .modal { position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; z-index: 9999; padding: 20px; box-sizing: border-box; }
            .start-form { width: 90%; max-width: 350px; padding: 20px; box-sizing: border-box; margin: 0 auto; }
            .gacha-container { width: 100%; }
        }

        /* ğŸ”˜ [ì¶”ê°€] ë²„íŠ¼ í´ë¦­ ë½€ì‰ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes boing {
            0% { transform: scale(1); }
            40% { transform: scale(0.9); }  /* ê¾¹ ëˆŒë¦¼ */
            60% { transform: scale(1.1); }  /* ë ìš© í•˜ê³  ì»¤ì§ */
            100% { transform: scale(1); }   /* ì›ìƒë³µêµ¬ */
        }
        .click-animate {
            animation: boing 0.3s ease-out forwards;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen" style="display:flex;">
        <div class="start-form">
            <h2 style="text-align:center; color:var(--accent); margin-bottom:10px;">ğŸ“„ ì…ì£¼ ì‹ ì²­ì„œ</h2>
            
            <div style="background:rgba(66, 133, 244, 0.1); border:1px solid rgba(66, 133, 244, 0.3); border-radius:12px; padding:10px; margin-bottom:15px; text-align:center;">
                <p style="font-size:12px; color:#ccc; margin:0 0 8px 0;">ì´ë¯¸ ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ì— ì‚´ê³  ê³„ì‹ ê°€ìš”?</p>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button id="btn-login-start" onclick="googleLogin()" style="background:#4285F4; color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; width: 100%;">
                        G êµ¬ê¸€ ë¡œê·¸ì¸ (ë¶ˆëŸ¬ì˜¤ê¸° / ê³„ì •ì—°ë™)
                    </button>
                </div>
            </div>

            <div id="char-count">1 / 5</div>
            <div class="form-group">
                <label>ì´ë¦„ (ë‹‰ë„¤ì„)</label>
                <input type="text" id="input-name" placeholder="ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì„±ë³„</label>
                <select id="input-gender">
                    <option value="ë‚¨">ë‚¨ì„±</option>
                    <option value="ì—¬">ì—¬ì„±</option>
                    <option value="ë¬´">ë¬´ì„±/ê¸°íƒ€</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì§ì—… (ì„ íƒ)</label>
                <select id="input-job">
                    <option value="í™”ê°€">ğŸ¨ í™”ê°€</option>
                    <option value="ì†Œì„¤ê°€">âœï¸ ì†Œì„¤ê°€</option>
                    <option value="êµìˆ˜">ğŸ“š êµìˆ˜</option>
                    <option value="ë¦¬í¼ë‹¥">ğŸ› ï¸ ë¦¬í¼ë‹¥</option>
                    <option value="ASMR DJ">ğŸ§ ASMR DJ</option>
                    <option value="ëª¨ë¸">ğŸ‘  ëª¨ë¸</option>
                    <option value="í˜•ì‚¬">ğŸ•µï¸ í˜•ì‚¬</option>
                    <option value="ë„·ëŸ¬ë„ˆ">ğŸ’» ë„·ëŸ¬ë„ˆ</option>
                    <option value="ë¼ë©˜ë…¸ì ìƒ">ğŸœ ë¼ë©˜ë…¸ì ìƒ</option>
                    <option value="ì˜¨ì²œì£¼ì¸">â™¨ï¸ ì˜¨ì²œì£¼ì¸</option>
                    <option value="LPë°” ì‚¬ì¥ë‹˜">ğŸ’¿ LPë°” ì‚¬ì¥ë‹˜</option>
                    <option value="ë®¤ì§€ì…˜">ğŸ¸ ë®¤ì§€ì…˜</option>
                    <option value="ê³ ì–‘ì´">ğŸ± ê³ ì–‘ì´</option>
                    <option value="VIP">ğŸ‘‘ VIP</option>
                </select>
            </div>
            <div class="nav-btns">
                <button class="prev-btn" onclick="prevChar()" id="btn-prev" style="display:none;">ì´ì „</button>
                <button class="start-btn" onclick="nextChar()" id="btn-next">ì¶”ê°€ (1/5)</button>
                <button class="finish-btn" onclick="finishSetup()" id="btn-finish">ì…ì£¼ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <div id="ending-sequence">
        <div class="rolling-container">
            <div id="end-emoji" class="end-emoji"></div>
            <div id="end-name" class="end-name"></div>
            <div id="end-msg" class="end-msg"></div>
        </div>
        <div id="final-screen" style="display:none; text-align:center; z-index:6005;">
            <h1 style="font-size:40px; color:var(--accent); margin-bottom:20px;">The End</h1>
            <p style="color:#ccc; margin-bottom:30px; line-height: 1.6;">
                ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ì˜ ë°¤ì€ ê³„ì†ë©ë‹ˆë‹¤.<br>
                ë‹¹ì‹ ì˜ ì‘ì—…ë„ ì´ë“¤ì²˜ëŸ¼ ë¹›ë‚˜ê¸°ë¥¼.
            </p>
            <button class="ending-btn" onclick="closeEndingSequence()">ë‚¨ì•„ì„œ ê³„ì†í•˜ê¸°</button>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <div class="app-header">
        <div class="header-left">
            <div class="budget-display">ğŸ’µ <span id="budget">0</span></div>
            <div id="news-banner">ğŸ“¢ ë‰´ìŠ¤ ë¡œë”© ì¤‘...</div>
            <div id="pc-city-status">
                <div id="city-name-display">ì†Œë°•í•˜ê³  ì•„ëŠ‘í•œ ì‚¬ì´ë²„í‘í¬ ë°©</div>
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span style="color:var(--gold); font-weight:800;">â­ ë°œì „ë„</span>
                        <div onclick="toggleModal('dev-info-modal')" 
                             style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                    </div>
                    <div id="dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                </div>
                <div class="dev-bar-bg"><div id="dev-bar-fill"></div></div>
            </div>
        </div>
        
        <div class="res-area" id="res-grid"></div>
        
        <div class="header-right">
            <div class="top-buttons">
                <button class="icon-btn" onclick="toggleModal('shop-modal')">ğŸº</button>
                <button class="icon-btn" onclick="toggleModal('sns-modal')">ğŸ“±<div id="sns-dot" class="noti-dot"></div></button>
                <button class="icon-btn" onclick="toggleModal('ach-modal')">ğŸ†</button>
                <button class="icon-btn" onclick="openGallery()">ğŸ–¼ï¸</button>
                <button class="icon-btn" onclick="toggleModal('museum-modal')" style="font-size:12px !important;">ğŸ›ï¸</button>
                <button class="icon-btn" onclick="toggleModal('history-modal')">ğŸ“œ</button>
                <button class="icon-btn" onclick="toggleModal('help-modal')">?</button>
            </div>
            <div id="event-log">ğŸ’»ì‘ì—… í™”ì´íŒ…! ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ê°€ ë„ˆë¥¼ ë°˜ê²¨.</div>
        </div>
    </div>

    <div class="content-container">
        <div class="main-panel">
            <img id="desk-clicker" src="https://i.imgur.com/MuFQQ5A.png" alt="City Image">
            <div id="dialogue-stack"></div>
        </div>
        <div class="side-menu">
            <div class="menu-title">ë¯¸ë“œë‚˜ì‡ ì‹œí‹° ê°œë°œì¼ì§€ <span id="artifact-boost" style="font-size:11px; color:var(--gold)"></span></div>
            
            <div id="mobile-city-status">
                <div id="mob-city-name-display">ì†Œë°•í•˜ê³  ì•„ëŠ‘í•œ ì‚¬ì´ë²„í‘í¬ ë°©</div>
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span style="color:var(--gold); font-weight:800;">â­ ë°œì „ë„</span>
                        <div onclick="toggleModal('dev-info-modal')" 
                             style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                    </div>
                    <div id="mob-dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                </div>
                <div class="mob-dev-bar-bg"><div id="mob-dev-bar-fill"></div></div>
            </div>

            <div id="upgrade-list"></div>
        </div>
    </div>

    <div id="gallery-modal" class="modal" onclick="closeModalByBg(event, 'gallery-modal')">
        <h2 style="color:var(--gold); pointer-events:none;">ğŸ–¼ï¸ ì½”í‹°ì§€ ë£¸ ê°¤ëŸ¬ë¦¬</h2>
        <div id="gallery-grid" class="gallery-grid" onclick="event.stopPropagation()"></div>
    </div>
    <div id="museum-modal" class="modal" onclick="closeModalByBg(event, 'museum-modal')">
        <div class="museum-container">
            <h2 style="color:var(--gold); margin: 0; pointer-events: none;">ğŸ›ï¸ 2202ë…„ ì—­ì‚¬ ë°•ë¬¼ê´€ (2026 ìœ ë¬¼)</h2>
            <div id="museum-list" class="museum-grid"></div>
            <p id="artifact-desc" style="pointer-events: none;">ìœ ë¬¼ì„ í´ë¦­í•˜ë©´ í…Œì˜¤ êµìˆ˜ì˜ í•œ ì¤„ í‰ì´ ë‚˜ì˜µë‹ˆë‹¤.</p>
        </div>
    </div>
    <div id="history-modal" class="modal" onclick="closeModalByBg(event, 'history-modal')">
        <h2 style="color:var(--accent); margin-bottom: 20px; pointer-events:none;">ğŸ“œ ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ ê¸°ë¡</h2>
        <ul id="history-list" style="width:90%; text-align:left; overflow-y:auto; max-height:500px; padding:0 30px; list-style:none;" onclick="event.stopPropagation()"></ul>
    </div>
    <div id="shop-modal" class="modal" onclick="closeModalByBg(event, 'shop-modal')">
        <h2 style="color:#bd93f9;">ğŸº ê³ ëŒ€ ìœ ë¬¼ ë°•ë¬¼ê´€ (Artifacts)</h2>
        <div class="gacha-container" onclick="event.stopPropagation()">
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">
                2026ë…„ì˜ ìŠí˜€ì§„ ê³ ëŒ€ ìœ ë¬¼ì„ ë°œêµ´í•˜ê³  ë³µì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤.<br>
                ìœ ë¬¼ì„ ë³µì›í•˜ì—¬ ì „ì‹œí•˜ë©´ <b>ì „ì²´ ìˆ˜ìµ ë³´ë„ˆìŠ¤</b>ë¥¼ ì–»ìŠµë‹ˆë‹¤.
            </p>
            <button class="gacha-btn" id="btn-gacha" onclick="buyArtifact()">
                â›ï¸ ìœ ë¬¼ ë°œêµ´ ë° ë³µì› ì‹œë„
                <span class="gacha-cost" id="gacha-price"></span>
            </button>
        </div>
    </div>
    <div id="sns-modal" class="modal" onclick="closeModalByBg(event, 'sns-modal')">
        <div class="sns-container">
            <div class="sns-header">
                <span style="font-weight:900; color:var(--neon-blue);">ğŸ“± Midnight Talk</span>
                <span style="font-size:12px; color:#666;">ì‹¤ì‹œê°„</span>
            </div>
            <div id="sns-feed" class="sns-feed"></div>
        </div>
    </div>
    <div id="ach-modal" class="modal" onclick="closeModalByBg(event, 'ach-modal')">
        <h2 style="color:var(--gold);">ğŸ† ë¹„ë°€ ì—…ì </h2>
        <div id="ach-grid" class="ach-grid" onclick="event.stopPropagation()"></div>
    </div>
    <div id="help-modal" class="modal" onclick="closeModalByBg(event, 'help-modal')">
        <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 300px;">
            <h2 style="color:var(--gold)">ğŸ  ì„¤ì • ë° ê°€ì´ë“œ</h2>
            <p style="font-size:15px; line-height:1.8; color:#ccc; margin-bottom: 20px;">
                1. <b>ğŸº ìœ ë¬¼ ë°•ë¬¼ê´€</b>ì—ì„œ ìœ ë¬¼ì„ ë³µì›í•´ ìˆ˜ìµì„ ë»¥íŠ€ê¸°í•˜ì„¸ìš”.<br>
                2. <b>ğŸ“± ë¯¸ë“œë‚˜ì‡ í†¡</b>ì—ì„œ ì£¼ë¯¼ë“¤ì˜ ì†ë§ˆìŒì„ ì—¿ë³´ì„¸ìš”.<br>
                3. ë§ˆì§€ë§‰ <b>ìœ í† í”¼ì•„ ë­í¬</b>ì— ë„ë‹¬í•˜ë©´ ì—”ë”©!
            </p>
            
            <div style="margin-bottom: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <h3 style="margin-top:0; font-size:16px; color:var(--neon-blue); margin-bottom: 10px;">â˜ï¸ ë°ì´í„° ë°±ì—…</h3>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button id="btn-login-help" onclick="googleLogin()" style="background:#4285F4; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">
                        G êµ¬ê¸€ ê³„ì • ì—°ë™
                    </button>
                </div>
                <p id="cloud-status-msg" style="font-size:11px; color:#888; margin-top:8px;">
                    * ë¡œê·¸ì¸ ì‹œ 4ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤.
                </p>
            </div>

            <button onclick="resetGame()" style="background:var(--danger); color:#fff; border:none; padding:12px 20px; border-radius:12px; font-weight:900; cursor:pointer; font-size:14px; box-shadow:0 0 10px rgba(255, 85, 85, 0.3); width: 100%;">
                âš ï¸ ë°ì´í„° ì´ˆê¸°í™” (ì²˜ìŒë¶€í„°)
            </button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // 2. Firebase ì„¤ì • ë° ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyDAS2-ax-ORpsnGoG6XNsMx3rlQ9yJMkUc",
        authDomain: "midnight-cottage-server.firebaseapp.com",
        projectId: "midnight-cottage-server",
        storageBucket: "midnight-cottage-server.firebasestorage.app",
        messagingSenderId: "680262922046",
        appId: "1:680262922046:web:bd79062e2bf1f20464866f"
    };

    // Firebase ì‹¤í–‰
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´

    // 3. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    const state = {
        money: 0, clickPower: 1, autoIncome: 1, 
        upgrades: [], history: [], artifacts: Array(20).fill(false),
        rank: 1, currentSelectedRank: 1, totalUniquePurchased: 0,
        residents: [], achievements: [], endingSeen: false
    };

    // 4. Firebase ë¡œê·¸ì¸ ë° í´ë¼ìš°ë“œ í•¨ìˆ˜ë“¤
    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                alert(`ë°˜ê°€ì›Œìš”, ${result.user.displayName}ë‹˜! ê³„ì •ì´ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            })
            .catch((error) => {
                console.error(error);
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            });
    }

    // ğŸŒŸ ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ëª¨ì–‘ì„ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
    function updateAuthUI(user) {
        const loginBtnStart = document.getElementById('btn-login-start');
        const loginBtnHelp = document.getElementById('btn-login-help');
        const msg = document.getElementById('cloud-status-msg');

        if (user) {
            // ë¡œê·¸ì¸ ë˜ì—ˆì„ ë•Œ: ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            if(loginBtnStart) {
                loginBtnStart.innerText = `âœ… ì—°ë™ë¨ (${user.displayName})`;
                loginBtnStart.disabled = true;
                loginBtnStart.style.opacity = "0.7";
                loginBtnStart.style.cursor = "default";
            }
            if(loginBtnHelp) {
                loginBtnHelp.innerText = `âœ… ì—°ë™ ì™„ë£Œ: ${user.displayName}`;
                loginBtnHelp.disabled = true;
                loginBtnHelp.style.opacity = "0.7";
                loginBtnHelp.style.cursor = "default";
            }
            if(msg) msg.innerText = `* ${user.displayName}ë‹˜ì˜ ê³„ì •ì— ì•ˆì „í•˜ê²Œ ìë™ ì €ì¥ë˜ê³  ìˆìŠµë‹ˆë‹¤.`;
        } else {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ: ì›ë˜ëŒ€ë¡œ ë³µêµ¬
            if(loginBtnStart) { loginBtnStart.innerText = "G êµ¬ê¸€ ë¡œê·¸ì¸ìœ¼ë¡œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"; loginBtnStart.disabled = false; }
            if(loginBtnHelp) { loginBtnHelp.innerText = "G êµ¬ê¸€ ê³„ì • ì—°ë™"; loginBtnHelp.disabled = false; }
        }
    }

    // [ìˆ˜ì •] ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì‹ ê·œ ìœ ì € ì•ˆë‚´ ì¶”ê°€)
    function loadDataFromCloud() {
        if (!currentUser) return;
        
        db.collection("users").doc(currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    // 1. ì €ì¥ëœ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° (ê¸°ì¡´ ìœ ì €)
                    const data = doc.data();
                    Object.assign(state, data);
                    
                    render(); 
                    updateUI();
                    renderAchievements();
                    
                    showCenterPopup("ğŸ”„", "ë°ì´í„° ë¡œë“œ ì™„ë£Œ", "í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    addHistory("â˜ï¸ <b>í´ë¼ìš°ë“œ:</b> ì €ì¥ëœ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");

                    // ê²Œì„ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì§„ì…
                    document.getElementById('start-screen').style.display = 'none';
                } else {
                    // 2. ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° (ì‹ ê·œ ìœ ì €)
                    // ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¼, ì´ì œë¶€í„° ì´ ê³„ì •ì— ì €ì¥í•˜ê² ë‹¤ëŠ” ëœ»ì„ì„ ì•Œë¦¼
                    alert(`ë°˜ê°‘ìŠµë‹ˆë‹¤, ${currentUser.displayName}ë‹˜!\nì•„ì§ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì´ ê³„ì •ìœ¼ë¡œ 'ìƒˆë¡œìš´ ì…ì£¼'ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n(ì´ì œë¶€í„° ìë™ìœ¼ë¡œ í´ë¼ìš°ë“œì— ë°±ì—…ë©ë‹ˆë‹¤.)`);
                    
                    // ë²„íŠ¼ ìƒíƒœ ê°±ì‹  (âœ… ì—°ë™ë¨ í‘œì‹œ)
                    updateAuthUI(currentUser);
                }
            })
            .catch((error) => {
                console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ", error);
                alert("ë°ì´í„° í™•ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + error.message);
            });
    }
    
    // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log("ë¡œê·¸ì¸ ë¨:", user.displayName);
            updateAuthUI(user);
            loadDataFromCloud();
        } else {
            currentUser = null;
            updateAuthUI(null);
            console.log("ë¡œê·¸ì•„ì›ƒ ìƒíƒœ");
        }
    });

    // 5. ê²Œì„ ë°ì´í„° ë° ë¡œì§
    const jobEmojis = {
        "í™”ê°€": "ğŸ¨", "ì†Œì„¤ê°€": "âœï¸", "êµìˆ˜": "ğŸ“š", "ë¦¬í¼ë‹¥": "ğŸ› ï¸",
        "ASMR DJ": "ğŸ§", "ëª¨ë¸": "ğŸ‘ ", "í˜•ì‚¬": "ğŸ•µï¸", "ë„·ëŸ¬ë„ˆ": "ğŸ’»",
        "ë¼ë©˜ë…¸ì ìƒ": "ğŸœ", "ì˜¨ì²œì£¼ì¸": "â™¨ï¸", "LPë°” ì‚¬ì¥ë‹˜": "ğŸ’¿",
        "ë®¤ì§€ì…˜": "ğŸ¸", "ê³ ì–‘ì´": "ğŸ±", "VIP": "ğŸ‘‘"
    };

    const jobsData = {
        "í™”ê°€": { 'Solo': ["ë„¤ì˜¨ ë¬¼ê°ì´ ëª½ê¸€ëª½ê¸€í•´.", "ì´ ìƒ‰ì±„ëŠ” ë„ˆë¥¼ ë‹®ì•˜ì–´.", "ë¶“ ëì—ì„œ ìƒˆë²½ì´ í”¼ì–´ë‚˜.", "ìº”ë²„ìŠ¤ëŠ” ì•„ì§ ë¯¸ì™„ì„±ì´ì•¼."], 'Love': ["ë„¤ ëˆˆë™ì ìƒ‰ì„ ë‹´ê³  ì‹¶ì–´.", "ë„ˆë‘ ìˆìœ¼ë©´ ì„¸ìƒì´ í˜•ê´‘ë¹›ì´ì•¼.", "ê°€ì¥ ì™„ë²½í•œ ìƒ‰ì€ ë„ˆì•¼."], 'Affair': ["ë¹„ë°€ìŠ¤ëŸ¬ìš´ ìƒ‰ì´ ë§¤í˜¹ì ì´ì§€.", "ê¸ˆì§€ëœ ì„ ì„ ë„˜ëŠ” ê±´ ì§œë¦¿í•´.", "ëª°ë˜ ê·¸ë¦¬ëŠ” ë„¤ ì´ˆìƒí™”ê°€ ì¢‹ì•„."], 'Stress': ["ë¶“ì„ êº¾ì–´ë²„ë¦¬ê³  ì‹¶ì–´!", "ì•„ë¬´ê²ƒë„ ê·¸ë¦¬ê¸° ì‹«ì–´.", "ì„¸ìƒì´ ì˜¨í†µ íšŒìƒ‰ì´ì•¼."] },
        "ì†Œì„¤ê°€": { 'Solo': ["ë¬¸ì¥ë“¤ì´ ì¶¤ì„ ì¶”ë„¤.", "ì´ ë„ì‹œì˜ ëª¨ë“  ê±´ ì†Œì„¤ê°ì´ì•¼.", "ì—”ë”©ì„ ì–´ë–»ê²Œ ë‚¼ê¹Œ?"], 'Love': ["ë„ˆì™€ì˜ ì‚¬ë‘ì€ ë² ìŠ¤íŠ¸ì…€ëŸ¬ì•¼.", "ë‚´ ì†Œì„¤ì˜ ì£¼ì¸ê³µì€ ë„ˆì•¼.", "í•´í”¼ì—”ë”©ë§Œ ì“°ê³  ì‹¶ì–´."], 'Affair': ["ê¸ˆì§€ëœ ì±•í„°ë¥¼ ì“°ëŠ” ê¸°ë¶„ì´ì•¼.", "ë…ìëŠ” ëª¨ë¥´ëŠ” ìš°ë¦¬ë§Œì˜ ë°˜ì „.", "ìœ„í—˜í•œ ë³µì„ ì²˜ëŸ¼ ë„ˆì—ê²Œ ëŒë ¤."], 'Stress': ["ê¸€ìê°€ ë²Œë ˆì²˜ëŸ¼ ë³´ì—¬!", "ì›ê³ ì§€ ë‹¤ ë¶ˆíƒœìš¸ ê±°ì•¼!", "ë‚´ ì¸ìƒì€ ì‹¤íŒ¨ì‘ì´ì•¼."] },
        "êµìˆ˜": { 'Solo': ["ì—­ì‚¬ëŠ” ë°˜ë³µë˜ì§€.", "ì˜¤ë˜ëœ ì±… ëƒ„ìƒˆê°€ ì¢‹ì•„.", "2026ë…„ì€ ì°¸ ë‚­ë§Œì ì´ì—ˆêµ°."], 'Love': ["ë„ˆëŠ” ì—­ì‚¬ìƒ ê°€ì¥ ì•„ë¦„ë‹¤ì›Œ.", "ë„ˆë¥¼ í‰ìƒ ì—°êµ¬í•˜ê³  ì‹¶ì–´.", "ê³ ì „ ì‹œë³´ë‹¤ ë„¤ê°€ ë” ìš°ì•„í•´."], 'Affair': ["ê¸ˆì§€ëœ ì—­ì‚¬ë§Œí¼ í¥ë¯¸ë¡­êµ°.", "ë„ë•ì  ì£ëŒ€ë³´ë‹¤ ë„¤ê°€ ì¤‘ìš”í•´.", "ì´ê±´ ë¹„ë°€ ìˆ˜ì—…ì´ì•¼."], 'Stress': ["ë°ì´í„° ì°Œêº¼ê¸°ë“¤! ì¡°ìš©íˆ í•´!", "ì§€ì‹ì€ ë‹¤ ì“¸ëª¨ì—†ì–´.", "ì±…ì„ ë‹¤ ì°¢ê³  ì‹¶êµ°."] },
        "ë¦¬í¼ë‹¥": { 'Solo': ["ê¸°ê³„ëŠ” ê±°ì§“ë§ ì•ˆ í•´.", "ì–´ë”” ê³ ì¥ ë‚œ ê³³ ì—†ì–´?", "ê¸°ë¦„ ëƒ„ìƒˆê°€ í–¥ê¸‹í•˜ë„¤."], 'Love': ["ë‚´ ì‹¬ì¥ ì—”ì§„ì€ ë„ˆ ë•Œë¬¸ì— ëŒì•„ê°€.", "ë„ ìœ„í•´ ìµœê³ ì˜ ë¶€í’ˆì„ ì¤€ë¹„í–ˆì–´.", "ë„ˆ ì—†ìœ¼ë©´ ë‚œ ì…§ë‹¤ìš´ì´ì•¼."], 'Affair': ["ë³´ì•ˆ í”„ë¡œí† ì½œì„ ìš°íšŒí–ˆì–´.", "ìœ„í—˜í•œ ì˜¤ë²„í´ëŸ­ ì¤‘ì´ì•¼.", "í•©ì„ ë  ê²ƒì²˜ëŸ¼ ì§œë¦¿í•´."], 'Stress': ["ë‹¤ ê³ ë¬¼ìƒì— ë²„ë ¤ë²„ë ¤!", "ìŠ¤íŒŒí¬ê°€ íŠ€ì–´! ë‚´ ë¨¸ë¦¬ë„!", "ë§í•  ê¸°ê³„ ë©ì–´ë¦¬ë“¤."] },
        "ASMR DJ": { 'Solo': ["ë¹—ì†Œë¦¬ ë“¤ë ¤ì¤„ê¹Œ?", "íŒ…ê¸€ì´ ëŠê»´ì§€ë‹ˆ?", "ì˜¤ëŠ˜ ë°¤ì€ ë‚´ ëª©ì†Œë¦¬ì™€ í•¨ê»˜í•´."], 'Love': ["ë„ˆì—ê²Œë§Œ ë“¤ë ¤ì£¼ëŠ” ì†ì‚­ì„ì´ì•¼.", "ë„¤ ìˆ¨ì†Œë¦¬ê°€ ìµœê³ ì˜ ASMRì´ì•¼.", "ìš°ë¦¬ ì£¼íŒŒìˆ˜ëŠ” ì¼ì¹˜í•´."], 'Affair': ["ë§ˆì´í¬ ë„ê³  ë¹„ë°€ ì–˜ê¸°í• ê¹Œ?", "ë°©ì†¡ ì‚¬ê³  ê°™ì€ ì‚¬ë‘ì´ì•¼.", "ë‚¨ë“¤ì€ ëª¨ë¥´ëŠ” ì‹œê·¸ë„."], 'Stress': ["ì†Œë¦¬ ì§€ë¥´ê³  ì‹¶ì–´!", "ì´ëª…ì´ ë“¤ë ¤, ê´´ë¡œì›Œ.", "ëª¨ë“  ì†ŒìŒì´ ë”ì°í•´."] },
        "ëª¨ë¸": { 'Solo': ["ì˜¤ëŠ˜ ë‚´ í¬ë¡¬ ê´‘íƒ ì™„ë²½í•´?", "í”Œë˜ì‹œ ì„¸ë¡€ëŠ” ì§€ê²¨ì›Œ.", "ì´ ê±°ë¦¬ëŠ” ë‚´ ëŸ°ì›¨ì´ì•¼."], 'Love': ["ë‚˜ë³´ë‹¤ ë„¤ê°€ ë” ë¹›ë‚˜.", "ìš°ë¦¬ íˆ¬ìƒ·ì€ í™”ë³´ ê·¸ ìì²´ì•¼.", "ë„ˆë§Œì˜ ë®¤ì¦ˆê°€ ë ê²Œ."], 'Affair': ["ìŠ¤ìº”ë“¤? ìƒê´€ì—†ì–´.", "ì¹´ë©”ë¼ ë’¤ì—ì„œ ë§Œë‚˜ëŠ” ê²Œ ì¢‹ì•„.", "ìœ„í—˜í• ìˆ˜ë¡ ë” ìŠ¤íƒ€ì¼ë¦¬ì‹œí•´."], 'Stress': ["ë‚´ ì–¼êµ´ ë³´ì§€ ë§ˆ!", "ì¡°ëª… ë‹¤ êº¼ë²„ë ¤!", "ë‹¤ë“¤ ë‚˜ë¥¼ ê»ë°ë ¥ì´ë§Œ ë´."] },
        "í˜•ì‚¬": { 'Solo': ["ë¹„ ë‚´ë¦¬ëŠ” ê±°ë¦¬ëŠ” ì¦ê±°ë¥¼ ê°ì¶”ì§€.", "í•©ì„± ë‹´ë°° ì—°ê¸°ê°€ ë§µêµ°.", "ì§ê°ì´ ì™”ì–´."], 'Love': ["ë„Œ ë‚´ê°€ ì°¾ë˜ ë§ˆì§€ë§‰ í¼ì¦ì´ì•¼.", "ë„¤ê°€ ë²”ì¸ì´ë¼ë©´ ì²´í¬ë‹¹í•´ì¤„ê²Œ.", "ë‚´ ì´êµ¬ëŠ” ë„ ì§€í‚¤ê¸° ìœ„í•´ì„œë§Œ ë“¤ì–´."], 'Affair': ["ì ë³µê·¼ë¬´ í•‘ê³„ ëŒ€ê³  ë‚˜ì™”ì–´.", "ì´ ê´€ê³„ëŠ” ì¼ê¸‰ ê¸°ë°€ì´ì•¼.", "ì¦ê±°ë¥¼ ë‚¨ê¸°ì§€ ë§ˆ."], 'Stress': ["ì´ ë„ì‹œëŠ” ì©ì—ˆì–´.", "ë²”ì¸ë„ ì •ì˜ë„ ë‹¤ ì§€ê²¨ì›Œ.", "ë¨¸ë¦¬ê°€ ê¹¨ì§ˆ ê²ƒ ê°™êµ°."] },
        "ë„·ëŸ¬ë„ˆ": { 'Solo': ["ì•„ì´ìŠ¤ë¥¼ ëš«ëŠ” ê±´ ì‹ì€ ì£½ ë¨¹ê¸°ì§€.", "í˜„ì‹¤ë³´ë‹¤ ë„¤íŠ¸ì›Œí¬ê°€ í¸í•´.", "ë°ì´í„° íë¦„ì´ ì•„ë¦„ë‹¤ì›Œ."], 'Love': ["ë„¤ ë‡Œì™€ ë™ê¸°í™”í•˜ê³  ì‹¶ì–´.", "ë‚´ ë°©í™”ë²½ì„ í•´ì œí•  ìœ ì¼í•œ ì‚¬ëŒ.", "ë„Œ ë‚´ ìµœê³ ì˜ ì•Œê³ ë¦¬ì¦˜ì´ì•¼."], 'Affair': ["ë°±ë„ì–´ë¡œ ëª°ë˜ ì ‘ì†í–ˆì–´.", "ë¡œê·¸ëŠ” ì „ë¶€ ì‚­ì œí• ê²Œ.", "ë°”ì´ëŸ¬ìŠ¤ì²˜ëŸ¼ ì¹˜ëª…ì ì´ì•¼."], 'Stress': ["ë‡Œê°€ íƒ€ë²„ë¦´ ê²ƒ ê°™ì•„!", "ì—°ê²° ëŠì–´! ê°•ì œ ë¡œê·¸ì•„ì›ƒ!", "ë…¸ì´ì¦ˆ ë•Œë¬¸ì— ë¯¸ì¹˜ê² ì–´."] },
        "ë¼ë©˜ë…¸ì ìƒ": { 'Solo': ["ìœ¡ìˆ˜ ë“ëŠ” ëƒ„ìƒˆ, ëë‚´ì£¼ì§€?", "ë”°ëœ»í•œ êµ­ë¬¼ í•œ ê·¸ë¦‡ í•˜ê³  ê°€.", "ì˜¤ëŠ˜ë„ ì†ë‹˜ì´ ë§ë„¤."], 'Love': ["ë„ˆí•œí… ì°¨ìŠˆ ë¬´ì œí•œì´ì•¼.", "êµ­ë¬¼ë³´ë‹¤ ë„¤ ë§ˆìŒì´ ë” ë”°ëœ»í•´.", "í‰ìƒ ë¼ë©˜ ë§Œë“¤ì–´ì¤„ê²Œ."], 'Affair': ["ì…”í„° ë‚´ë¦¬ê³  ëª°ë˜ ë§Œë‚ ê¹Œ?", "ë§¤ìš´ë§›ë³´ë‹¤ ë” í™”ëˆí•˜ë„¤.", "ìœ¡ìˆ˜ ì‹ê¸° ì „ì— ë¹¨ë¦¬ ì™€."], 'Stress': ["ìœ¡ìˆ˜ ì—ì–´ë²„ë¦¬ê³  ì‹¶ë‹¤.", "ì†ë‹˜ë“¤ ë‹¤ ë‚˜ê°€ë¼ê³  í•´!", "ë©´ì´ ë‹¤ ë¶ˆì–´í„°ì¡Œì–´."] },
        "ì˜¨ì²œì£¼ì¸": { 'Solo': ["ë¬¼ ì˜¨ë„ê°€ ë”± ì¢‹ì•„.", "í”¼ë¡œê°€ ì‹¹ í’€ë¦´ ê±°ì•¼.", "ìœ í™© ëƒ„ìƒˆ, ìµìˆ™í•´ì§€ë©´ ì¢‹ì•„."], 'Love': ["ë„ˆë‘ í˜¼ìš•... ë†ë‹´ì´ì•¼.", "ë‚´ ë§ˆìŒë„ ì˜¨ì²œì²˜ëŸ¼ ëœ¨ê±°ì›Œ.", "ë„Œ ë‚´ ì˜¨ì²œì˜ ê½ƒì´ì•¼."], 'Affair': ["íƒˆì˜ì‹¤ ë’¤ìª½ì—ì„œ ë´.", "ìŠµê¸° ë•Œë¬¸ì— ì–¼êµ´ì´ ë¹¨ê°œì¡Œì–´.", "ìœ„í—˜í•œ ì˜¨ë„ê°€ ë˜ê³  ìˆì–´."], 'Stress': ["ë¬¼ ë‹¤ ë¹¼ë²„ë ¤!", "ì†ë‹˜ë“¤ ë„ˆë¬´ ì‹œë„ëŸ¬ì›Œ.", "ë¨¸ë¦¬ê°€ í•‘ ë„ë„¤."] },
        "LPë°” ì‚¬ì¥ë‹˜": { 'Solo': ["ì´ ê³¡ì€ 20ì„¸ê¸° ëª…ê³¡ì´ì§€.", "ì¬ì¦ˆê°€ íë¥´ëŠ” ë°¤ì´ì•¼.", "ìœ„ìŠ¤í‚¤ í•œ ì” ì¤„ê¹Œ?"], 'Love': ["ì´ ë…¸ë˜ëŠ” ë„ ìœ„í•œ ê±°ì•¼.", "ë„ˆì˜ ëª©ì†Œë¦¬ê°€ ìµœê³ ì˜ ìŒì•…ì´ì•¼.", "ìš°ë¦¬ ì‚¬ë‘ì„ ë ˆì½”ë“œì— ë‹´ê³  ì‹¶ì–´."], 'Affair': ["ê°€ê²Œ ë¬¸ ì ê·¸ê³  ì‹œì‘í• ê¹Œ?", "ë¹„ë°€ìŠ¤ëŸ¬ìš´ ë¦¬ë“¬ì„ íƒ€ë³´ì.", "ê¸ˆì§€ëœ ê³¡ì„ íŠ¸ëŠ” ê¸°ë¶„ì´ì•¼."], 'Stress': ["ìŒì•… êº¼! ì¡°ìš©íˆ í•´!", "ìˆ ë³‘ ë‹¤ ê¹¨ë²„ë¦¬ê³  ì‹¶êµ°.", "ì´ë”°ìœ„ ì‹¸êµ¬ë ¤ ìŒì•… ì•ˆ í‹€ì–´."] },
        "ë®¤ì§€ì…˜": { 'Solo': ["ìƒˆë¡œìš´ ì½”ë“œê°€ ë– ì˜¬ëì–´.", "ë‚´ ê¸°íƒ€ ì†”ë¡œ ì–´ë•Œ?", "ì´ ë„ì‹œëŠ” ë‚´ ë¬´ëŒ€ì•¼."], 'Love': ["ë„ ìœ„í•œ ì„¸ë ˆë‚˜ë°ë¥¼ ë§Œë“¤ì—ˆì–´.", "ë„¤ ì‹¬ì¥ ë°•ë™ì— í…œí¬ë¥¼ ë§ì¶œê²Œ.", "ë„Œ ë‚´ ì˜ê°ì˜ ì›ì²œì´ì•¼."], 'Affair': ["ë°±ìŠ¤í…Œì´ì§€ì—ì„œ ëª°ë˜ ë´.", "ì´ê±´ ì•µì½œ ì—†ëŠ” ê³µì—°ì´ì•¼.", "ìœ„í—˜í•œ ë½ì•¤ë¡¤ì´ì§€."], 'Stress': ["ê¸°íƒ€ ì¤„ ë‹¤ ëŠì–´ë²„ë ¸ì–´.", "ì•…ìƒì´ ì•ˆ ë– ì˜¬ë¼!", "ë‹¤ë“¤ ë‚´ ìŒì•…ì„ ëª¨ìš•í•´."] },
        "ê³ ì–‘ì´": { 'Solo': ["ì•¼ì˜¹. (ë°¥ ì¤˜.)", "ê³ ë¡±ê³ ë¡±... (ë§Œì¡±)", "ì‹ë¹µ êµ½ëŠ” ì¤‘ì´ì•¼.", "ë†’ì€ ê³³ì´ ì¢‹ì•„.", "ë°•ìŠ¤ë‹¤! ë‚´ ê±°ì•¼."], 'Love': ["ì•¼ì•„ì˜¹~ (ë„ˆí•œí…Œ ë¶€ë¹„ì )", "ê³¨ê³¨ì†¡ ë¶€ë¥´ëŠ” ì¤‘ì´ì•¼.", "ë„ˆ ë°° ìœ„ê°€ ì œì¼ ë”°ëœ»í•´.", "ê¾¹ê¾¹ì´ í•´ì¤„ê²Œ."], 'Affair': ["ìº¬ì˜¹! (ë‹¤ë¥¸ ì§‘ì‚¬ ëƒ„ìƒˆê°€ ë‚˜!)", "ì‚´ê¸ˆì‚´ê¸ˆ ë°¤ë§ˆì‹¤ ë‹¤ë…€ì˜¬ê²Œ.", "ëª°ë˜ ì¸„ë¥´ í›”ì³ë¨¹ì—ˆì–´.", "ë¹„ë°€ ì¹œêµ¬ê°€ ìƒê²¼ë‹¤ì˜¹."], 'Stress': ["í•˜ì•…!! (ê±´ë“¤ì§€ ë§ˆ!)", "ìº¬ì•„ì•„ì•…! (ì €ë¦¬ ê°€!)", "ê¼¬ë¦¬ í‘! í„¸ ì­ˆë¼›!", "ë°œí†±ìœ¼ë¡œ ë‹¤ ê¸ì–´ë²„ë¦´ ê±°ì•¼!"] },
        "VIP": { 'Solo': ["ì–¼ë§ˆë©´ ë¼? ë‹¤ ì‚¬ì£¼ì§€.", "ì—¬ê¸°ê°€ íœíŠ¸í•˜ìš°ìŠ¤ì¸ê°€?", "ìƒ´í˜ì¸ ê°€ì ¸ì™€.", "ê²½ì¹˜ê°€ ì œë²•ì´êµ°."], 'Love': ["ì´ ë„ì‹œë¥¼ ë„ˆì—ê²Œ ì¤„ê²Œ.", "ë‹¤ì´ì•„ëª¬ë“œë³´ë‹¤ ë„¤ê°€ ë¹›ë‚˜.", "ë‚´ ì¬ì‚°ëª©ë¡ 1í˜¸ëŠ” ë„ˆì•¼."], 'Affair': ["ë¹„ë°€ ê³„ì•½ì„œì— ì‚¬ì¸í•´.", "í˜¸í…” ìŠ¤ìœ„íŠ¸ë£¸ ì¡ì•„ë†¨ì–´.", "ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ì—†ëŠ” ìŠ¤ë¦´ì´êµ°."], 'Stress': ["ë‹¤ í•´ê³ í•´! ë©ì²­ì´ë“¤!", "ë‚´ ì£¼ì‹ì´ í­ë½í–ˆì–´!", "ì„œë¹„ìŠ¤ê°€ ì—‰ë§ì´êµ°. ê³ ì†Œí•  ê±°ì•¼!"] }
    };

    const artifactsData = [
        { name: "êµ¬í˜• ì•„ì´í°", emoji: "ğŸ“±", desc: "2026ë…„ ì¸ë¥˜ê°€ ì—„ì§€ì†ê°€ë½ìœ¼ë¡œ ì„¸ìƒì„ ì§€ë°°í•˜ë˜ ë§ˆë²• ë„êµ¬." },
        { name: "ë¬´ì„  ì´ì–´í°", emoji: "ğŸ«›", desc: "ì½©ì²˜ëŸ¼ ìƒê²¼ìœ¼ë©°, ê³ ëŒ€ì¸ë“¤ì€ ì´ë¥¼ ê·€ì— ê½‚ê³  ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í–ˆë‹¤." },
        { name: "ì‹¤ë¬¼ ì¹´ë“œ", emoji: "ğŸ’³", desc: "í”Œë¼ìŠ¤í‹± ì¡°ê° í•˜ë‚˜ë¡œ ëª¨ë“  ê°€ì¹˜ë¥¼ êµí™˜í•˜ë˜ ì‹œëŒ€ì˜ ì‚°ë¬¼." },
        { name: "ì»µë¼ë©´ ìš©ê¸°", emoji: "ğŸœ", desc: "3ë¶„ ë§Œì— ì‹ ë“¤ì˜ ìŒì‹ì„ ì—°ì„±í•´ë‚´ë˜ ê³ ëŒ€ ì—°ê¸ˆìˆ  ìš©ê¸°." },
        { name: "ìœ ì„  ë§ˆìš°ìŠ¤", emoji: "ğŸ–±ï¸", desc: "ê¼¬ë¦¬ê°€ ë‹¬ë¦° ì¥ ëª¨ì–‘ì˜ ì¥ì¹˜. 2202ë…„ì—” ë‡ŒíŒŒê°€ ëŒ€ì‹ í•œë‹¤." },
        { name: "ì§€í ë­‰ì¹˜", emoji: "ğŸ’µ", desc: "ì¢…ì´ ìª¼ê°€ë¦¬ì— ê°€ì¹˜ë¥¼ ë¶€ì—¬í–ˆë˜ ì¸ë¥˜ì˜ ì§‘ë‹¨ ë¯¿ìŒì˜ ì¦ê±°." },
        { name: "ì¢…ì´ ì±…", emoji: "ğŸ“–", desc: "ë°ì´í„°ê°€ ì•„ë‹Œ ì‹¤ì œ ë‚˜ë¬´ë¥¼ ì–‡ê²Œ ì°ì–´ ì •ë³´ë¥¼ ê¸°ë¡í•˜ë˜ ë‚­ë§Œ." },
        { name: "ì•ˆê²½", emoji: "ğŸ‘“", desc: "ì‹œê° ë°ì´í„°ë¥¼ êµì •í•˜ê¸° ìœ„í•´ ì–¼êµ´ì— ê±¸ì¹˜ë˜ ë¬¼ë¦¬ì  ë³´ì • ì¥ì¹˜." },
        { name: "ì—´ì‡  ê¾¸ëŸ¬ë¯¸", emoji: "ğŸ”‘", desc: "ë¬¼ë¦¬ì ì¸ ë¬¸ì„ ì—´ê¸° ìœ„í•´ ë“¤ê³  ë‹¤ë‹ˆë˜ ì‡³ì¡°ê°ë“¤." },
        { name: "êµ¬í˜• ê²Œì„ê¸°", emoji: "ğŸ®", desc: "2026ë…„ ì‚¬ëŒë“¤ì´ ê°€ìƒ ì„¸ê³„ë¡œ ë„í”¼í•˜ë˜ ì‘ì€ ì°½êµ¬." },
        { name: "ë‚¡ì€ ì½¤íŒ©íŠ¸ ë””ìŠ¤í¬", emoji: "ğŸ’¿", desc: "2026ë…„ ìŒì•…ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ê¸°ë¡í•˜ë˜ ë°˜ì§ì´ëŠ” ì›íŒ." },
        { name: "ì•„ë‚ ë¡œê·¸ íƒìƒì‹œê³„", emoji: "â°", desc: "ë°”ëŠ˜ì´ ì›€ì§ì´ë©° ë¬¼ë¦¬ì ìœ¼ë¡œ ì‹œê°„ì„ ê°€ë¦¬í‚¤ë˜ ê¸°ê³„." },
        { name: "ìˆ˜ë™ ì„±ëƒ¥ê°‘", emoji: "ğŸ•¯ï¸", desc: "ë§ˆì°°ì„ í†µí•´ ë¶ˆê½ƒì„ ë§Œë“¤ì–´ë‚´ë˜ 2026ë…„ì˜ ì›ì‹œì  ë„êµ¬." },
        { name: "ì¼íšŒìš© í•„ë¦„ ì¹´ë©”ë¼", emoji: "ğŸ“¸", desc: "ê²°ê³¼ë¬¼ì„ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ì—†ì–´ì„œ ë” ì†Œì¤‘í–ˆë˜ ê¸°ë¡ê¸°." },
        { name: "USB ë©”ëª¨ë¦¬ ì¹©", emoji: "ğŸ’¾", desc: "ë°ì´í„°ë¥¼ ë¬¼ë¦¬ì  ì¡°ê°ì— ë‹´ì•„ ìš´ë°˜í•˜ë˜ ë²ˆê±°ë¡œìš´ ì‹œëŒ€ì˜ ì‚°ë¬¼." },
        { name: "ë…¸ë€ í¬ìŠ¤íŠ¸ì‡", emoji: "ğŸ“", desc: "ë””ì§€í„¸ ë©”ëª¨ ëŒ€ì‹  ì¢…ì´ì— ì ì–´ ë¶™ì—¬ë†“ë˜ ê³ ëŒ€ì¸ì˜ ê¸°ë¡ë²•." },
        { name: "ì² ì œ ìŠ¤í…Œì´í”ŒëŸ¬", emoji: "ğŸ–‡ï¸", desc: "ì¢…ì´ ë­‰ì¹˜ë¥¼ ë¬¼ë¦¬ì ìœ¼ë¡œ ê³ ì •í•˜ë˜ ì‘ê³  ê°•í•œ ì‚¬ë¬´ ë„êµ¬." },
        { name: "ëŒ€ë‚˜ë¬´ ë¶€ì±„", emoji: "ğŸª­", desc: "ì§ì ‘ íŒ”ì„ í”ë“¤ì–´ ë°”ëŒì„ ë§Œë“¤ë˜ 2026ë…„ì˜ ë‚­ë§Œì ì¸ ëƒ‰ë°© ì¥ì¹˜." },
        { name: "ê±´ì „ì§€ì‹ í”Œë˜ì‹œ", emoji: "ğŸ”¦", desc: "ì „ê¸° ì—ë„ˆì§€ë¥¼ ì§ì ‘ íœ´ëŒ€í•˜ë©° ì–´ë‘ ì„ ë°íˆë˜ ìœ ë¬¼." },
        { name: "500ì› ë™ì „", emoji: "ğŸª™", desc: "ê¸ˆì† ì¡°ê°ì— ê°€ì¹˜ë¥¼ ë‹´ì•„ ê±°ë˜í•˜ë˜ ì‹œëŒ€ì˜ ë§ˆì§€ë§‰ í™”í ì¤‘ í•˜ë‚˜." }
    ];

    const uniqueInfra = [
        {n: "ë‚¡ì€ ë„¤ì˜¨ì‚¬ì¸ ìˆ˜ë¦¬", h: false}, {n: "ê¸¸ê±°ë¦¬ ìíŒê¸° ì¶©ì „", h: false}, {n: "í•©ì„± ë¼ë©´ ê°€íŒëŒ€", h: false},
        {n: "ë¹ˆí‹°ì§€ ë ˆì½”ë“œ ìƒµ", h: false}, {n: "ì‹¬ì•¼ ê¼¬ì¹˜êµ¬ì´ ì§‘", h: false}, {n: "ì‹ ê²½ ë™ê¸°í™” ì•¡ì„¸ì„œë¦¬ ìƒµ", h: false},
        {n: "êµ¬ì—­ ë² ì´ì»¤ë¦¬ 'ìƒˆë²½'", h: false}, {n: "ì˜í˜¼ ê¸°ì–µ ë°±ì—… ì €ì¥ì†Œ", h: false}, {n: "ë„¤ì˜¨ íƒ€ì½”ì•¼í‚¤ ë…¸ì ", h: false},
        {n: "ê¸€ë¡œìš° ë‹¬ì½¤í•œ í‘¸ë”© ì¹´í˜", h: true}, {n: "ì¸ê³µ ë¹„ ì •í™” ì¥ì¹˜", h: false}, {n: "ëª½ê¸€ëª½ê¸€ ê·€ì²­ì†Œ ì„¼í„°", h: true},
        {n: "ë¬´ì¸ ì„¸íƒ ë¼ìš´ì§€", h: false}, {n: "ì‚¬ì´ë²„ì›¨ì–´ ì „ìš© ì•ˆë§ˆì†Œ", h: true}, {n: "í•©ì„± ë¬¼ë‹´ë°°(ì‹œìƒ¤) ë¼ìš´ì§€", h: true},
        {n: "ì†Œí˜• ì•ˆë“œë¡œì´ë“œ ìˆ˜ë¦¬ì†Œ", h: false}, {n: "ì‹¬ì•¼ í•©ì„± ì•½êµ­", h: false}, {n: "ë‚˜ë…¸ ë¬¸ì‹  íƒ€íˆ¬ ì•„í‹€ë¦¬ì—", h: false},
        {n: "í”¼ì–´ì‹± & í¬ë¡¬ ì»¤ìŠ¤í…€ ìƒµ", h: false}, {n: "ì‚¬ì´ë²„ ê·¼ìœ¡ ë¬¼ë¦¬ì¹˜ë£Œì‹¤", h: true}, {n: "ë„¤ì˜¨ ë¼ì´ë¸Œ í•˜ìš°ìŠ¤", h: false},
        {n: "ìŠ¤íŠ¸ë ˆìŠ¤ ë‡Œì²­ì†Œ ìƒµ", h: true}, {n: "ìœ ê¸°ë† ì•„ë¡œë§ˆ ì‚¬ìš°ë‚˜", h: true}, {n: "ìˆ˜ë©´ ìœ ë„ ASMR ë£¸", h: true},
        {n: "ë¯¸ë“œë‚˜ì‡ ë…ë¦½ ì‹œë„¤ë§ˆ", h: false}, {n: "ë„¤ì˜¨ ëŒ€ì¤‘ ëª©ìš•íƒ•", h: false}, {n: "24ì‹œ í¸ì˜ì  'ë„¤ì˜¨'", h: false},
        {n: "ë°ì´í„° ì¹© ì¤‘ê³  ì„œì ", h: false}, {n: "ë ˆíŠ¸ë¡œ ê²Œì„ ì˜¤ë½ì‹¤", h: false}, {n: "ì‚¬ì´ë²„ì›¨ì–´ ì •ë°€ ê²€ì§„ì†Œ", h: false},
        {n: "í•˜ëŠ˜ì„ ë‚˜ëŠ” ë°”ì´í¬ ê³„ë¥˜ì¥", h: false}, {n: "í™€ë¡œê·¸ë¨ ì•¡ì„¸ì„œë¦¬ ìƒµ", h: false}, {n: "ì‹¬ì•¼ ë§Œí™” ì¹´í˜", h: true},
        {n: "êµ¬ì—­ ì‘ì€ ë¯¸ìˆ ê´€", h: true}, {n: "ê³µì¤‘ ì •ì› í‹°ë£¸", h: true}, {n: "ë„¤ì˜¨ í•€ë³¼ ì„¼í„°", h: false},
        {n: "í•˜ëŠ˜ì„ ë‚˜ëŠ” ìë™ì°¨ ì „ìš© ì£¼ì°¨ì¥", h: false}, {n: "ë°ì´í„° ìŠ¬ë¡¯ ë…¸ë˜ë°©", h: false}, {n: "ê°€ìƒí˜„ì‹¤ í…Œë§ˆ ë£¸", h: true},
        {n: "ì‚¬ì´ë²„ í« ìš©í’ˆì ", h: true}, {n: "ì²œì—° í•©ì„± ì˜¨ì²œ (Premium)", h: true}, {n: "í¬ë¡¬ ì‹œë¯¼ ì „ìš© íœ´ì‹ì²˜ 'ìƒì¸„ì–´ë¦¬'", h: true},
        {n: "ë„¤ì˜¨ í”¼íŠ¸ë‹ˆìŠ¤ í´ëŸ½", h: false}, {n: "ìˆ˜ì¤‘ ë§ˆì‚¬ì§€ í’€", h: true}, {n: "í”¼ë¶€ ì¬ìƒ ì—ìŠ¤í…Œí‹±", h: true},
        {n: "ë°”ì´ì˜¤ ì‚°ì†Œ ìº¡ìŠ", h: true}, {n: "í–¥ì´ˆ & ë””í“¨ì € ì „ë¬¸ì ", h: true}, {n: "ê¸°ì–µ ì¡°ê° í™€ë¡œê·¸ë¨ ìƒµ", h: true},
        {n: "ëª…ìƒ & ìš”ê°€ ì„¼í„°", h: true}, {n: "ìˆ˜ë©´ ë³´ì¡°ì œ ì•½ë°©", h: true}, {n: "ì§€í•˜ ìƒê°€ ë¼ë©˜ íˆ¬ì–´", h: false},
        {n: "ë¸”ë£¨ ì˜¤ì…˜ ë¦¬ì¡°íŠ¸", h: true}, {n: "ì‚¬ì´ë²„ ë§Œë‘ ì¥ì¸", h: false}, {n: "ì‹¬ì•¼ ë”¤ì„¬ ì „ë¬¸ê´€", h: false},
        {n: "ì¸ê³µ ê³ ê¸° ë²„ê±° í•˜ìš°ìŠ¤", h: false}, {n: "ì½”í‹°ì§€ ë¡œì»¬ ë§¤ê±°ì§„ ì§€ë¶€", h: false}, {n: "ì½”ì¸ ëŸ°ë”ë¦¬ & ë¶ì¹´í˜", h: true},
        {n: "ê³¨ëª©ê¸¸ ë¹ˆí‹°ì§€ ì˜·ê°€ê²Œ", h: false}, {n: "ë„¤ì˜¨ ì‹ ë°œ í¸ì§‘ìƒµ", h: false}, {n: "ì‚¬ì´ë²„ ê½ƒ ì •ì›", h: true},
        {n: "ì§€ëŠ¥í˜• ë°©ë²” ë“œë¡  í—ˆë¸Œ", h: false}, {n: "í¼ìŠ¤ë„ ì»¬ëŸ¬ ì§„ë‹¨ì‹¤", h: false}, {n: "ë„¤ì˜¨ ë„¤ì¼ ì•„íŠ¸ ì•„ëœ°ë¦¬ì—", h: true},
        {n: "ì‚¬ì´ë²„ ë©”ì´í¬ì—… ì„¼í„°", h: true}, {n: "ì˜í˜¼ ê¸°ì–µ í´ë¼ìš°ë“œ ì„¼í„°", h: false}, {n: "ì¤‘ê³  í˜¸ë²„ ë°”ì´í¬ ìƒµ", h: false},
        {n: "ììœ¨ ì£¼í–‰ íƒì‹œ ìŠ¹ê°•ì¥", h: false}, {n: "êµ¬ì—­ ê³µìœ  ì£¼ì°¨ íƒ€ì›Œ", h: false}, {n: "ë¹„í–‰ì„  íˆ¬ì–´ ì˜ˆì•½ì²˜", h: false},
        {n: "ë„ì‹œ í†µí•© í™˜ìŠ¹ ì„¼í„°", h: false}, {n: "5ì„±ê¸‰ í”„ë¦¬ë¯¸ì—„ í…Œí¬ í˜¸í…”", h: true}, {n: "ë¹›ë°”ëœ ì„¼íŠ¸ëŸ´ ì—ë¹„ë‰´ í”Œë¼ì", h: true},
        {n: "ì—ë„ˆì§€ íšŒìˆ˜ ë°œì „ ë‹¨ì§€", h: false}, {n: "ìˆ˜ê²½ ì¬ë°° ë„¤ì˜¨ ì˜¨ì‹¤", h: true}, {n: "ì§€ì¤‘ì—´ ë‚œë°© ì‹œìŠ¤í…œ", h: false},
        {n: "ë°”ì´ì˜¤ ë‚˜ë…¸ ì¬ìƒ ì„¼í„°", h: true}, {n: "ëŒ€ê·œëª¨ ë„¤ì˜¨ ì‡¼í•‘ëª°", h: false}, {n: "ë©”ê°€ ì½”í¼ë ˆì´ì…˜ ì»´í¼ë‹ˆ", h: false},
        {n: "ë„ì‹œ í˜ˆê´€ ë¬¼ë¥˜ë§", h: false}, {n: "ê³ ê³ ë„ ë“œë¡  ë³´ê¸‰ë¡œ", h: false}, {n: "ë°”ì´ì˜¤ ì—ë„ˆì§€ ì‹ë¬¼ì›", h: true},
        {n: "ì½”í‹°ì§€ ë§ˆì¸ë“œ ê´€ì œ ì„¼í„°", h: false}, {n: "í•˜ì´í¼ë£¨í”„ ì„¼í„°", h: false}, {n: "ìš°ì£¼ í•­ê³µ ì„¼í„°", h: false},
        {n: "ì½”í‹°ì§€ íƒ€ì›Œ ê±´ì„¤", h: false}, {n: "ì€í•˜ìˆ˜ ê´€ì¸¡ íƒ€ì›Œ", h: false}, {n: "ì‹¬ì•¼ ìœ„ì„± ì£¼íŒŒìˆ˜ ì „ì†¡êµ­", h: false},
        {n: "í™˜ê²½ íšŒë³µ ê°€ì† ì„¼í„°", h: true}, {n: "ê¸°ì–µ ë³´ê´€ ì€í–‰", h: false}, {n: "ì¸ê°„-ê¸°ê³„ í˜‘ë ¥ ì„¼í„°", h: false},
        {n: "í…Œë¼í¬ë° ì‹œë®¬ë ˆì´ì…˜ ë©", h: true}, {n: "ì˜¤ë©”ê°€ ì¸í”„ë¼ ë§", h: false}, {n: "ì•ŒíŒŒ ì‹œí‹° ì—°ì‚° ì„¼í„°", h: false},
        {n: "ì‹ ì„¸ê³„ ê´€ë¬¸", h: false}, {n: "2026ë…„ì‹ ì•„ë‚ ë¡œê·¸ í–‡ì‚´ ì°½ë¬¸", h: true}, {n: "ë‚¡ì€ ê³µìš© ì‚°ì†Œ ì¶©ì „ì†Œ", h: true},
        {n: "ì‹¬ì•¼ì˜ íŒ…ê¸€ ASMR í—¤ì–´ìƒµ", h: true}, {n: "ì—°ê·¹ì´ ëë‚œ í›„ì˜ ì†Œê·¹ì¥", h: true}, {n: "ì €ê¶¤ë„ ë³„ë˜¥ë³„ ìœ ë„ ì¥ì¹˜", h: false},
        {n: "ë¯¸ë“œë‚˜ì‡ ìœ í† í”¼ì•„", h: true}
    ];

    const rankNames = ["ì†Œë°•í•˜ê³  ì•„ëŠ‘í•œ ì‚¬ì´ë²„í‘í¬ ë°©", "ë„¤ì˜¨ ì•„í‹€ë¦¬ì—", "ì‘ê°€ì™€ êµìˆ˜ì˜ ì„œì¬", "ë¦¬í¼ë‹¥ì˜ ì •ë¹„ì†Œ", "ë¼ë””ì˜¤ ìŠ¤íŠœë””ì˜¤", "í¬í†  ê·¸ë˜í¼ì˜ ì•”ì‹¤", "í•©ì„± ë¼ë©´ ê°€íŒëŒ€", "ë¹„ ë‚´ë¦¬ëŠ” í…Œë¼ìŠ¤", "ë¹ˆí‹°ì§€ ë ˆì½”ë“œ ìƒµ", "ì§€ë¶• ìœ„ ì •ì›", "ì‚¬ìš°ë‚˜", "í¬ë¡¬ ì˜¨ì²œì‹¤", "LPë°”", "íœíŠ¸í•˜ìš°ìŠ¤ì˜ ë§Œì°¬", "ëª°ì†Œí”„íŠ¸ ë ˆìŠ¤í† ë‘", "ë””ìŠ¤íŠ¸ë¦­íŠ¸ ì¿¼í„°", "ë°ì´í„° í•˜ì´ì›¨ì´", "ê°¤ëŸ­ì‹œ ì‹œí‹°", "ê³¨ë“  ì„ ì…‹ ì‹œí‹°", "ìœ í† í”¼ì•„ ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€"];
    const rankImages = ["https://i.imgur.com/MuFQQ5A.png", "https://i.imgur.com/1nAnNIb.png", "https://i.imgur.com/eqwGBhl.png", "https://i.imgur.com/br0HdSG.png", "https://i.imgur.com/2Sz2iYA.png", "https://i.imgur.com/3qXyDTr.png", "https://i.imgur.com/J5mjTBn.png", "https://i.imgur.com/aI6UVY2.png", "https://i.imgur.com/QMSpzfL.png", "https://i.imgur.com/PwZ6vm3.png", "https://i.imgur.com/S4yBFXT.png", "https://i.imgur.com/A0HQ7e3.png", "https://i.imgur.com/qeB68bj.png", "https://i.imgur.com/RoQeLG8.png", "https://i.imgur.com/vuNzL4d.png", "https://i.imgur.com/P1SjHGR.png", "https://i.imgur.com/tApbEin.png", "https://i.imgur.com/ylCZJyn.png", "https://i.imgur.com/vA1hKCT.png", "https://i.imgur.com/ecGrFrH.png"];

    const upgrades = uniqueInfra.map((item, i) => ({
        id: `up${i}`, name: item.n,
        basePrice: Math.floor(15 * Math.pow(1.4, i)), 
        power: Math.floor(1 * Math.pow(1.2, i)), 
        type: i % 2 === 0 ? 'auto' : 'click', isHealing: item.h
    }));

    const achievements = [
        { id: 'cat', name: 'ëƒ¥ì´ ì›”ë“œ', icon: 'ğŸ±', desc: 'ëª¨ë“  ì£¼ë¯¼ì´ ê³ ì–‘ì´ì…ë‹ˆë‹¤.', unlocked: false, check: s => s.residents.length > 2 && s.residents.every(r => r.job === 'ê³ ì–‘ì´') },
        { id: 'drama', name: 'ì‚¬ë‘ê³¼ ì „ìŸ', icon: 'ğŸ’”', desc: 'ë¶ˆë¥œ ê´€ê³„ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', unlocked: false, check: s => s.residents.some(r => r.relType === 'ë¶ˆë¥œ') },
        { id: 'rich', name: 'ë°±ë§Œì¥ì', icon: 'ğŸ’°', desc: 'ì†Œì§€ê¸ˆ 1,000,000 ëŒíŒŒ.', unlocked: false, check: s => s.money >= 1000000 },
        { id: 'solo', name: 'ì†”ë¡œ ì²œêµ­', icon: 'ğŸ§˜', desc: '5ëª… ëª¨ë‘ ì†”ë¡œì…ë‹ˆë‹¤.', unlocked: false, check: s => s.residents.length === 5 && s.residents.every(r => r.relType === 'ì†”ë¡œ') },
        { id: 'stress', name: 'ë²ˆì•„ì›ƒ', icon: 'ğŸ”¥', desc: 'ì£¼ë¯¼ í‰ê·  ìŠ¤íŠ¸ë ˆìŠ¤ 90% ì´ìƒ.', unlocked: false, check: s => s.residents.length > 0 && (s.residents.reduce((a,b)=>a+b.stress,0)/s.residents.length) > 90 },
        { id: 'collector', name: 'ì—­ì‚¬í•™ì', icon: 'ğŸ“œ', desc: 'ëª¨ë“  ìœ ë¬¼(20ì¢…) ìˆ˜ì§‘ ì™„ë£Œ.', unlocked: false, check: s => s.artifacts.every(a => a === true) }
    ];

    function getJosa(word, type) {
        if (!word) return '';
        const lastChar = word.charCodeAt(word.length - 1);
        const hasBatchim = (lastChar - 0xAC00) % 28 > 0;
        if (type === 'ì´ê°€') return hasBatchim ? 'ì´' : 'ê°€';
        if (type === 'ì„ë¥¼') return hasBatchim ? 'ì„' : 'ë¥¼';
        if (type === 'ì™€ê³¼') return hasBatchim ? 'ê³¼' : 'ì™€';
        if (type === 'ì€ëŠ”') return hasBatchim ? 'ì€' : 'ëŠ”';
        return '';
    }

    let setupIndex = 0;
    const tempResidents = []; 
    let snsPosts = [];

    window.onload = function() {
        init();
    };

    // [ìˆ˜ì •] 1. ì €ì¥ ê¸°ëŠ¥ (ë¡œì»¬ + í´ë¼ìš°ë“œ ë™ì‹œì— ì²˜ë¦¬)
    function saveGame() {
        // A. ë¸Œë¼ìš°ì € ìºì‹œ(ë¡œì»¬) ì €ì¥ - ë¡œê·¸ì¸ ì•ˆ í•´ë„ ì‘ë™í•¨
        try {
            localStorage.setItem('midnight_cottage_v30_hardcore', JSON.stringify(state));
        } catch (e) {
            console.error("ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨", e);
        }

        // B. í´ë¼ìš°ë“œ ì €ì¥ - ë¡œê·¸ì¸í–ˆì„ ë•Œë§Œ ì‘ë™í•¨
        if (currentUser) {
            db.collection("users").doc(currentUser.uid).set(state, { merge: true })
                .catch((error) => console.error("í´ë¼ìš°ë“œ ìë™ ì €ì¥ ì‹¤íŒ¨:", error));
        }
    }

    // [ìˆ˜ì •] 2. ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ (ì‹œì‘í•  ë•Œ ìë™ ì‹¤í–‰ë¨)
    function loadGame() {
        const saved = localStorage.getItem('midnight_cottage_v30_hardcore');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                Object.assign(state, parsed);
                return true; 
            } catch (e) {
                console.error("ì„¸ì´ë¸Œ íŒŒì¼ ì˜¤ë¥˜", e);
                return false;
            }
        }
        return false; 
    }

    // [ìˆ˜ì •] 3. ê²Œì„ ì´ˆê¸°í™”
    function init() {
        state.upgrades = upgrades.map(u => ({ id: u.id, lv: 0, price: u.basePrice }));

        // ë¡œì»¬ ë°ì´í„°ë¥¼ ë¨¼ì € ì°¾ì•„ë³´ê³ , ìˆìœ¼ë©´ ë°”ë¡œ ê²Œì„ ì‹œì‘!
        if (loadGame()) {
            console.log("ğŸ“‚ ë¸Œë¼ìš°ì € ìë™ ì €ì¥ ë°ì´í„° ë¡œë“œë¨");
            document.getElementById('start-screen').style.display = 'none';
            startGame();
            addHistory("ğŸ’» <b>ì‹œìŠ¤í…œ:</b> ì§€ë‚œë²ˆ ì‘ì—…ì„ ì´ì–´ì„œ ì‹œì‘í•©ë‹ˆë‹¤.");
        } else {
            loadSetupUI(0);
        }
    }

    function loadSetupUI(idx) {
        setupIndex = idx;
        const countDisplay = document.getElementById('char-count');
        const nextBtn = document.getElementById('btn-next');
        const prevBtn = document.getElementById('btn-prev');
        const finishBtn = document.getElementById('btn-finish');
        const nameInput = document.getElementById('input-name');

        countDisplay.innerText = `${idx + 1} / 5`;
        
        const currentData = tempResidents[idx] || {};
        nameInput.value = currentData.name || '';
        document.getElementById('input-gender').value = currentData.gender || 'ë‚¨';
        document.getElementById('input-job').value = currentData.job || 'í™”ê°€'; 

        prevBtn.style.display = idx === 0 ? 'none' : 'block';
        finishBtn.style.display = tempResidents.length > 0 || idx > 0 ? 'block' : 'none';

        if (idx === 4) {
            nextBtn.style.display = 'none'; 
            finishBtn.style.width = "100%"; 
        } else {
            nextBtn.style.display = 'block';
            nextBtn.innerText = `ì¶”ê°€ (${idx + 1}/5)`;
            nextBtn.style.background = "#bb9af7";
        }
    }

    function saveCurrentInput() {
        const job = document.getElementById('input-job').value;
        const selectedDialogues = jobsData[job]; 
        const selectedEmoji = jobEmojis[job] || 'ğŸ‘¤';

        tempResidents[setupIndex] = {
            id: setupIndex,
            name: document.getElementById('input-name').value || `ì£¼ë¯¼${setupIndex+1}`,
            emoji: selectedEmoji, 
            gender: document.getElementById('input-gender').value,
            job: job,
            stress: 0, 
            affection: 50, 
            partnerId: null, 
            relType: 'ì†”ë¡œ',
            dialogues: selectedDialogues
        };
    }

    function nextChar() {
        saveCurrentInput();
        if (setupIndex < 4) loadSetupUI(setupIndex + 1);
    }

    function prevChar() {
        if (setupIndex > 0) loadSetupUI(setupIndex - 1);
    }

    // [ìˆ˜ì •] 4. ì…ì£¼ ì‹œì‘ (ê°€ì¥ ì¤‘ìš”!)
    function finishSetup() {
        saveCurrentInput(); 
        state.residents = [...tempResidents]; 
        document.getElementById('start-screen').style.display = 'none';
        
        // ê²Œì„ ì‹œì‘
        startGame();

        // ğŸ”¥ ì…ì£¼í•˜ìë§ˆì ì¦‰ì‹œ ê°•ì œ ì €ì¥!
        saveGame(); 
        console.log("âœ… ì…ì£¼ ì™„ë£Œ ë° ì¦‰ì‹œ ì €ì¥ë¨");
    }

    function startGame() {
        changeNews();
        setInterval(changeNews, 300000);
        render(); updateUI(); renderAchievements();
        
        setInterval(() => { 
            let boost = 1 + (state.artifacts.filter(x=>x).length * 0.1);
            let income = state.autoIncome * boost;
            if (state.residents.length > 0) {
                let avgStress = state.residents.reduce((a,b)=>a+b.stress, 0) / state.residents.length;
                if (avgStress > 80) income *= 0.5;
            }

            state.money += income / 10; 
            state.residents.forEach(r => r.stress = Math.min(100, r.stress + 0.007));
            updateUI(); 
            checkAchievements();
        }, 100);
        setInterval(randomDailyEvent, 25000);
        setInterval(generateSNSPost, 60000); 

        // ğŸ’¾ 4ì´ˆë§ˆë‹¤ ìë™ ì €ì¥ ì‹¤í–‰
        setInterval(saveGame, 4000);

        if (window.innerWidth <= 768) {
            spawnMessage('ğŸ’»ì‘ì—… í™”ì´íŒ…! ë¯¸ë“œë‚˜ì‡ ì½”í‹°ì§€ê°€ ë„ˆë¥¼ ë°˜ê²¨.', 'event');
        }
    }

    function toggleModal(id) { 
        const m = document.getElementById(id); 
        if (m) {
            m.style.display = (m.style.display==='flex')?'none':'flex';
            if(id === 'sns-modal' && m.style.display === 'flex') {
                 document.getElementById('sns-dot').style.display = 'none'; 
            }
            if(id === 'shop-modal' && m.style.display === 'flex') {
                updateGachaUI();
            }
        }
    }

    const endingDialogues = {
        "í™”ê°€": "ì´ ë°©ì˜ ìƒ‰ì±„ëŠ” ë‚´ ìº”ë²„ìŠ¤ë³´ë‹¤ ì•„ë¦„ë‹¤ì› ì–´. ì˜ì›íˆ ê¸°ì–µí• ê²Œ.",
        "ì†Œì„¤ê°€": "ìš°ë¦¬ì˜ ì±•í„°ëŠ” ì—¬ê¸°ì„œ ëë‚˜ì§€ë§Œ, ë„¤ ì´ì•¼ê¸°ëŠ” ê³„ì† ì¨ ë‚´ë ¤ê°€ê¸¸.",
        "êµìˆ˜": "ì´ê³³ì˜ ê¸°ë¡ì€ ì—­ì‚¬ì— ë‚¨ì„ ê±¸ì„¸. ìë„¤ ë•ë¶„ì´ì•¼.",
        "ë¦¬í¼ë‹¥": "ë‚´ ì‹¬ì¥ ì—”ì§„ë„ ë²…ì°¨ì˜¤ë¥´ëŠ”êµ°. ì™„ë²½í•œ ìˆ˜ë¦¬ì˜€ì–´.",
        "ASMR DJ": "ì˜¤ëŠ˜ ë°¤ì€ ê°€ì¥ í‰ì˜¨í•œ ë¹—ì†Œë¦¬ë¥¼ ë“¤ë ¤ì¤„ê²Œ. ì˜ ì.",
        "ëª¨ë¸": "í™”ë ¤í•œ ì¡°ëª…ë³´ë‹¤ ì´ ë°©ì˜ ì€ì€í•œ ë„¤ì˜¨ì´ ë” ì¢‹ì•˜ì–´.",
        "í˜•ì‚¬": "ì‚¬ê±´ ì¢…ë£Œ. ë²”ì¸ì€... ìš°ë¦¬ê°€ ì°¾ë˜ í–‰ë³µì´ì—ˆêµ°.",
        "ë„·ëŸ¬ë„ˆ": "ë¡œê·¸ì•„ì›ƒí•˜ê³  ì‹¶ì§€ ì•Šì€ ì„œë²„ëŠ” ì—¬ê¸°ê°€ ì²˜ìŒì´ì•¼.",
        "ë¼ë©˜ë…¸ì ìƒ": "ì–¸ì œë“  ì™€. ë”°ëœ»í•œ êµ­ë¬¼ í•œ ê·¸ë¦‡ì€ í‰ìƒ ê³µì§œë‹ˆê¹Œ.",
        "ì˜¨ì²œì£¼ì¸": "ë§ˆìŒì˜ ë•Œê¹Œì§€ ì”»ê²¨ë‚˜ê°€ëŠ” ê¸°ë¶„ì´ì—ˆì–´. ê³ ë§ˆì›Œ.",
        "LPë°” ì‚¬ì¥ë‹˜": "ë§ˆì§€ë§‰ ê³¡ì€ ë„ˆë¥¼ ìœ„í•´ í‹€ê²Œ. ì´ ë¦¬ë“¬ì„ ìŠì§€ ë§ˆ.",
        "ë®¤ì§€ì…˜": "ë‚´ ìµœê³ ì˜ ëª…ê³¡ì€ ì´ ì½”í‹°ì§€ì—ì„œ íƒ„ìƒí–ˆì–´. ë•¡í!",
        "ê³ ì–‘ì´": "ì•¼ì˜¹. (ì˜ ìˆì–´ë¼, ìµœê³ ì˜ ì§‘ì‚¬. ì¸„ë¥´ ìŠì§€ ë§ê³ .)",
        "VIP": "ì´ ì •ë„ ê°€ì¹˜ ìˆëŠ” íˆ¬ìëŠ” ì²˜ìŒì´êµ°. í›Œë¥­í–ˆì–´."
    };

    function startEndingSequence() {
        const screen = document.getElementById('ending-sequence');
        const container = document.querySelector('.rolling-container');
        const emojiDiv = document.getElementById('end-emoji');
        const nameDiv = document.getElementById('end-name');
        const msgDiv = document.getElementById('end-msg');
        const finalScreen = document.getElementById('final-screen');

        screen.style.display = 'flex';
        let step = 0;
        
        function showNextResident() {
            if (step >= state.residents.length) {
                container.style.display = 'none';
                finalScreen.style.display = 'block';
                finalScreen.style.animation = 'fade-in 2s forwards';
                return;
            }
            const char = state.residents[step];
            const msg = endingDialogues[char.job] || "í•¨ê»˜í•´ì„œ ì¦ê±°ì› ì–´. í–‰ë³µí•´ì•¼ í•´!";
            emojiDiv.innerText = char.emoji;
            nameDiv.innerText = `${char.job} ${char.name}`;
            msgDiv.innerText = `"${msg}"`;
            container.classList.add('show');
            setTimeout(() => {
                container.classList.remove('show');
                setTimeout(() => {
                    step++;
                    showNextResident();
                }, 1000); 
            }, 4000); 
        }
        showNextResident();
    }

    function closeEndingSequence() {
        document.getElementById('ending-sequence').style.display = 'none';
    }

    function getGachaPrice() {
        const foundCount = state.artifacts.filter(x => x).length;
        return 10000 * Math.pow(2, foundCount);
    }

    function updateGachaUI() {
        const price = getGachaPrice();
        const btn = document.getElementById('btn-gacha');
        const priceText = document.getElementById('gacha-price');
        priceText.innerText = `ğŸ’µ ${price.toLocaleString()}`;
        if(state.artifacts.every(x => x)) {
            btn.disabled = true;
            btn.innerHTML = "ëª¨ë“  ìœ ë¬¼ ìˆ˜ì§‘ ì™„ë£Œ!";
        } else if(state.money < price) {
            btn.disabled = true;
        } else {
            btn.disabled = false;
        }
    }

    function buyArtifact() {
        const price = getGachaPrice();
        if(state.money >= price) {
            state.money -= price;
            const unfound = state.artifacts.map((v, i) => v === false ? i : null).filter(v => v !== null);
            if (unfound.length > 0) {
                const pick = unfound[Math.floor(Math.random()*unfound.length)];
                state.artifacts[pick] = true; 
                renderMuseum();
                showCenterPopup(artifactsData[pick].emoji, 'ìœ ë¬¼ ë³µì› ì„±ê³µ!', artifactsData[pick].name);
                addHistory(`ğŸº <b>ìœ ë¬¼ ë³µì›:</b> [${artifactsData[pick].name}] ë³µì› ì™„ë£Œ! (ìˆ˜ìµ +10%)`);
            }
            updateUI();
            updateGachaUI();
            saveGame();
        }
    }

    function generateSNSPost() {
        if (state.residents.length === 0) return;
        const char = state.residents[Math.floor(Math.random() * state.residents.length)];
        let text = "";
        const generalPosts = ["ì˜¤ëŠ˜ íŒŒí‹°í•  ì‚¬ëŒ?", "ì§‘ì´ ìµœê³ ì•¼.", "ì´ ê±°ë¦¬ í™í•˜ë„¤.", "ë°°í„°ë¦¬ ì¶©ì „ ì¤‘...", "ì±… ì½ê¸° ì¢‹ì€ ë°¤.", "ì‹¬ì‹¬í•´ ë†€ì•„ì¤˜!", "í¸ì˜ì  ë„ì‹œë½ ì§€ê²¨ì›Œ.", "ëˆ„ê°€ ë‚´ ìì „ê±° í›”ì³ê°”ì–´?", "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ì´ì§€.", "ë„¤ì˜¨ì‚¬ì¸ì´ ì˜¤ëŠ˜ë”°ë¼ ì˜ˆì˜ë„¤.", "ê³ ì–‘ì´ ê·€ì—¬ì›Œ.", "ì¸ìƒ...", "ì›”ê¸‰ ì–¸ì œ ë“¤ì–´ì˜¤ì§€?", "ì•¼ì‹ ì¶”ì²œ ì¢€.", "ìƒˆë¡œ ìƒê¸´ ê°€ê²Œ ê°€ë³¼ ì‚¬ëŒ?", "ì˜¤ëŠ˜ ë‚ ì”¨ ë¯¸ì³¤ë‹¤.", "ì¶œê·¼í•˜ê¸° ì‹«ë‹¤.", "í‡´ê·¼í•˜ê³  ë§¥ì£¼ í•œì”?", "ì£¼ë§ ìˆœì‚­...", "ë„·í”Œë¦­ìŠ¤ ë³¼ ê±° ì¶”ì²œ ì¢€.", "ë‹¤ì´ì–´íŠ¸ëŠ” ë‚´ì¼ë¶€í„°.", "ì˜¤ëŠ˜ ì˜¤ì˜¤í‹°ë””.", "ë§›ì§‘ ë°œê²¬!", "ì»¤í”¼ ìˆ˜í˜ˆ ì‹œê¸‰.", "ì ì´ ì•ˆ ì™€.", "ìƒˆë²½ ê°ì„± í„°ì§€ë„¤.", "ì˜›ë‚  ë…¸ë˜ ë“£ëŠ” ì¤‘.", "ì—¬í–‰ ê°€ê³  ì‹¶ë‹¤.", "ë°© ì²­ì†Œ í•´ì•¼ í•˜ëŠ”ë°...", "ì´ë¶ˆ ë°–ì€ ìœ„í—˜í•´.", "ì˜¤ëŠ˜ ê¸°ë¶„ ë§‘ìŒ.", "ìŠ¤íŠ¸ë ˆìŠ¤ì—” ë§¤ìš´ ê±°.", "ì†Œí™•í–‰.", "ë© ë•Œë¦¬ëŠ” ì¤‘.", "ë°°ê³ íŒŒ.", "ì§€êµ¬ ë©¸ë§í–ˆìœ¼ë©´.", "ë¡œë˜ ë‹¹ì²¨ ê¸°ì›.", "ì‚°ì±… ê°ˆê¹Œ?", "íƒë°° ì™”ë‹¤!", "ë°€ë¦° ë¹¨ë˜ í•´ì•¼ì§€."];
        if (char.job === 'ê³ ì–‘ì´') { text = ["ëƒ¥.", "ê³¨ê³¨ê³¨...", "ì¸„ë¥´ ë‚´ë†”ë¼ ë‹ê².", "ìš°ë‹¤ë‹¤ë‹¤ë‹¤ë‹¤!!", "ê·¸ë¥´ë¦‰...", "ë°•ìŠ¤ ë‚´êº¼.", "ë†’ì€ ê³³ì´ ì¢‹ì•„.", "ë‚®ì  ì‹œê°„ì´ë‹¤ëƒ¥.", "ì§‘ì‚¬ì•¼ ë†€ì•„ì¤˜."][Math.floor(Math.random()*9)]; } 
        else if (char.relType === 'ë¶ˆë¥œ') { text = ["ë¹„ë°€ ê³„ì •ì…ë‹ˆë‹¤.", "ì˜¤ëŠ˜ ë°¤ë„...", "ì‰¿.", "ì•„ë¬´ë„ ëª¨ë¥´ê²Œ.", "ì‹¬ì¥ì´ ë›´ë‹¤.", "ìœ„í—˜í•œë° ë©ˆì¶œ ìˆ˜ ì—†ì–´.", "ì´ëŸ¬ë©´ ì•ˆ ë˜ëŠ”ë°...", "ë³´ê³  ì‹¶ì–´."][Math.floor(Math.random()*8)]; } 
        else if (char.stress > 80) { text = ["ì•„ ì§„ì§œ ë‹¤ ì§œì¦ ë‚˜ë„¤.", "ê±´ë“¤ì§€ ë§ˆë¼.", "í‡´ì‚¬ ë§ˆë µë‹¤.", "ì„¸ìƒì´ ë§í–ˆìœ¼ë©´.", "ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ì–´.", "ë¨¸ë¦¬ ì•„íŒŒ.", "ë‹¤ ë•Œë ¤ì¹˜ìš°ê³  ì‹¶ë‹¤.", "í­ë°œ ì§ì „."][Math.floor(Math.random()*8)]; } 
        else { text = generalPosts[Math.floor(Math.random() * generalPosts.length)]; }
        const post = { emoji: char.emoji, name: char.name, time: new Date().toLocaleTimeString().slice(0, 5), text: text };
        snsPosts.unshift(post);
        if (snsPosts.length > 20) snsPosts.pop();
        renderSNS();
        document.getElementById('sns-dot').style.display = 'block';
    }

    function renderSNS() {
        const feed = document.getElementById('sns-feed');
        if(feed) feed.innerHTML = snsPosts.map(p => `<div class="sns-post"><div class="sns-user"><div class="sns-avatar">${p.emoji}</div><div class="sns-name">${p.name}</div><div class="sns-time">${p.time}</div></div><div class="sns-text">${p.text}</div></div>`).join('');
    }

    function checkAchievements() {
        let changed = false;
        achievements.forEach(ach => {
            if (!ach.unlocked && ach.check(state)) {
                ach.unlocked = true;
                changed = true;
                showCenterPopup(ach.icon, "ì—…ì  ë‹¬ì„±!", ach.name);
                addHistory(`ğŸ† <b>ì—…ì  ë‹¬ì„±:</b> [${ach.name}] - ${ach.desc}`);
            }
        });
        if (changed) { renderAchievements(); }
    }

    function renderAchievements() {
        document.getElementById('ach-grid').innerHTML = achievements.map(a => `<div class="ach-item ${a.unlocked ? 'unlocked' : ''}"><div class="ach-icon">${a.icon}</div><div class="ach-title">${a.name}</div><div class="ach-desc">${a.unlocked ? a.desc : '???' }</div></div>`).join('');
    }

    function spawnMessage(text, type) {
        const stack = document.getElementById('dialogue-stack');
        if(!stack) return;
        const bubble = document.createElement('div');
        bubble.className = `dialogue-bubble ${type}`;
        bubble.innerHTML = text;
        stack.appendChild(bubble);
        
        setTimeout(() => {
            bubble.style.animation = 'fade-out-bubble 0.5s forwards';
            setTimeout(() => bubble.remove(), 500);
        }, 3500);
    }

    function addHistory(msg) {
        const timeMsg = `[${new Date().toLocaleTimeString()}] ${msg}`;
        state.history.unshift(timeMsg);
        if (state.history.length > 50) state.history.pop();
        
        const list = document.getElementById('history-list');
        if (list) list.innerHTML = state.history.map(h => `<li>${h}</li>`).join('');
        
        const eventLog = document.getElementById('event-log');
        if (eventLog) eventLog.innerHTML = msg; 

        if (window.innerWidth <= 768) {
            let cleanMsg = msg.replace(/<[^>]*>?/gm, ''); 
            if(cleanMsg.includes(']')) cleanMsg = cleanMsg.split(']')[1].trim(); 
            spawnMessage(cleanMsg, 'event');
        }
    }

    function changeNews() {
        const newsList = ["ì‚°ì„±ë¹„ ì£¼ì˜ë³´ (ìŠ¤íŠ¸ë ˆìŠ¤ UP)", "ë„¤ì˜¨ ì¶•ì œ (íë§ UP)", "ë„¤íŠ¸ì›Œí¬ ì¥ì•  (ìˆ˜ìµ DOWN)", "ê¸°ì—… ë³´ì¡°ê¸ˆ (ìˆ˜ìµ UP)", "ì‹¬ì•¼ì˜ ê³ ìš” (í‰í™”ë¡œì›€)"];
        const pick = newsList[Math.floor(Math.random()*newsList.length)];
        const banner = document.getElementById('news-banner');
        if (banner) banner.innerText = "ğŸ“¢ ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤: " + pick;
    }

    function showCenterPopup(emoji, title, sub) {
        const popup = document.createElement('div');
        popup.className = 'center-popup';
        popup.innerHTML = `<div style="font-size:40px;">${emoji}</div><div>${title}</div><div style="font-size:16px; color:#fff; font-weight:500;">[${sub}]</div>`;
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 3000);
    }

    function showEvolutionToast(rankName) {
        const evo = document.createElement('div');
        evo.className = 'evo-toast';
        evo.innerHTML = `ğŸŒ™ ì½”í‹°ì§€ë£¸ ì§„í™”!<br><span style="font-size:18px; color:#fff;">[${rankName}] í•´ê¸ˆ</span>`;
        document.body.appendChild(evo);
        setTimeout(() => evo.remove(), 4000);
    }

    function closeModalByBg(e, id) {
        if (id === 'museum-modal') { if (!e.target.closest('.artifact-slot')) { toggleModal(id); } return; }
        if (e.target.id === id) { toggleModal(id); }
    }

    function selectRoom(rankIndex) {
        state.currentSelectedRank = rankIndex;
        updateUI();
        showCenterPopup('ğŸ–¼ï¸', 'ë°°ê²½ ë³€ê²½ ì™„ë£Œ!', rankNames[rankIndex-1]);
        toggleModal('gallery-modal');
    }

    function render() {
        document.getElementById('res-grid').innerHTML = state.residents.map((r, i) => {
            let relText = r.relType;
            if (r.partnerId !== null && state.residents[r.partnerId]) { relText = `${state.residents[r.partnerId].name}ì˜ ${r.relType}`; }
            const genderBg = r.gender === 'ì—¬' ? 'var(--female-bg)' : (r.gender === 'ë‚¨' ? 'var(--male-bg)' : '#444');
            return `<div class="res-card" onclick="talkToResident(${i})"><div class="res-icon-box" style="background: ${genderBg}">${r.emoji}</div><div class="stress-box"><div class="stress-fill" id="stress-${i}" style="width: ${r.stress}%"></div></div><div class="res-name">${r.name}</div><div class="res-job" style="font-size:8px;">${r.job}</div><div class="res-rel">${relText}</div></div>`;
        }).join('');
        
        document.getElementById('upgrade-list').innerHTML = state.upgrades.map((u, i) => {
            const data = upgrades[i];
            return `<div class="up-card"><div class="up-info"><h4>${data.name} <small>(Lv.${u.lv})</small></h4><div class="tags">${u.lv === 0 ? '<span class="tag-dev">â­ ë°œì „ë„ +1</span>' : ''}${data.isHealing ? '<span class="tag-healing">ğŸŒ¿ ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ</span>' : ''}</div><p>${data.type === 'click' ? 'í´ë¦­' : 'ì´ˆë‹¹'} +${data.power.toLocaleString()}</p></div><button class="buy-btn" id="btn-${u.id}" onclick="buy(${i})">ğŸ’µ ${u.price.toLocaleString()}</button></div>`;
        }).join('');
        renderMuseum();
    }

    function renderMuseum() {
        document.getElementById('museum-list').innerHTML = artifactsData.map((a, i) => `<div class="artifact-slot ${state.artifacts[i] ? 'found' : ''}" onclick="showArt(${i}, event)">${state.artifacts[i] ? a.emoji : '?'}</div>`).join('');
    }

    function showArt(i, e) { 
        e.stopPropagation(); 
        const descBox = document.getElementById('artifact-desc');
        if(state.artifacts[i]) descBox.innerText = `í…Œì˜¤: "${artifactsData[i].desc}"`; 
        else descBox.innerText = "ì•„ì§ ë¯¸ìˆ˜ì§‘ëœ ìœ ë¬¼ì´ë‹ˆ ì•”ì‹œì¥ì—ì„œ êµ¬í•´ë´!";
    }

    function buy(idx) {
        const u = state.upgrades[idx], d = upgrades[idx];
        
        // 1. êµ¬ë§¤ ë¡œì§
        if(state.money >= u.price) {
            state.money -= u.price; 
            
            if(u.lv === 0) { 
                state.totalUniquePurchased++; 
                addHistory(`ğŸ—ï¸ <b>ì‹ ê·œ ì‹œì„¤:</b> [${d.name}] ê±´ì„¤ ì™„ë£Œ.`); 
            }
            u.lv++;
            
            if(d.type === 'click') state.clickPower += d.power; 
            else state.autoIncome += d.power;
            
            if(d.isHealing) state.residents.forEach(r => r.stress = Math.max(0, r.stress - 20));
            
            u.price = Math.floor(u.price * 1.6);
            
            const newRank = Math.min(20, Math.floor(state.totalUniquePurchased / 5) + 1);
            if (newRank > state.rank) {
                state.rank = newRank; 
                state.currentSelectedRank = newRank;
                showEvolutionToast(rankNames[newRank-1]);
                addHistory(`ğŸŒŸ <b>ë„ì‹œ ì§„í™”:</b> [${rankNames[newRank-1]}] ë‹¬ì„±!`);
                
                if (newRank >= 20 && !state.endingSeen) { 
                    state.endingSeen = true; 
                    startEndingSequence(); 
                }
            }
            
            render(); 
            updateUI();
            
            // ğŸ”¥ [ìˆ˜ì •] ëˆ ì¼ìœ¼ë‹ˆê¹Œ ë°”ë¡œ ì €ì¥!
            saveGame();
        }

        // 2. ë²„íŠ¼ ë½€ì‰ ì—°ì¶œ
        const btn = document.getElementById(`btn-${u.id}`);
        if (btn) {
            btn.classList.remove('click-animate'); 
            void btn.offsetWidth; // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ ë§¤ì§ ì½”ë“œ
            btn.classList.add('click-animate'); 
        }
    }

    function updateUI() {
        document.getElementById('budget').innerText = Math.floor(state.money).toLocaleString();
        state.upgrades.forEach(u => { const btn = document.getElementById(`btn-${u.id}`); if(btn) btn.disabled = state.money < u.price; });
        state.residents.forEach((r, i) => { const fill = document.getElementById(`stress-${i}`); if(fill) fill.style.width = r.stress + '%'; });
        const currentProgress = state.totalUniquePurchased % 5;
        const displayRankName = `Rank.${state.currentSelectedRank} ${rankNames[state.currentSelectedRank-1]}`;
        const displayProgress = (currentProgress * 20) + '%';
        const displayCount = `${currentProgress} / 5`;
        if(document.getElementById('dev-bar-fill')) document.getElementById('dev-bar-fill').style.width = displayProgress;
        if(document.getElementById('dev-count')) document.getElementById('dev-count').innerText = displayCount;
        if(document.getElementById('city-name-display')) document.getElementById('city-name-display').innerText = displayRankName;
        if(document.getElementById('mob-dev-bar-fill')) document.getElementById('mob-dev-bar-fill').style.width = displayProgress;
        if(document.getElementById('mob-dev-count')) document.getElementById('mob-dev-count').innerText = displayCount;
        if(document.getElementById('mob-city-name-display')) document.getElementById('mob-city-name-display').innerText = displayRankName;
        document.getElementById('desk-clicker').src = rankImages[state.currentSelectedRank-1];
        const artCount = state.artifacts.filter(x=>x).length;
        if (document.getElementById('artifact-boost')) document.getElementById('artifact-boost').innerText = artCount > 0 ? `(ìœ ë¬¼ ë²„í”„ +${artCount*10}%)` : "";
    }

    function talkToResident(idx) {
        const res = state.residents[idx];
        if(!res) return;
        let pool = res.dialogues['Solo'];
        if (res.stress > 80) pool = res.dialogues['Stress'];
        const msg = pool[Math.floor(Math.random()*pool.length)];
        
        spawnMessage(`${res.name}: "${msg}"`, 'talk');
    }

    function randomDailyEvent() {
        if (state.residents.length < 2) return;

        // ëœë¤í•˜ê²Œ ë‘ ëª… ë½‘ê¸°
        const p1 = Math.floor(Math.random() * state.residents.length);
        let p2 = Math.floor(Math.random() * state.residents.length);
        while(p1 === p2) { p2 = Math.floor(Math.random() * state.residents.length); } 
        
        const charA = state.residents[p1];
        const charB = state.residents[p2];
        const rand = Math.random();

        // 1. ëŒ€í™” ë° í˜¸ê°ë„ ë³€í™”
        if (rand < 0.45) {
            charA.affection += 5; charB.affection += 5;
            addHistory(`ğŸ’¬ <b>ëŒ€í™”:</b> ${charA.name}${getJosa(charA.name, 'ì™€ê³¼')} ${charB.name}${getJosa(charB.name, 'ì€ëŠ”')} ì¦ê±°ìš´ ëŒ€í™”ë¥¼ ë‚˜ëˆ´ì–´. <span style="color:var(--heart)">(â¤ï¸+5)</span>`);
        } else if (rand < 0.65) {
            charA.affection -= 10; charB.affection -= 10; // ì‹¸ìš°ë©´ í˜¸ê°ë„ ë” ë§ì´ ê¹ì„
            addHistory(`âš¡ <b>ë…¼ìŸ:</b> ${charA.name}${getJosa(charA.name, 'ì™€ê³¼')} ${charB.name}${getJosa(charB.name, 'ì€ëŠ”')} ì‚¬ì†Œí•œ ì˜¤í•´ë¡œ ë‹¤í‰œì–´. <span style="color:#888">(ğŸ’”-10)</span>`);
        }

        // í˜¸ê°ë„ 0~100 ì œí•œ
        state.residents.forEach(r => { r.affection = Math.max(0, Math.min(100, r.affection)); });

        // 2. ê´€ê³„ ë³€í™” ë¡œì§
        
        // A. [ì´ë³„] ì»¤í”Œì¸ë° í˜¸ê°ë„ê°€ 30 ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì§€ë©´ í—¤ì–´ì§
        if (charA.partnerId === charB.id && (charA.affection < 30 || charB.affection < 30)) {
            charA.relType = 'ì†”ë¡œ'; charB.relType = 'ì†”ë¡œ';
            charA.partnerId = null; charB.partnerId = null;
            
            showCenterPopup("ğŸ’”", "ê²°ë³„", `${charA.name} âš¡ ${charB.name}`);
            addHistory(`ğŸ’” <b>ì´ë³„:</b> ${charA.name}${getJosa(charA.name, 'ì™€ê³¼')} ${charB.name}${getJosa(charB.name, 'ì€ëŠ”')} ì„±ê²© ì°¨ì´ë¥¼ ê·¹ë³µí•˜ì§€ ëª»í•˜ê³  ë‚¨ë‚¨ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveGame();
        }

        // B. [ì»¤í”Œ íƒ„ìƒ] ë‘˜ ë‹¤ ì†”ë¡œì´ê³  í˜¸ê°ë„ê°€ 90 ì´ìƒì¼ ë•Œ
        else if (charA.affection >= 90 && charB.affection >= 90) {
            if (charA.relType === 'ì†”ë¡œ' && charB.relType === 'ì†”ë¡œ') {
                charA.relType = 'ì»¤í”Œ'; charB.relType = 'ì»¤í”Œ';
                charA.partnerId = charB.id; charB.partnerId = charA.id;
                
                showCenterPopup("ğŸ’–", "ì»¤í”Œ íƒ„ìƒ!", `${charA.name} â™¥ ${charB.name}`);
                addHistory(`ğŸ’– <b>ì¶•í•˜í•©ë‹ˆë‹¤!</b> ${charA.name}${getJosa(charA.name, 'ì™€ê³¼')} ${charB.name}${getJosa(charB.name, 'ì€ëŠ”')} ì—°ì¸ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                saveGame();
            }
            
            // C. [ë¶ˆë¥œ] í•œ ëª…ì´ë¼ë„ íŒŒíŠ¸ë„ˆê°€ ìˆëŠ”ë° í˜¸ê°ë„ê°€ ë†’ì„ ë•Œ
            else if (charA.partnerId !== charB.id && (charA.relType === 'ì»¤í”Œ' || charB.relType === 'ì»¤í”Œ')) {
                if (charA.relType !== 'ë¶ˆë¥œ' || charB.relType !== 'ë¶ˆë¥œ') {
                    charA.relType = 'ë¶ˆë¥œ'; charB.relType = 'ë¶ˆë¥œ';
                    showCenterPopup("ğŸ˜ˆ", "ìœ„í—˜í•œ ê´€ê³„", `${charA.name} & ${charB.name}`);
                    addHistory(`ğŸ˜ˆ <b>ì¶©ê²©!</b> ${charA.name}${getJosa(charA.name, 'ì™€ê³¼')} ${charB.name}${getJosa(charB.name, 'ì€ëŠ”')} ê¸ˆì§€ëœ ì‚¬ë‘ì— ë¹ ì¡ŒìŠµë‹ˆë‹¤...`);
                    saveGame();
                }
            }
        }

        render(); // í™”ë©´ ê°±ì‹ 
    }

    document.getElementById('desk-clicker').onclick = (e) => { 
        state.money += state.clickPower; 
        const star = document.createElement('div'); star.className = 'hit-effect'; star.innerText = 'ğŸŒŸ';
        star.style.left = (e.clientX - 32) + 'px'; star.style.top = (e.clientY - 32) + 'px';
        document.body.appendChild(star); setTimeout(() => star.remove(), 300);
        updateUI(); 
    };

    function resetGame() {
        if (confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì…ì£¼ ì‹ ì²­ì„œë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œ?\n(ì£¼ì˜: í´ë¼ìš°ë“œì— ì €ì¥ëœ ë°±ì—… ë°ì´í„°ë„ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.)")) {
            // 1. ë¡œì»¬ ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ
            localStorage.removeItem('midnight_cottage_v30_hardcore');

            // 2. êµ¬ê¸€ ë¡œê·¸ì¸ì´ ë˜ì–´ìˆë‹¤ë©´, ì„œë²„ ë°ì´í„° ì‚­ì œ + ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰
            if (currentUser) {
                // A. ì„œë²„ ë°ì´í„° ì‚­ì œ
                db.collection("users").doc(currentUser.uid).delete()
                    .then(() => {
                        // B. ì‚­ì œ ì„±ê³µ ì‹œ ë¡œê·¸ì•„ì›ƒ (ì—°ë™ ëŠê¸°)
                        auth.signOut().then(() => {
                            alert("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ê³„ì • ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            location.reload(); // ê¹¨ë—í•œ ìƒíƒœë¡œ ìƒˆë¡œê³ ì¹¨
                        });
                    })
                    .catch((error) => {
                        console.error("í´ë¼ìš°ë“œ ì‚­ì œ ì‹¤íŒ¨:", error);
                        // ì—ëŸ¬ê°€ ë‚˜ë”ë¼ë„ ë¡œì»¬ì€ ì§€ì› ìœ¼ë‹ˆ ì¼ë‹¨ ìƒˆë¡œê³ ì¹¨
                        location.reload(); 
                    });
            } else {
                // ë¡œê·¸ì¸ ì•ˆ í•œ ìƒíƒœë©´ ë°”ë¡œ ìƒˆë¡œê³ ì¹¨
                location.reload();
            }
        }
    }

    function openGallery() {
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = rankNames.map((name, i) => {
            const unlocked = i < state.rank;
            const isSelected = (i + 1) === state.currentSelectedRank;
            return `<div class="gallery-item ${unlocked ? 'unlocked' : 'locked'} ${isSelected ? 'active' : ''}" onclick="${unlocked ? `selectRoom(${i+1})` : ''}"><img src="${rankImages[i]}" loading="lazy"><div style="background:rgba(0,0,0,0.6); color:#fff; font-size:12px; font-weight:700;">${i+1}. ${name} ${isSelected ? ' (ì‚¬ìš©ì¤‘)' : ''}</div></div>`;
        }).join('');
        toggleModal('gallery-modal');
    }
</script>
</body>
</html>
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="referrer" content="no-referrer">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>미드나잇 코티지 Midnight Cottage</title>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
        <style>
            :root {
                --bg: #09090d; --card: #12121a; --accent: #bb9af7; --gold: #ff9e64;
                --neon-blue: #7aa2f7; --heart: #f7768e; --text: #c0caf5; --border: rgba(187, 154, 247, 0.2);
                --female-bg: rgba(255, 182, 193, 0.35); --male-bg: rgba(135, 206, 235, 0.35);
                --healing: #50fa7b; --danger: #ff5555;
            }
            body { font-family: 'Pretendard', sans-serif; background-color: #050507; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--text); overflow: hidden; user-select: none; }
            
            /* PC 기본 레이아웃 */
            #app { width: 98%; max-width: 1350px; height: 96vh; background: var(--bg); border-radius: 24px; display: flex; flex-direction: column; position: relative; transition: all 0.5s ease; box-shadow: 0 0 80px rgba(0,0,0,1); box-sizing: border-box; }
            
            .app-header { padding: 15px 30px; display: grid; grid-template-columns: 350px 1fr 500px; align-items: center; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--border); border-radius: 24px 24px 0 0; z-index: 10; height: auto; min-height: 60px; }
            .header-left { display: flex; flex-direction: column; gap: 8px; }
            .budget-display { font-size: 32px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }
            #news-banner { font-size: 12px; color: var(--neon-blue); font-weight: 700; background: rgba(122, 162, 247, 0.1); padding: 4px 10px; border-radius: 6px; margin-top: 2px; border-left: 3px solid var(--neon-blue); width: fit-content; max-width: 320px; }
            
            /* PC 전용 상태창 */
            #pc-city-status { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
            #city-name-display { font-size: 17px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
            .dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
            #dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }

            /* 모바일 전용 상태창 */
            #mobile-city-status { display: none; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 5px; flex-direction: column; gap: 4px; }
            #mob-city-name-display { font-size: 15px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
            .mob-dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); margin-top: 2px; }
            #mob-dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }
            
            .res-area { display: flex; justify-content: center; gap: 10px; }
            .res-card { display: flex; flex-direction: column; align-items: center; width: 85px; cursor: pointer; position: relative; transition: 0.2s; }
            .res-card:hover { transform: translateY(-5px); }
            .res-icon-box { width: 50px; height: 50px; border-radius: 14px; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; font-size: 24px; position: relative; }
            .stress-box { width: 100%; height: 5px; background: #222; border-radius: 3px; margin-top: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
            .stress-fill { height: 100%; background: var(--heart); transition: width 0.3s ease; }
            .res-name { font-size: 13px; margin-top: 4px; font-weight: 800; color: #fff; }
            .res-job { font-size: 9px; color: var(--neon-blue); font-weight: 700; margin-top: 1px; }
            .res-rel { font-size: 9px; color: var(--heart); font-weight: 800; text-align: center; min-height: 24px; margin-top: 2px; line-height: 1.2; }
            
            .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
            .top-buttons { display: flex; gap: 8px; }
            .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; transition: 0.3s; position: relative; }
            .icon-btn:hover { background: var(--border); transform: scale(1.1); }
            .noti-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg); display: none; }
            
            /* PC 이벤트 로그 */
            #event-log { 
                font-size: 19px; 
                color: var(--accent); 
                font-weight: 800; 
                text-align: right; 
                line-height: 1.3; 
                width: 100%; 
                display: flex; 
                flex-direction: column; 
                align-items: flex-end; 
                justify-content: flex-end;
                word-break: keep-all; 
                min-height: 50px; 
            }

            .content-container { flex: 1; display: flex; overflow: hidden; }
            .main-panel { flex: 1.8; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
            #desk-clicker { width: 100%; max-width: 480px; cursor: pointer; transition: transform 0.1s ease, filter 0.3s ease; filter: drop-shadow(0 0 30px rgba(187, 154, 247, 0.2)); margin-top: 40px; margin-bottom: 20px; }
            #desk-clicker:active { transform: scale(0.95); }
            .hit-effect { position: absolute; pointer-events: none; font-size: 65px; z-index: 100; animation: hit-star 0.3s ease-out forwards; }
            @keyframes hit-star { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.1); opacity: 0; } }
            
            /* 대화창 컨테이너 */
            #dialogue-stack { 
                position: absolute; bottom: 120px; z-index: 50; width: 90%; max-width: 500px; 
                display: flex; flex-direction: column-reverse; align-items: center; gap: 8px; pointer-events: none; 
            }
            .dialogue-bubble { 
                background: rgba(0,0,0,0.85); border: 2px solid var(--accent); border-radius: 20px; padding: 12px 20px; 
                font-size: 15px; font-weight: 700; color: #fff; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                animation: slide-up-fade 0.3s ease-out forwards; max-width: 100%; pointer-events: none;
            }
            .dialogue-bubble.event { border-color: var(--accent); color: var(--accent); }
            @keyframes slide-up-fade {
                0% { opacity: 0; transform: translateY(20px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes fade-out-bubble {
                to { opacity: 0; transform: translateY(-10px); }
            }

            .side-menu { flex: 1.1; background: rgba(0,0,0,0.4); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; border-left: 1px solid var(--border); }
            .menu-title { font-size: 17px; font-weight: 800; color: var(--gold); border-left: 4px solid var(--gold); padding-left: 12px; margin-bottom: 10px; }
            
            /* 카드 레이아웃 */
            .up-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 12px 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.03); width: 100%; box-sizing: border-box; min-height: 80px; }
            .up-info { flex: 1; min-width: 0; margin-right: 10px; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
            .up-info h4 { margin: 0; font-size: 15px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .up-info p { margin: 0; font-size: 13px; color: #aaa; white-space: nowrap; }
            .tags { display: flex; gap: 5px; margin-top: 0; }
            .tag-dev { font-size: 9px; background: rgba(255, 158, 100, 0.2); color: var(--gold); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
            .tag-healing { font-size: 10px; background: rgba(80, 250, 123, 0.2); color: var(--healing); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
            .buy-btn { background: transparent; border: 1.5px solid var(--gold); color: var(--gold); padding: 8px 10px; border-radius: 10px; font-size: 13px; font-weight: 900; cursor: pointer; min-width: 80px; flex-shrink: 0; text-align: center; }
            .buy-btn:disabled { border-color: #2a2a2a; color: #444; }
            
            .toast { background: var(--gold); color: #000; padding: 12px 24px; border-radius: 50px; font-weight: 900; font-size: 18px; box-shadow: 0 0 30px var(--gold); animation: toast-pop 3s forwards; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
            .evo-toast { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #000; padding: 20px 40px; border-radius: 15px; font-size: 24px; font-weight: 900; z-index: 2000; animation: evo-pop 4s forwards; box-shadow: 0 0 50px var(--accent); text-align: center; border: 4px solid #fff; }
            .center-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 10, 15, 0.95); border: 2px solid var(--gold); color: var(--gold); padding: 25px 50px; border-radius: 20px; font-size: 22px; font-weight: 900; z-index: 2000; animation: fade-in-out 3s forwards; box-shadow: 0 0 40px rgba(255, 158, 100, 0.4); text-align: center; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
            @keyframes fade-in-out { 0% { opacity:0; transform:translate(-50%, -40%); } 15% { opacity:1; transform:translate(-50%, -50%); } 85% { opacity:1; transform:translate(-50%, -50%); } 100% { opacity:0; transform:translate(-50%, -60%); } }
            @keyframes evo-pop { 0% { opacity:0; transform:translate(-50%, -30%) scale(0.8); } 10% { opacity:1; transform:translate(-50%, -50%) scale(1.1); } 20% { transform:translate(-50%, -50%) scale(1); } 90% { opacity:1; } 100% { opacity:0; transform:translate(-50%, -70%) scale(0.8); } }
            @keyframes toast-pop { 0% { opacity:0; transform:translateY(20px); } 15% { opacity:1; transform:translateY(0); } 85% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-20px); } }
            
            .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; padding: 40px; text-align: center; border-radius: 24px; box-sizing: border-box; backdrop-filter: blur(5px); }
            #donation-modal { z-index: 201 !important; }
            .modal h2 { margin-top: 0; margin-bottom: 30px; font-size: 28px; }
            /* PC 버전: 설정 모달 타이트하게 */
            @media (min-width: 769px) {
                #help-modal > div { padding: 20px 30px; }
                #help-modal h2 { margin-top: 0; margin-bottom: 15px; font-size: 24px; }
                #help-modal > div > p { margin-bottom: 15px; }
                #help-modal > div > div[style*="margin: 25px 0"] { margin: 15px 0 !important; }
            }
            .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 90%; overflow-y: auto; padding: 10px; max-height: 70vh; box-sizing: border-box; }
            .gallery-item { cursor: pointer; border-radius: 12px; border: 2px solid transparent; transition: 0.3s; overflow: hidden; position: relative; background: #181820; display: flex; flex-direction: column; padding-bottom: 10px; height: auto; }
            .gallery-item img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; opacity: 0.4; display: block; border-bottom: 1px solid #333; }
            .gallery-item.unlocked img { opacity: 1; }
            .gallery-item.active { border-color: var(--gold); box-shadow: 0 0 20px rgba(255, 158, 100, 0.3); }
            .gallery-item div { padding: 5px 10px; box-sizing: border-box; line-height: 1.2; }
            .gallery-item.locked img { display: block; opacity: 0.15; filter: blur(3px) grayscale(100%); }
            .gallery-item.locked::before { content: '🔒'; font-size: 24px; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 5; opacity: 0.7; }
            .museum-container { display: flex; flex-direction: column; align-items: center; gap: 30px; width: 100%; height: 100%; justify-content: center; pointer-events: none; }
            .museum-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 10px; pointer-events: auto; }
            .artifact-slot { width: 85px; height: 85px; background: #111; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; border-radius: 15px; cursor: pointer; font-size: 32px; transition: 0.3s; pointer-events: auto; }
            .artifact-slot.found { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 158, 100, 0.3); }
            #artifact-desc { pointer-events: auto; color:#aaa; font-style:italic; font-size: 18px; margin-top: 20px; }
            #history-list li { margin-bottom: 12px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px; color: #ccc; }
            
            #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050507; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text); }
            .start-form { background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); width: 400px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
            .form-group { display: flex; flex-direction: column; gap: 8px; }
            .form-group label { font-size: 14px; font-weight: 700; color: var(--gold); }
            .form-group input, .form-group select { background: #1a1a24; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; font-family: 'Pretendard'; outline: none; }
            .form-group input::placeholder { color: #666; font-style: italic; }
            .form-group input:focus, .form-group select:focus { border-color: var(--neon-blue); }
            .nav-btns { display: flex; gap: 10px; margin-top: 15px; }
            .start-btn { flex: 1; background: var(--accent); color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; }
            .start-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--accent); }
            .prev-btn { flex: 0.4; background: #333; color: #fff; border-radius: 12px; font-weight: 700; border:none; cursor: pointer; }
            .finish-btn { flex: 1; background: #50fa7b; color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; display: none; }
            .finish-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px #50fa7b; }
            #char-count { position: absolute; top: 20px; right: 20px; font-size: 14px; color: #666; font-weight: 900; }
            .sns-container { width: 450px; height: 600px; background: var(--card); border: 2px solid var(--border); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
            .sns-header { background: rgba(0,0,0,0.5); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
            .sns-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
            .sns-post { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
            .sns-user { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
            .sns-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; }
            .sns-name { font-size: 14px; font-weight: 700; color: #fff; }
            .sns-time { font-size: 11px; color: #666; margin-left: auto; }
            .sns-text { font-size: 13px; color: #ccc; line-height: 1.4; }
            
            .gacha-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 400px; text-align: center; }
            .gacha-btn { background: var(--accent); color: #000; padding: 20px; border-radius: 15px; font-weight: 900; font-size: 20px; border: none; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(187, 154, 247, 0.4); display: flex; flex-direction: column; align-items: center; gap: 5px; }
            .gacha-btn:hover { transform: scale(1.05); }
            .gacha-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; transform: none; }
            .gacha-cost { font-size: 22px; font-weight: 900; opacity: 1; color: #000; margin-top: 5px; }
            
            .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; max-height: 500px; overflow-y: auto; }
            .ach-item { background: #1a1a24; padding: 15px; border-radius: 12px; border: 1px solid #333; opacity: 0.5; transition: 0.3s; }
            .ach-item.unlocked { opacity: 1; border-color: var(--gold); background: rgba(255, 158, 100, 0.05); }
            .ach-icon { font-size: 24px; margin-bottom: 5px; }
            .ach-title { font-weight: 800; color: #fff; font-size: 14px; }
            .ach-desc { font-size: 11px; color: #aaa; margin-top: 3px; }
            
            /* 💌 엔딩 시퀀스 스타일 */
            #ending-sequence { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; }
            .rolling-container { text-align: center; opacity: 0; transform: translateY(20px); transition: 1s ease; display: flex; flex-direction: column; align-items: center; }
            .rolling-container.show { opacity: 1; transform: translateY(0); }
            .end-emoji { font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--accent)); }
            .end-name { font-size: 24px; font-weight: 800; color: var(--gold); margin-bottom: 20px; }
            .end-msg { font-size: 22px; color: #fff; font-weight: 300; line-height: 1.6; max-width: 80%; margin: 0 auto; word-break: keep-all; font-family: 'Pretendard', serif; }
            .ending-btn { background: var(--gold); color: #000; padding: 15px 30px; border-radius: 30px; font-weight: 900; font-size: 18px; border: none; cursor: pointer; transition: 0.3s; }
            .ending-btn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }
            @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

            /* 🌟 2. 모바일 반응형 CSS */
            @media (max-width: 768px) {
                body { height: 100vh; overflow: hidden; position: fixed; width: 100%; }
                #app { height: 100%; width: 100%; border-radius: 0; display: flex; flex-direction: column; }

                /* 🛠️ [모바일 수정] 헤더 여백 줄이기 */
                .app-header { display: flex; flex-direction: column; padding: 5px 15px 0px 15px; gap: 0px; height: auto; flex-shrink: 0; align-items: center; border-bottom: none; }
                
                .header-left { width: 100%; order: 1; align-items: flex-start; margin-bottom: 0px; }
                .budget-display { font-size: 24px; margin: 0; justify-content: flex-start; white-space: nowrap; width: 100%; }
                #news-banner { display: none; }
                #pc-city-status { display: none; }

                /* 🛠️ [모바일 수정] 상단 메뉴 아이콘 가로 중앙 정렬 */
                .header-right { width: 100%; order: 2; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; margin-top: 5px; }
                .top-buttons { width: 100%; display: flex; gap: 12px; margin: 0; flex-wrap: nowrap; overflow-x: auto; justify-content: center; }
                .icon-btn { width: 38px; height: 38px; font-size: 18px; flex-shrink: 0; }
                
                /* [모바일] 이벤트 로그 텍스트 숨김 */
                #event-log { display: none !important; }

                /* 🛠️ [모바일 수정] 주민 목록 여백 축소 */
                .res-area { order: 3; width: 100%; margin-top: 5px; padding-bottom: 5px; overflow-x: auto; justify-content: center; display: flex; }
                .res-card { min-width: 55px; margin-right: 5px; transform: none !important; transition: none !important; }
                .res-card:hover, .res-card:active { transform: none !important; margin-top: 0 !important; }
                .res-icon-box { width: 40px; height: 40px; font-size: 20px; }
                .res-name { font-size: 10px; margin-top: 2px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
                
                /* 🛠️ [모바일 수정] 직업과 관계(솔로/커플) 모두 표시 */
                .res-job { 
                    display: block !important; 
                    font-size: 8px; 
                    color: var(--neon-blue); 
                    margin-top: 1px;
                    white-space: nowrap;
                }
                .res-rel { 
                    display: block !important; 
                    font-size: 8px; 
                    color: var(--heart); 
                    margin-top: 0px;
                    white-space: nowrap;
                }

                .content-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

                /* 🛠️ [모바일 수정] 방 화면 높이 확대 (35% -> 45%) - 일본어판과 동일하게 */
                .main-panel { 
                    flex: 0 0 45%; 
                    padding: 0; 
                    order: 1; 
                    position: relative; 
                    background: #000; 
                    display: flex; 
                    justify-content: center; 
                    align-items: center; 
                    overflow: hidden; 
                }
                
                /* 🛠️ [모바일 수정] 방 이미지 확대 (100% -> 130%) - 일본어판과 동일하게 */
                #desk-clicker { 
                    width: 130%; 
                    height: 130%; 
                    object-fit: contain; 
                    margin: 0; 
                    /* 위치도 일본어판(15px)과 똑같이 맞춤 */
                    transform: translateY(15px); 
                }
                
                /* 대화창 위치 조정 */
                #dialogue-stack { bottom: 10px; width: 90%; gap: 6px; }
                .dialogue-bubble { font-size: 13px; padding: 10px; }

                /* 🛠️ [모바일] 사이드 메뉴(정보창) 여백 타이트하게 조정 */
                .side-menu { flex: 1; order: 2; height: auto; overflow-y: auto; border-top: 2px solid var(--border); background: rgba(0,0,0,0.9); padding: 10px 15px 80px 15px; }
                #mobile-city-status { display: flex; margin-bottom: 5px; padding: 8px; } 
                
                /* 🔥 [수정] 1. 개발일지 왼쪽 정렬 */
                .menu-title { margin-bottom: 5px; text-align: left; border-left: none; padding-left: 0; }
                
                /* 🔥 [수정] 2. 업그레이드 카드 세로 정렬 및 버튼 하단 배치 */
                .up-card { flex-direction: column; align-items: flex-start; padding: 12px; min-height: auto; margin-bottom: 8px; gap: 8px; }
                .up-info { width: 100%; margin-right: 0; }
                .up-info h4, .up-info p { white-space: normal; word-break: keep-all; overflow: visible; } /* 텍스트 줄바꿈 허용 */
                .buy-btn { width: 100%; margin-top: 5px; height: 40px; } /* 버튼 하단 꽉 채우기 */

                .evo-toast { width: 85%; min-width: unset; white-space: nowrap; font-size: 16px; padding: 12px 10px; bottom: 35%; border-width: 2px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

                .modal h2, #history-modal h2 { margin-top: 0 !important; margin-bottom: 15px !important; padding-top: 0 !important; line-height: 1.2; transform: translateY(-10px); }
                #history-list { padding-top: 0 !important; margin-top: 0 !important; }

                .sns-container { width: 100%; height: 75%; margin-top: -20px; margin-bottom: 20px; }

                .museum-container { width: 100%; display: flex; flex-direction: column; padding: 10px 0; overflow-x: hidden; height: 100%; }
                .museum-container h2 { order: 1; flex-shrink: 0; }
                #artifact-desc { order: 2; margin-bottom: 10px; margin-top: 0; font-size: 13px; color: var(--neon-blue); min-height: 20px; flex-shrink: 0; }
                .museum-grid { order: 3; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 95%; margin: 0 auto; padding: 0 5px 100px 5px; box-sizing: border-box; overflow-y: auto; }
                .artifact-slot { width: 100%; aspect-ratio: 1 / 1; font-size: 14px; } 

            .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px 5px 80px 5px; width: 100%; box-sizing: border-box; overflow-y: auto; }
            .gallery-item { width: 100%; height: auto; display: flex; flex-direction: column; }
            .gallery-item img { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; }

                .modal { position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; z-index: 9999; padding: 10px; box-sizing: border-box; overflow-y: auto; }
                #donation-modal { z-index: 10000 !important; }
                #help-modal { padding: 5px !important; }
                #help-modal > div { max-height: calc(100vh - 20px); overflow-y: auto; margin: auto; padding-bottom: 120px !important; width: 100%; max-width: 100%; min-width: 0 !important; box-sizing: border-box; }
                #help-modal-content { padding: 12px 8px !important; }
                #help-modal-content > div[style*="display:flex"] { flex-direction: column !important; }
                #help-modal-content > div[style*="display:flex"] > div { min-width: 0 !important; width: 100% !important; padding: 15px 12px !important; }
                #help-modal-content > div[style*="display:flex"] > div > div[style*="padding:8px 20px"] { padding: 8px 12px !important; }
                #help-modal-content > div[style*="display:flex"] > div > button { padding: 10px 12px !important; font-size: 13px !important; }
                #help-modal-content > div[style*="display:flex"] > div > div[style*="padding:15px 20px"] { padding: 12px 12px 10px 12px !important; }
                #food-modal > div { padding: 15px 12px 50px 12px !important; max-height: calc(100vh - 30px) !important; }
                #food-menu-list { padding-bottom: 30px !important; }
                #food-modal h2 { margin-top: 0 !important; margin-bottom: 8px !important; font-size: 18px !important; }
                #food-modal > div > p { margin-bottom: 8px !important; font-size: 11px !important; }
                #food-menu-list { gap: 8px !important; grid-template-columns: 1fr !important; }
                #food-menu-list > div { padding: 10px !important; gap: 8px !important; }
                #food-menu-list > div > div:first-child { gap: 8px !important; }
                #food-menu-list > div > div:first-child > span { font-size: 24px !important; }
                #food-menu-list > div > div:first-child > div > h4 { font-size: 14px !important; }
                #food-menu-list > div > div:first-child > div > p { font-size: 11px !important; margin-top: 3px !important; }
                #food-menu-list > div > div:last-child > span { font-size: 16px !important; }
                #food-menu-list > div > div:last-child > button { padding: 6px 12px !important; font-size: 12px !important; }
                .res-icon-box > div[style*="스트레스"] { font-size: 8px !important; padding: 1px 4px !important; }
                .gallery-item.locked::before { font-size: 16px !important; }
                .center-popup { z-index: 10001 !important; }
                #radio-list { font-size: 12px !important; padding: 12px !important; height: 250px !important; }
                #radio-input { padding: 10px !important; font-size: 13px !important; }
                #btn-send-radio { padding: 10px 20px !important; font-size: 13px !important; }
                .start-form { width: 90%; max-width: 350px; padding: 20px; box-sizing: border-box; margin: 0 auto; }
                .gacha-container { width: 100%; }
            }

            /* 🔘 [추가] 버튼 클릭 뽀잉 애니메이션 */
            @keyframes boing {
                0% { transform: scale(1); }
                40% { transform: scale(0.9); }  /* 꾹 눌림 */
                60% { transform: scale(1.1); }  /* 띠용 하고 커짐 */
                100% { transform: scale(1); }   /* 원상복구 */
            }
            .click-animate {
                animation: boing 0.3s ease-out forwards;
            }
        </style>
    </head>
    <body>

    <div id="app">
        <div id="start-screen" style="display:flex;">
            <div class="start-form">
                <h2 style="text-align:center; color:var(--accent); margin-bottom:10px;">📄 입주 신청서</h2>
                
                <div id="char-count">1 / 5</div>
                <div class="form-group">
                    <label>이름 (닉네임)</label>
                    <input type="text" id="input-name" placeholder="이름을 정해주세요">
                </div>
                <div class="form-group">
                    <label>성별</label>
                    <select id="input-gender">
                        <option value="남">남성</option>
                        <option value="여">여성</option>
                        <option value="무">무성/기타</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>직업 (선택)</label>
                    <select id="input-job">
                        <option value="화가">🎨 화가</option>
                        <option value="소설가">✍️ 소설가</option>
                        <option value="교수">📚 교수</option>
                        <option value="리퍼닥">🛠️ 리퍼닥</option>
                        <option value="ASMR DJ">🎧 ASMR DJ</option>
                        <option value="모델">👠 모델</option>
                        <option value="형사">🕵️ 형사</option>
                        <option value="넷러너">💻 넷러너</option>
                        <option value="라멘노점상">🍜 라멘노점상</option>
                        <option value="온천주인">♨️ 온천주인</option>
                        <option value="LP바 사장님">💿 LP바 사장님</option>
                        <option value="뮤지션">🎸 뮤지션</option>
                        <option value="고양이">🐱 고양이</option>
                        <option value="VIP">👑 VIP</option>
                        <option value="백수">🛋️ 백수</option>
                    </select>
                </div>
                <div class="nav-btns">
                    <button class="prev-btn" onclick="prevChar()" id="btn-prev" style="display:none;">이전</button>
                    <button class="start-btn" onclick="nextChar()" id="btn-next">추가 (1/5)</button>
                    <button class="finish-btn" onclick="finishSetup()" id="btn-finish">입주 시작</button>
                </div>
            </div>
        </div>

        <div id="ending-sequence">
            <div class="rolling-container">
                <div id="end-emoji" class="end-emoji"></div>
                <div id="end-name" class="end-name"></div>
                <div id="end-msg" class="end-msg"></div>
            </div>
            <div id="final-screen" style="display:none; text-align:center; z-index:6005;">
                <h1 style="font-size:40px; color:var(--accent); margin-bottom:20px;">The End</h1>
                <p style="color:#ccc; margin-bottom:30px; line-height: 1.6;">
                    미드나잇 코티지의 밤은 계속됩니다.<br>
                    당신의 작업도 이들처럼 빛나기를.
                </p>
                <button class="ending-btn" onclick="closeEndingSequence()">남아서 계속하기</button>
            </div>
        </div>

        <div id="toast-container"></div>
        
        <div class="app-header">
            <div class="header-left">
                <div class="budget-display">💵 <span id="budget">0</span></div>
                <div id="news-banner">📢 뉴스 로딩 중...</div>
                <div id="pc-city-status">
                    <div id="city-name-display">소박하고 아늑한 사이버펑크 방</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                        <div style="display:flex; align-items:center; gap:4px;">
                            <span style="color:var(--gold); font-weight:800;">⭐ 발전도</span>
                            <div onclick="toggleModal('dev-info-modal')" 
                                style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                        </div>
                        <div id="dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                    </div>
                    <div class="dev-bar-bg"><div id="dev-bar-fill"></div></div>
                </div>
            </div>
            
            <div class="res-area" id="res-grid"></div>
            
            <div class="header-right">
                <div class="top-buttons">
                    <button class="icon-btn" onclick="toggleModal('shop-modal')">🏺</button>
                    <button class="icon-btn" onclick="toggleModal('sns-modal')">📱<div id="sns-dot" class="noti-dot"></div></button>
                    <button class="icon-btn" onclick="toggleModal('ach-modal')">🏆</button>
                    <button class="icon-btn" onclick="openGallery()">🖼️</button>
                    <button class="icon-btn" onclick="toggleModal('museum-modal')" style="font-size:12px !important;">🏛️</button>
                    <button class="icon-btn" onclick="toggleModal('history-modal')">📜</button>
                    <button class="icon-btn" onclick="toggleModal('help-modal')">?</button>
                </div>
                <div id="event-log">💻작업 화이팅! 미드나잇 코티지가 너를 반겨.</div>
            </div>
        </div>

        <div class="content-container">
            <div class="main-panel" style="position:relative;">
                <button id="btn-radio" class="icon-btn" onclick="toggleModal('radio-modal')" 
                        style="position:absolute; top:10px; left:10px; display:none; z-index:100;">
                    📡
                </button>
                <button id="food-icon-btn" class="icon-btn" onclick="toggleModal('food-modal')" 
                        style="position:absolute; top:70px; left:10px; display:none; z-index:100;">
                    🍜
                </button>
                <button id="fortune-icon-btn" class="icon-btn" onclick="toggleModal('fortune-modal')" 
                        style="position:absolute; top:130px; left:10px; display:none; z-index:100;">
                    🔮
                </button>
                <img id="desk-clicker" src="https://i.imgur.com/MuFQQ5A.png" alt="City Image">
                <div id="dialogue-stack"></div>
            </div>
            <div class="side-menu">
                <div class="menu-title">🌃 미드나잇 시티 개발일지 <span id="artifact-boost" style="font-size:11px; color:var(--gold)"></span></div>
                
                <div id="mobile-city-status">
                    <div id="mob-city-name-display">소박하고 아늑한 사이버펑크 방</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                        <div style="display:flex; align-items:center; gap:4px;">
                            <span style="color:var(--gold); font-weight:800;">⭐ 발전도</span>
                            <div onclick="toggleModal('dev-info-modal')" 
                                style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                        </div>
                        <div id="mob-dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                    </div>
                    <div class="mob-dev-bar-bg"><div id="mob-dev-bar-fill"></div></div>
                </div>

                <div id="upgrade-list"></div>
            </div>
        </div>

        <div id="gallery-modal" class="modal" onclick="closeModalByBg(event, 'gallery-modal')">
            <h2 style="color:var(--gold); pointer-events:none;">🖼️ 코티지 룸 갤러리</h2>
            <div id="gallery-grid" class="gallery-grid" onclick="event.stopPropagation()"></div>
        </div>
        <div id="museum-modal" class="modal" onclick="closeModalByBg(event, 'museum-modal')">
            <div class="museum-container">
                <h2 style="color:var(--gold); margin: 0; pointer-events: none;">🏛️ 2202년 역사 박물관 (2026 유물)</h2>
                <div id="museum-list" class="museum-grid"></div>
                <p id="artifact-desc" style="pointer-events: none;">유물을 클릭하면 테오 교수의 한 줄 평이 나옵니다.</p>
            </div>
        </div>
        <div id="history-modal" class="modal" onclick="closeModalByBg(event, 'history-modal')">
            <h2 style="color:var(--accent); margin-bottom: 20px; pointer-events:none;">📜 미드나잇 코티지 기록</h2>
            <ul id="history-list" style="width:90%; text-align:left; overflow-y:auto; max-height:500px; padding:0 30px; list-style:none;" onclick="event.stopPropagation()"></ul>
        </div>
        <div id="shop-modal" class="modal" onclick="closeModalByBg(event, 'shop-modal')">
            <h2 style="color:#bd93f9;">🏺 고대 유물 박물관 (Artifacts)</h2>
            <div class="gacha-container" onclick="event.stopPropagation()">
                <p style="color:#ccc; font-size:14px; margin-bottom:20px;">
                    2026년의 잊혀진 고대 유물을 발굴하고 복원하는 곳입니다.<br>
                    유물을 복원하여 전시하면 <b>전체 수익 보너스</b>를 얻습니다.
                </p>
                <button class="gacha-btn" id="btn-gacha" onclick="buyArtifact()">
                    ⛏️ 유물 발굴 및 복원 시도
                    <span class="gacha-cost" id="gacha-price"></span>
                </button>
            </div>
        </div>
        <div id="food-modal" class="modal" onclick="closeModalByBg(event, 'food-modal')">
            <div onclick="(function(e){if(!e.target.closest('.food-buy-btn') && !e.target.closest('.food-item-card')){toggleModal('food-modal');}})(event)" style="background:var(--card); padding:30px 30px 50px 30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 350px; max-width: 600px; max-height: 90vh; overflow-y: auto; box-sizing: border-box;">
                <h2 style="color:var(--gold); margin-top:0; margin-bottom:15px; font-size:24px; pointer-events:none;">🍜 합성 라면 가판대</h2>
                <p style="font-size:14px; color:#ccc; margin-bottom:15px; line-height:1.6; pointer-events:none;">
                    따뜻한 음식이 모든 주민의 스트레스를 해소해줍니다.
                </p>
                <div id="food-menu-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:12px; text-align:left; padding-bottom:20px;">
                    <!-- 음식 메뉴가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
        <div id="fortune-modal" class="modal" onclick="toggleModal('fortune-modal')">
            <div onclick="toggleModal('fortune-modal')" style="background:var(--card); padding:30px; border-radius:20px; border:2px solid var(--heart); text-align:center; min-width: 400px; max-width: 700px; max-height: 90vh; overflow-y: auto; box-sizing: border-box; cursor:pointer;">
                <h2 style="color:var(--heart); margin-top:0; margin-bottom:20px; font-size:24px; pointer-events:none;">🔮 운명의 붉은 실</h2>
                <p style="font-size:14px; color:#ccc; margin-bottom:20px; line-height:1.6; pointer-events:none;">
                    점술집에서 운명의 실을 조작하여 캐릭터들의 관계를 바꿀 수 있습니다.
                </p>
                <div id="fortune-char-list" style="display:flex; flex-direction:column; gap:15px; text-align:left; padding-bottom:20px;">
                    <!-- 캐릭터 목록이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
        <div id="sns-modal" class="modal" onclick="closeModalByBg(event, 'sns-modal')">
            <div class="sns-container">
                <div class="sns-header">
                    <span style="font-weight:900; color:var(--neon-blue);">📱 Midnight Talk</span>
                    <span style="font-size:12px; color:#666;">실시간</span>
                </div>
                <div id="sns-feed" class="sns-feed"></div>
            </div>
        </div>
        <div id="ach-modal" class="modal" onclick="closeModalByBg(event, 'ach-modal')">
            <h2 style="color:var(--gold);">🏆 비밀 업적</h2>
            <div id="ach-grid" class="ach-grid" onclick="event.stopPropagation()"></div>
        </div>
        <div id="radio-modal" class="modal" onclick="closeModalByBg(event, 'radio-modal')">
            <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 400px; max-width: 700px; max-height: 90vh; overflow-y: auto; box-sizing: border-box;">
                <h2 style="color:var(--neon-blue); margin-top:0; margin-bottom:15px; font-size:24px;">📡 미드나잇 주파수 (Public Frequency)</h2>
                <p style="font-size:14px; color:#888; margin-bottom:20px; line-height:1.6;">
                    이곳은 익명의 신호가 오가는 공간입니다. 최근 20개의 신호만 기록됩니다.
                </p>
                <div id="radio-list" style="background:rgba(0,0,0,0.8); border:1px solid var(--border); border-radius:12px; padding:15px; height:300px; overflow-y:auto; margin-bottom:20px; text-align:left; font-family:'Courier New', monospace; font-size:13px; color:#50fa7b; line-height:1.8;">
                    <!-- 라디오 메시지가 여기에 동적으로 추가됩니다 -->
                </div>
                <div style="display:flex; gap:10px;">
                    <input id="radio-input" type="text" placeholder="신호를 입력하세요..." 
                        style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; padding:12px; color:var(--text); font-size:14px; outline:none;"
                        onkeypress="if(event.key==='Enter') sendRadioMessage();">
                    <button id="btn-send-radio" onclick="sendRadioMessage()" 
                            style="background:var(--neon-blue); color:#000; border:none; padding:12px 24px; border-radius:8px; font-weight:900; cursor:pointer; font-size:14px; white-space:nowrap;">
                        전송
                    </button>
                </div>
            </div>
        </div>
        <div id="dev-info-modal" class="modal" onclick="closeModalByBg(event, 'dev-info-modal')">
            <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 300px;">
                <h2 style="color:var(--gold)">⭐ 발전도 안내</h2>
                <p style="font-size:15px; line-height:1.8; color:#ccc; margin-bottom: 20px;">
                    건물 최초 3회 건설 시 새로운 방을 얻을 수 있습니다.
                </p>
            </div>
        </div>
        <div id="ranking-modal" class="modal" onclick="closeModalByBg(event, 'ranking-modal')">
            <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 400px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h2 style="color:var(--gold); margin-bottom:10px;">📊 랭킹</h2>
                <div id="firebase-status" style="margin-bottom:15px; padding:8px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:12px;">
                    <span id="firebase-status-text" style="color:#888;">연결 상태 확인 중...</span>
                </div>
                
                <div style="margin-bottom:20px; padding:15px; background:rgba(187, 154, 247, 0.1); border:1px solid var(--border); border-radius:12px;">
                    <label style="display:block; color:var(--accent); font-weight:700; margin-bottom:8px; text-align:left;">플레이어 이름</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="player-name-input" placeholder="이름을 입력하세요" 
                            value="" 
                            style="flex:1; background:#1a1a24; border:1px solid #333; color:#fff; padding:10px; border-radius:8px; font-size:14px; font-family:'Pretendard'; outline:none;"
                            onkeypress="if(event.key==='Enter') savePlayerName()">
                        <button onclick="savePlayerName()" 
                                style="background:var(--accent); color:#000; border:none; padding:10px 20px; border-radius:8px; font-weight:900; cursor:pointer; font-size:14px; white-space:nowrap;">
                            저장
                        </button>
                    </div>
                    <p style="font-size:11px; color:#888; margin-top:8px; text-align:left;">이름을 입력하면 랭킹에 표시됩니다</p>
                </div>
                
                <div id="ranking-list" style="text-align:left;">
                    <p style="color:#888; font-style:italic;">랭킹 데이터를 불러오는 중...</p>
                </div>
            </div>
        </div>
        <div id="donation-modal" class="modal" onclick="if(event.target === this) toggleModal('donation-modal')">
            <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:2px solid var(--gold); text-align:center; min-width: 350px; max-width: 500px; max-height: 90vh; overflow-y: auto; box-sizing: border-box;">
                <h2 style="color:var(--gold); margin-top:0; margin-bottom:20px; font-size:24px;">☕ 후원하기</h2>
                <p style="font-size:14px; color:#ccc; margin-bottom:20px; line-height:1.6;">
                    개발자에게 커피 한 잔 사주시면<br>
                    <span style="color:var(--gold); font-weight:800;">VIP 전용 방 3개</span>를 증정해드립니다!
                </p>
                
                <div style="margin:20px 0; padding:20px; background:rgba(255, 158, 100, 0.1); border:2px solid var(--gold); border-radius:15px;">
                    <h3 style="color:var(--gold); font-size:16px; margin:0 0 15px 0; font-weight:800;">카카오페이 송금</h3>
                    <img src="https://i.imgur.com/AGJ0z8f.jpeg" alt="카카오페이 QR코드" 
                        style="width:100%; max-width:300px; border-radius:12px; border:2px solid var(--gold); box-shadow:0 0 20px rgba(255, 158, 100, 0.3);">
                    <p style="font-size:12px; color:#888; margin-top:10px;">QR 코드를 스캔하여 후원해주세요</p>
                    <div style="margin-top:15px; padding:12px; background:rgba(255, 158, 100, 0.2); border:1px solid var(--gold); border-radius:8px;">
                        <p style="font-size:11px; color:#888; margin:0 0 5px 0;">후원 인증 코드:</p>
                        <p style="font-size:18px; color:var(--gold); font-weight:900; margin:0; font-family:'Courier New', monospace; letter-spacing:2px;">LOVEMidnight0108</p>
                    </div>
                </div>
                
                <p style="font-size:11px; color:#888; margin-top:20px; line-height:1.5;">
                    후원해주셔서 감사합니다!<br>
                    여러분의 후원이 게임 개발의 원동력입니다 💜
                </p>
            </div>
        </div>
        <div id="help-modal" class="modal" onclick="if(event.target === this) toggleModal('help-modal')">
            <div onclick="if(!event.target.closest('button') && !event.target.closest('input') && event.target.tagName !== 'BUTTON') toggleModal('help-modal')" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 300px; max-height: 90vh; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px;" id="help-modal-content">
                <h2 style="color:var(--gold); margin-top:0; margin-bottom:15px; cursor:pointer;">🏠 설정 및 가이드</h2>
                <p style="font-size:15px; line-height:1.8; color:#ccc; margin-bottom: 15px; cursor:pointer;">
                    1. <b>🏺 유물 박물관</b>에서 유물을 복원해 수익을 뻥튀기하세요.<br>
                    2. <b>📱 미드나잇 톡</b>에서 주민들의 속마음을 엿보세요.<br>
                    3. <b>🌿 스트레스 해소</b> 태그가 달려있는 건물을 구입 시 스트레스가 감소됩니다.<br>
                    4. 마지막 <b>유토피아 랭크</b>에 도달하면 엔딩!
                </p>
                
                <div style="display:flex; gap:15px; margin: 15px 0; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px; padding: 20px; background: rgba(187, 154, 247, 0.1); border: 1px solid var(--border); border-radius: 12px;">
                        <h3 style="color:var(--accent); font-size:16px; margin:0 0 15px 0; font-weight:800;">⭐ 후원자 명예의 전당</h3>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div style="display:flex; align-items:center; gap:8px; padding:8px 20px; background:rgba(255, 158, 100, 0.15); border:1px solid var(--gold); border-radius:8px; width:100%; box-sizing:border-box;">
                                <span style="font-size:20px;">👑</span>
                                <span style="color:var(--gold); font-weight:800; font-size:15px;">바이퍼</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleModal('donation-modal');" 
                                style="background:var(--gold); color:#000; border:none; padding:12px 20px; border-radius:12px; font-weight:900; cursor:pointer; font-size:14px; width: 100%; margin-top:10px; box-shadow:0 0 15px rgba(255, 158, 100, 0.4); white-space:pre-line; line-height:1.4; box-sizing:border-box; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                            ☕ 개발자에게 커피 한 잔 사주고
    VIP 굿즈 받기
                        </button>
                        
                        <div style="margin-top:15px; padding:15px 20px 12px 20px; background:rgba(187, 154, 247, 0.1); border:1px solid var(--border); border-radius:8px; width:100%; box-sizing:border-box;">
                            <h4 style="color:var(--accent); font-size:13px; margin:0 0 10px 0; font-weight:800; text-align:left;">VIP 인증 코드 입력</h4>
                            <div style="display:flex; gap:8px; margin-bottom:8px; align-items:stretch;">
                                <input type="text" id="vip-code-input-settings" placeholder="인증 코드 입력" 
                                    style="flex:1; background:#1a1a24; border:2px solid var(--accent); color:#fff; padding:10px; border-radius:8px; font-size:13px; font-family:'Pretendard'; outline:none; text-align:center; font-weight:700; box-sizing:border-box; min-width:0;"
                                    onkeypress="if(event.key==='Enter') verifyVIPCodeFromSettings()">
                                <button onclick="event.stopPropagation(); verifyVIPCodeFromSettings();" 
                                        style="background:var(--accent); color:#000; border:none; padding:10px 15px; border-radius:8px; font-weight:900; cursor:pointer; font-size:13px; white-space:nowrap; flex-shrink:0;">
                                    인증
                                </button>
                            </div>
                            <div id="vip-code-status-settings" style="font-size:11px; min-height:18px; margin-top:5px; color:#888; text-align:left;"></div>
                        </div>
                    </div>
                    
                    <div style="flex:1; min-width:200px; padding: 20px; background: rgba(122, 162, 247, 0.1); border: 1px solid var(--border); border-radius: 12px;">
                        <h3 style="color:var(--neon-blue); font-size:16px; margin:0 0 15px 0; font-weight:800;">📊 전체 유저 랭킹</h3>
                        <button onclick="event.stopPropagation(); toggleModal('help-modal'); toggleModal('ranking-modal');" 
                                style="background:var(--neon-blue); color:#000; border:none; padding:12px 20px; border-radius:12px; font-weight:900; cursor:pointer; font-size:14px; width: 100%; margin-bottom:10px;">
                            랭킹 보기
                        </button>
                        <p style="font-size:11px; color:#888; margin:0; text-align:left;">다른 유저들과 랭크를 비교해보세요!</p>
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 20px; background: rgba(80, 250, 123, 0.1); border: 1px solid var(--border); border-radius: 12px;">
                    <h3 style="color:var(--healing); font-size:16px; margin:0 0 15px 0; font-weight:800;">☁️ 클라우드 저장</h3>
                    <div id="auth-status" style="margin-bottom:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px; font-size:13px; color:#aaa;">
                        로그인 상태 확인 중...
                    </div>
                    <div id="auth-buttons" style="display:flex; flex-direction:column; gap:8px;">
                        <!-- 로그인/로그아웃 버튼이 여기에 동적으로 추가됨 -->
                    </div>
                    <p style="font-size:11px; color:#888; margin-top:10px; text-align:left;">Google 로그인으로 데이터를 안전하게 저장하세요!</p>
                </div>
                
                <button onclick="event.stopPropagation(); resetGame();" style="background:var(--danger); color:#fff; border:none; padding:12px 20px; border-radius:12px; font-weight:900; cursor:pointer; font-size:14px; box-shadow:0 0 10px rgba(255, 85, 85, 0.3); width: 100%;">
                    ⚠️ 데이터 초기화 (처음부터)
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // 🔥 Firebase 설정 (필수!)
        // ============================================================
        // Firebase Console (https://console.firebase.google.com)에서 프로젝트를 생성하고
        // Realtime Database를 활성화한 후, 아래 설정값을 입력하세요.
        // 
        // 설정 방법:
        // 1. Firebase Console 접속
        // 2. 프로젝트 생성 (또는 기존 프로젝트 선택)
        // 3. Realtime Database 생성 (테스트 모드로 시작)
        // 4. 프로젝트 설정 > 일반 > 앱 추가 > 웹 앱
        // 5. 아래 firebaseConfig에 복사한 설정값 입력
        // ============================================================
        
        let firebaseApp = null;
        let firebaseDatabase = null;
        let firebaseAuth = null;
        let isFirebaseEnabled = false;
        let currentUser = null;
        
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDAS2-ax-ORpsnGoG6XNsMx3rlQ9yJMkUc",
            authDomain: "midnight-cottage-server.firebaseapp.com",
            databaseURL: "https://midnight-cottage-server-default-rtdb.firebaseio.com",
            projectId: "midnight-cottage-server",
            storageBucket: "midnight-cottage-server.firebasestorage.app",
            messagingSenderId: "680262922046",
            appId: "1:680262922046:web:bd79062e2bf1f20464866f"
        };
        
        // Firebase 초기화
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDatabase = firebase.database();
                firebaseAuth = firebase.auth();
                isFirebaseEnabled = true;
                console.log("✅ Firebase 연결 성공");
                
                // 로그인 상태 감지
                firebaseAuth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        console.log("✅ 로그인됨:", user.email);
                        loadGameFromFirebase();
                    } else {
                        console.log("ℹ️ 로그아웃됨");
                    }
                });
            } else {
                console.warn("⚠️ Firebase 설정이 필요합니다. 랭킹 기능은 로컬 모드로 동작합니다.");
            }
        } catch (e) {
            console.error("❌ Firebase 초기화 실패:", e);
            isFirebaseEnabled = false;
        }
        
        // 게임 버전 (업데이트 시 이 값을 변경하면 자동으로 데이터 초기화)
        const GAME_VERSION = "1.0.0";
        const SAVE_KEY = 'midnight_cottage_v30_hardcore';
        const VERSION_KEY = 'midnight_cottage_version';
        
        // 3. 전역 변수 선언
        const state = {
            money: 0, clickPower: 1, autoIncome: 1, 
            upgrades: [], history: [], artifacts: Array(20).fill(false),
            rank: 1, currentSelectedRank: 1, totalUniquePurchased: 0,
            residents: [], achievements: [], endingSeen: false,
            playerName: '', vipUnlocked: false,
            foodUnlocked: false, // 음식 가판대 해금 여부
            unlockedAchievements: [] // 달성한 업적 ID 목록 (초기화되어도 유지됨)
        };

        // ============================================================
        // ⚠️ 중요: 여기에 기존의 데이터 배열들을 꼭 넣어주세요! ⚠️
        // jobsData, artifactsData, uniqueInfra, rankNames, rankImages, upgrades, achievements
        // (기존 코드에서 복사해서 여기에 붙여넣으세요)
        // ============================================================
        
        // 5. 게임 데이터 및 로직
        const jobEmojis = {
            "화가": "🎨", "소설가": "✍️", "교수": "📚", "리퍼닥": "🛠️",
            "ASMR DJ": "🎧", "모델": "👠", "형사": "🕵️", "넷러너": "💻",
            "라멘노점상": "🍜", "온천주인": "♨️", "LP바 사장님": "💿",
            "뮤지션": "🎸", "고양이": "🐱", "VIP": "👑", "백수": "🛋️"
        };

        const jobsData = {
            "화가": {
                'Solo': ["네온 물감이 몽글몽글해.", "이 색채는 너를 닮았어.", "붓 끝에서 새벽이 피어나.", "캔버스는 아직 미완성이야.", "오늘따라 보라색이 슬퍼 보이네.", "디지털 캔버스는 질감이 부족해.", "꿈에서 본 색깔을 찾고 있어.", "빗물에 번진 도시의 불빛이 최고의 팔레트야.", "내 그림엔 영혼이 부족한 걸까?", "오래된 유화 냄새가 그리워.", "홀로그램 물감은 너무 차가워.", "이 도시의 회색빛이 싫지 않아.", "새로운 영감이 떠오를 것 같아.", "내면의 풍경을 그리고 싶어."],
                'Love': ["네 눈동자 색을 담고 싶어.", "너랑 있으면 세상이 형광빛이야.", "가장 완벽한 색은 너야.", "너는 내 흑백 세상의 유일한 컬러야.", "이 붉은색은 널 향한 내 마음이야.", "너의 미소를 스케치하고 싶어.", "우리 추억을 영원히 박제할 그림을 그릴게.", "너라는 예술작품을 감상 중이야.", "네가 곁에 있으면 붓이 춤을 춰.", "너를 그릴 때가 가장 행복해."],
                'Affair': ["비밀스러운 색이 매혹적이지.", "금지된 선을 넘는 건 짜릿해.", "몰래 그리는 네 초상화가 좋아.", "이 관계는 추상화 같아. 이해하려 들지 마.", "위험한 색깔일수록 더 끌리는 법이지.", "밤에만 허락된 우리의 갤러리.", "너와의 시간은 덧칠된 캔버스 같아.", "아무도 모르는 색으로 널 칠하고 싶어.", "죄책감도 예술의 일부일까?", "훔친 사과가 더 맛있는 법이지."],
                'Stress': ["붓을 꺾어버리고 싶어!", "아무것도 그리기 싫어.", "세상이 온통 회색이야.", "내 그림은 쓰레기야!", "영감이 다 말라버렸어.", "물감 냄새가 역겨워.", "다들 내 예술을 이해 못 해.", "디지털 노이즈 때문에 미치겠어!", "이 놈의 손목 터널 증후군...", "캔버스를 찢어버리고 싶군."]
            },
            "소설가": {
                'Solo': ["문장들이 춤을 추네.", "이 도시의 모든 건 소설감이야.", "엔딩을 어떻게 낼까?", "타자기 소리가 빗소리랑 섞이네.", "플롯이 꼬였어. 인생처럼.", "주인공을 죽여야 할까, 살려야 할까.", "새벽 3시의 감성이 필요해.", "커피가 식었군. 다시 데워야지.", "이 대사는 좀 진부한가?", "사이버펑크 느와르... 이번 신작 장르야.", "독자들은 잔인한 걸 좋아해.", "글자가 벌레처럼 기어 다니는 기분이야.", "클라우드 저장은 필수지.", "오래된 종이책 냄새를 맡고 싶어."],
                'Love': ["너와의 사랑은 베스트셀러야.", "내 소설의 주인공은 너야.", "해피엔딩만 쓰고 싶어.", "어떤 문장으로도 널 다 표현할 수 없어.", "너는 내 인생 최고의 반전이야.", "우리 사랑을 장편 소설로 남길게.", "매일 너라는 페이지를 넘기고 싶어.", "너의 목소리는 시가 되어 내게 박혀.", "로맨스 소설이 왜 팔리는지 알겠어.", "너와 함께 쓰는 이 이야기가 영원하길."],
                'Affair': ["금지된 챕터를 쓰는 기분이야.", "독자는 모르는 우리만의 반전.", "위험한 복선처럼 너에게 끌려.", "비극인 줄 알면서도 페이지를 넘기지.", "이건 편집자 몰래 쓴 외전이야.", "장르가 스릴러로 바뀌고 있어.", "파국으로 치닫는 결말이 더 아름답지.", "숨겨진 문장 속에 널 숨겨둘게.", "우린 잘못된 문법으로 쓰인 문장이야.", "읽으면 안 되는 금서를 펼친 기분."],
                'Stress': ["글자가 벌레처럼 보여!", "원고지 다 불태울 거야!", "내 인생은 실패작이야.", "한 글자도 안 써져!", "마감 독촉 문자 그만 보내!", "내 재능은 여기까지인가 봐.", "키보드를 부숴버리고 싶어.", "스토리가 산으로 가고 있어.", "악플 때문에 미치겠군.", "다들 내 글을 표절이라고 해."]
            },
            "교수": {
                'Solo': ["역사는 반복되지.", "오래된 책 냄새가 좋아.", "2026년은 참 낭만적이었군.", "이 유물은 21세기 초반의 것이야.", "데이터는 거짓말을 하지 않아.", "학생들이 내 수업을 이해할까?", "과거를 알면 미래가 보여.", "도서관의 정적, 그게 내 안식처지.", "논문 심사가 얼마 안 남았어.", "고대인들은 스마트폰이란 걸 썼다지.", "지식의 탐구는 끝이 없군.", "AI가 역사를 가르치는 시대라니.", "커피보다는 차가 좋겠어.", "이 도시의 지하엔 구시대의 유적이 잠들어 있어."],
                'Love': ["너는 역사상 가장 아름다워.", "너를 평생 연구하고 싶어.", "고전 시보다 네가 더 우아해.", "내 인생의 가장 위대한 발견은 너야.", "너와 함께라면 영원도 짧게 느껴지겠군.", "논리적으로 설명할 수 없는 감정이야.", "너는 내 학설을 뒤집는 예외적인 존재야.", "사랑의 역사를 새로 쓰고 싶군.", "너의 지성에 반했어.", "함께 늙어간다는 건 멋진 일이지."],
                'Affair': ["금지된 역사만큼 흥미롭군.", "도덕적 잣대보다 네가 중요해.", "이건 비밀 수업이야.", "윤리학적으로는 틀렸지만, 본능은 널 원해.", "역사에 기록되지 않을 비밀스러운 만남.", "위험한 가설을 검증하는 기분이야.", "이성적으로는 멈춰야 하는데.", "오류인 줄 알면서도 널 선택했어.", "우린 금지된 지식을 탐하는 것과 같아.", "학계에서 매장당할 스캔들이군."],
                'Stress': ["데이터 찌꺼기들! 조용히 해!", "지식은 다 쓸모없어.", "책을 다 찢고 싶군.", "학생들이 말을 너무 안 들어!", "연구비가 삭감됐다니!", "이 멍청한 대학 놈들.", "내 논문을 표절하다니!", "머리가 터질 것 같아.", "세상은 배움이 없어.", "은퇴하고 시골로 가고 싶다."]
            },
            "리퍼닥": {
                'Solo': ["기계는 거짓말 안 해.", "어디 고장 난 곳 없어?", "기름 냄새가 향긋하네.", "나사 하나가 모자란데...", "이 의체는 구형이지만 튼튼해.", "신경 회로가 꼬였군. 재배선 해야겠어.", "납땜질하다 손 데었어.", "오늘따라 손님이 없네. 한가해.", "최신 펌웨어 구하기가 하늘의 별 따기야.", "내 팔도 업그레이드할까?", "고철상에서 보물을 발견했어.", "안드로이드 수리는 섬세함이 생명이지.", "눈알 부품은 비싸게 팔려.", "합선되지 않게 조심해."],
                'Love': ["내 심장 엔진은 너 때문에 돌아가.", "널 위해 최고의 부품을 준비했어.", "너 없으면 난 셧다운이야.", "너의 미소는 내게 최고의 전력 공급원이야.", "고장 난 내 맘을 고쳐준 건 너야.", "너랑 있으면 오버클럭 되는 기분이야.", "내 눈엔 네가 가장 고화질로 보여.", "너를 위해서라면 내 팔다리도 내줄 수 있어.", "우리 사랑은 녹슬지 않아.", "네 심장 박동 소리가 제일 듣기 좋아."],
                'Affair': ["보안 프로토콜을 우회했어.", "위험한 오버클럭 중이야.", "합선될 것처럼 짜릿해.", "보증 기간이 끝난 관계라 더 끌리나 봐.", "불법 튜닝 같은 사랑이지.", "들키면 폐기처분될지도 몰라.", "시스템 경고를 무시하고 널 만나러 왔어.", "회로가 타버려도 좋아.", "이건 매뉴얼에 없는 행동이야.", "위험할수록 성능은 더 좋지."],
                'Stress': ["다 고물상에 버려버려!", "스파크가 튀어! 내 머리도!", "망할 기계 덩어리들.", "손 떨려서 작업 못 하겠어.", "부품 값이 또 올랐어!", "진상 손님 때문에 미치겠군.", "왜 고쳐도 또 고장 나는 거야!", "기름 냄새 이제 지겨워.", "내 인생도 수리가 필요해.", "다 부숴버리고 싶다."]
            },
            "ASMR DJ": {
                'Solo': ["빗소리 들려줄까?", "팅글이 느껴지니?", "오늘 밤은 내 목소리와 함께해.", "마이크 테스트, 원 투.", "구독자가 늘었어. 기분 좋아.", "새로운 마이크를 샀어. 소리가 달라.", "바스락거리는 소리, 정말 좋지 않니?", "오늘 컨셉은 병원놀이.", "불면증엔 내 방송이 최고야.", "속삭이는 연습을 너무 했더니 목이 아파.", "방음 부스가 좀 더 넓었으면.", "이어클리닝 소리는 언제나 인기 많아.", "키보드 타건음 들어볼래?", "새벽 감성이 터지는 시간이야."],
                'Love': ["너에게만 들려주는 속삭임이야.", "네 숨소리가 최고의 ASMR이야.", "우리 주파수는 일치해.", "매일 밤 너를 위해 자장가를 불러줄게.", "네 목소리는 꿀처럼 달콤해.", "너의 심장 소리를 녹음하고 싶어.", "사랑한다는 말, 귓가에 속삭여줄게.", "너는 나만의 청취자야.", "네가 곁에 있으면 마음이 편안해져.", "너와의 대화는 팅글 그 자체야."],
                'Affair': ["마이크 끄고 비밀 얘기할까?", "방송 사고 같은 사랑이야.", "남들은 모르는 시그널.", "비밀 채널에서만 만나는 사이.", "이 목소리는 너만 들을 수 있어.", "위험한 수위의 대화.", "녹음되면 안 되는 이야기들.", "잡음 섞인 관계가 더 자극적이야.", "내 방송 뒤편엔 네가 있어.", "금지된 주파수를 맞추는 기분."],
                'Stress': ["소리 지르고 싶어!", "이명이 들려, 괴로워.", "모든 소음이 끔찍해.", "악플러들 다 차단해버릴 거야!", "마이크가 고장 났어! 젠장!", "목소리가 안 나와.", "이웃집 개 짖는 소리 좀 안 나게 해라!", "조회수가 왜 이렇게 떨어졌지?", "편집하기 귀찮아 죽겠어.", "세상이 너무 시끄러워."]
            },
            "모델": {
                'Solo': ["오늘 내 크롬 광택 완벽해?", "플래시 세례는 지겨워.", "이 거리는 내 런웨이야.", "다이어트는 내일부터.", "신상 의체가 나왔다던데.", "화보 촬영 스케줄이 꽉 찼어.", "거울 속의 내가 제일 예뻐.", "사람들의 시선이 느껴져.", "패션은 돌고 도는 거야.", "하이힐은 발이 너무 아파.", "오늘 메이크업 좀 잘 된 듯?", "잡지 표지 모델이 됐어.", "파파라치들 좀 따돌려줘.", "워킹 연습을 더 해야 해."],
                'Love': ["나보다 네가 더 빛나.", "우리 투샷은 화보 그 자체야.", "너만의 뮤즈가 될게.", "어떤 명품보다 네가 더 가치 있어.", "너랑 있으면 내가 더 예뻐 보여.", "카메라 렌즈보다 네 눈이 더 좋아.", "내 인생 최고의 파트너는 너야.", "너를 위해 포즈를 취할게.", "화려한 조명보다 너의 미소가 눈부셔.", "패션의 완성은 너와 함께 있는 나."],
                'Affair': ["스캔들? 상관없어.", "카메라 뒤에서 만나는 게 좋아.", "위험할수록 더 스타일리시해.", "비밀 연애가 트렌드라며?", "호텔 로비에서 마주치지 않게 조심해.", "우린 베스트 커플상을 받긴 글렀어.", "쇼윈도 뒤의 진실은 우리만 알지.", "화려함 속에 감춰진 비밀.", "플래시가 터질 때보다 더 짜릿해.", "이 관계는 한정판 에디션이야."],
                'Stress': ["내 얼굴 보지 마!", "조명 다 꺼버려!", "다들 나를 껍데기로만 봐.", "살쪘어... 최악이야.", "피부 트러블 났어! 촬영 취소해!", "디자이너가 옷을 그따위로 만들다니.", "악플 때문에 우울해.", "나이 드는 게 무서워.", "성형 부작용인가? 얼굴이 땡겨.", "다 가식적인 인간들뿐이야."]
            },
            "형사": {
                'Solo': ["비 내리는 거리는 증거를 감추지.", "합성 담배 연기가 맵군.", "직감이 왔어.", "잠복근무는 지루해.", "이 도시는 잠들지 않는군.", "범인은 현장에 다시 나타난다.", "커피가 너무 쓰네.", "사건 파일이 산더미야.", "정의는 살아있나?", "오늘도 야근이군.", "낡은 코트가 축축해.", "총기 손질이나 해야지.", "정보원 녀석, 믿을 수가 있어야지.", "네온 사인 불빛이 어지러워."],
                'Love': ["넌 내가 찾던 마지막 퍼즐이야.", "네가 범인이라면 체포당해줄게.", "내 총구는 널 지키기 위해서만 들어.", "내 수갑은 너랑 연결되고 싶어서 있는 거야.", "너라는 사건, 평생 수사하고 싶군.", "위험한 일엔 휘말리지 마.", "내가 너의 보디가드가 되어줄게.", "증거물 1호, 내 마음을 제출하지.", "너와 함께라면 잠복근무도 데이트야.", "취조실 말고 카페에서 널 보고 싶어."],
                'Affair': ["잠복근무 핑계 대고 나왔어.", "이 관계는 일급 기밀이야.", "증거를 남기지 마.", "내부 감찰이 들어오면 끝장이야.", "범죄와의 전쟁보다 네가 더 어려워.", "우린 공범이나 다름없어.", "비밀 안전가옥에서 만나.", "경찰차가 지나갈 때마다 가슴이 뛰어.", "법을 어기는 기분이 이런 건가.", "알리바이는 확실히 만들어 둬."],
                'Stress': ["이 도시는 썩었어.", "범인도 정의도 다 지겨워.", "머리가 깨질 것 같군.", "서장님 잔소리 좀 그만!", "범인을 놓쳤어! 젠장!", "증거가 오염됐어.", "내 파트너는 멍청이야.", "술 없이는 잠을 못 자겠어.", "다 때려치우고 싶다.", "세상은 안 바뀌어."]
            },
            "넷러너": {
                'Solo': ["아이스를 뚫는 건 식은 죽 먹기지.", "현실보다 네트워크가 편해.", "데이터 흐름이 아름다워.", "로그아웃은 없어.", "내 뇌는 클라우드랑 연결돼 있어.", "방화벽? 종이 쪼가리일 뿐.", "새로운 바이러스를 만들었어.", "정보는 곧 힘이야.", "키보드 두드리는 소리가 내 심장박동이야.", "가상현실 아바타가 더 잘생겼어.", "현실의 육체는 짐일 뿐이지.", "다크웹에서 쇼핑 좀 했어.", "보안 코드가 너무 쉬워.", "해킹 툴 업데이트 완료."],
                'Love': ["네 뇌와 동기화하고 싶어.", "내 방화벽을 해제할 유일한 사람.", "넌 내 최고의 알고리즘이야.", "너와의 연결 속도는 무한대야.", "네 마음을 해킹하고 싶어.", "내 데이터베이스는 온통 네 사진뿐이야.", "바이러스처럼 내 맘에 침투했어.", "너는 완벽한 코드야.", "가상세계에서도 널 찾아낼 거야.", "백업 데이터가 없어도 널 기억할게."],
                'Affair': ["백도어로 몰래 접속했어.", "로그는 전부 삭제할게.", "바이러스처럼 치명적이야.", "보안 경고를 무시하고 연결했어.", "암호화된 채널에서만 대화해.", "들키면 계정 삭제야.", "시스템 오류인 줄 알면서도 널 원해.", "위험한 프로토콜을 실행 중이야.", "우리 관계는 버그 투성이야.", "접속 기록을 남기지 마."],
                'Stress': ["뇌가 타버릴 것 같아!", "연결 끊어! 강제 로그아웃!", "노이즈 때문에 미치겠어.", "핑이 왜 이렇게 튀어?", "해킹 실패... 역공당했어.", "키보드에 커피 쏟았어!", "서버가 다운됐다고?", "눈이 침침해. 블루라이트 때문인가.", "내 코드를 누가 훔쳐갔어!", "현실 감각이 없어지고 있어."]
            },
            "라멘노점상": {
                'Solo': ["육수 끓는 냄새, 끝내주지?", "따뜻한 국물 한 그릇 하고 가.", "오늘도 손님이 많네.", "차슈 추가는 필수야.", "면발이 탱글탱글해.", "비법 소스는 며느리도 몰라.", "네온 불빛 아래서 먹는 라멘 맛.", "설거지거리가 산더미네.", "재료가 다 떨어져 가.", "단골손님이 또 왔군.", "국물 맛이 변하면 안 되는데.", "파를 송송 썰어 넣어야지.", "뜨거우니까 호호 불어 먹어.", "라멘 한 그릇에 인생이 담겨 있지."],
                'Love': ["너한텐 차슈 무제한이야.", "국물보다 네 마음이 더 따뜻해.", "평생 라멘 만들어줄게.", "내 라멘 육수처럼 진한 사랑이야.", "너는 내 라멘의 화룡점정.", "함께 국수를 삶으며 늙어가고 싶어.", "너를 위한 특제 메뉴를 개발했어.", "맛있게 먹는 모습만 봐도 배불러.", "너의 빈 그릇이 나를 웃게 해.", "뜨거운 국물처럼 식지 않을게."],
                'Affair': ["셔터 내리고 몰래 만날까?", "매운맛보다 더 화끈하네.", "육수 식기 전에 빨리 와.", "손님들 눈 피해서 주방 뒤로 와.", "비밀 레시피처럼 숨겨진 관계.", "뜨거운 냄비 앞에서 위험한 장난.", "다른 손님한텐 비밀이야.", "브레이크 타임은 우리만의 시간.", "입천장 데일 만큼 위험해.", "배달 가는 척하고 너 보러 갈게."],
                'Stress': ["육수 엎어버리고 싶다.", "손님들 다 나가라고 해!", "면이 다 불어터졌어.", "가스비가 왜 이렇게 많이 나와?", "진상 손님이 그릇 깼어!", "재료 상한 것 같아.", "하루 종일 서 있었더니 다리 아파.", "장사 안 돼서 파리 날리네.", "옆집 라멘집이 더 싸다니.", "더워서 쪄 죽겠어."]
            },
            "온천주인": {
                'Solo': ["물 온도가 딱 좋아.", "피로가 싹 풀릴 거야.", "유황 냄새, 익숙해지면 좋아.", "수건은 넉넉히 챙겨.", "때밀이 기계 도입했어.", "온천 달걀 드실 분?", "노천탕에서 별 보면 끝내주지.", "물청소하는 게 제일 힘들어.", "손님, 거기서 다이빙 금지입니다.", "원숭이가 또 들어왔네.", "피부 미용에 최고야.", "사우나 온도 좀 올릴까?", "목욕 후엔 바나나 우유지.", "카운터 보느라 졸리다."],
                'Love': ["너랑 혼욕... 농담이야.", "내 마음도 온천처럼 뜨거워.", "넌 내 온천의 꽃이야.", "피로한 너를 내가 씻겨주고 싶어.", "너만 보면 내 얼굴이 홍당무가 돼.", "따뜻한 물속에서 널 안고 싶어.", "너의 피부결은 비단 같아.", "우리 사랑은 식지 않는 온천수 같아.", "매일 밤 너를 기다려.", "온천보다 네 품이 더 따뜻해."],
                'Affair': ["탈의실 뒤쪽에서 봐.", "습기 때문에 얼굴이 빨개졌어.", "위험한 온도가 되고 있어.", "손님 없을 때 몰래 들어와.", "김 서린 창문 틈으로 훔쳐보지 마.", "물 밑에서 손 잡을까?", "열기 때문인지, 너 때문인지 어지러워.", "비밀스러운 탕에서의 밀회.", "누가 들어올까 봐 조마조마해.", "젖은 머리카락이 섹시해."],
                'Stress': ["물 다 빼버려!", "손님들 너무 시끄러워.", "머리가 핑 도네.", "누가 탕에 오줌 쌌어!", "수건 훔쳐가지 마세요!", "보일러 고장 났어. 망했다.", "청소하기 싫어 죽겠네.", "진상 손님이 안 나가.", "수도세 폭탄 맞았어.", "습기 때문에 곰팡이 폈어."]
            },
            "LP바 사장님": {
                'Solo': ["이 곡은 20세기 명곡이지.", "재즈가 흐르는 밤이야.", "위스키 한 잔 줄까?", "LP판 튀는 소리가 매력이야.", "신청곡 받습니다.", "볼륨 좀 높일까?", "오늘 분위기 쥑이네.", "단골손님이 팁을 주고 갔어.", "턴테이블 바늘 바꿔야겠다.", "먼지 쌓인 레코드를 닦아.", "음악은 영혼을 치유하지.", "가게 조명이 너무 어둡나?", "칵테일 쉐이킹 연습 중이야.", "옛날 노래가 역시 좋아."],
                'Love': ["이 노래는 널 위한 거야.", "너의 목소리가 최고의 음악이야.", "우리 사랑을 레코드에 담고 싶어.", "너와 춤추고 싶은 밤이야.", "네 눈동자에 건배.", "너는 나의 영원한 명반이야.", "사랑 노래 가사가 다 내 얘기 같아.", "너를 위해 가게 문을 일찍 닫을게.", "리듬에 맞춰 너에게 갈게.", "내 인생의 BGM은 너야."],
                'Affair': ["가게 문 잠그고 시작할까?", "비밀스러운 리듬을 타보자.", "금지된 곡을 트는 기분이야.", "어두운 조명 아래서 은밀하게.", "음악 소리에 우리 소리를 묻어봐.", "위스키보다 독한 너.", "아무도 없는 바에서 둘만의 파티.", "죄책감 섞인 칵테일 맛.", "볼륨을 높여, 아무도 못 듣게.", "흔들리는 조명, 흔들리는 우리."],
                'Stress': ["음악 꺼! 조용히 해!", "술병 다 깨버리고 싶군.", "이따위 싸구려 음악 안 틀어.", "진상 손님이 토했어!", "LP판 기스 났어! 으악!", "저작권료 왜 이렇게 비싸?", "손님이 한 명도 없네.", "스피커 터졌어.", "술 취해서 난동 부리지 마!", "신청곡 작작 좀 해."]
            },
            "뮤지션": {
                'Solo': ["새로운 코드가 떠올랐어.", "내 기타 솔로 어때?", "이 도시는 내 무대야.", "버스킹 하러 나갈까?", "가사가 안 써지네.", "팬들이 기다리고 있어.", "악기 튜닝 좀 해야겠다.", "내 음악으로 세상을 바꿀 거야.", "오늘 공연은 매진이야.", "손가락에 물집 잡혔어.", "거리의 소음도 음악이 되지.", "새벽 연습은 힘들어.", "기타 줄이 또 끊어졌네.", "이번 앨범 대박 날 거야."],
                'Love': ["널 위한 세레나데를 만들었어.", "네 심장 박동에 템포를 맞출게.", "넌 내 영감의 원천이야.", "너의 이름으로 노래를 지을게.", "내 모든 러브송의 주인공은 너야.", "너를 연주하고 싶어.", "무대 위에서 너만 보여.", "너의 목소리는 천상의 화음이야.", "평생 너만을 위해 노래할게.", "기타 대신 너를 안고 싶어."],
                'Affair': ["백스테이지에서 몰래 봐.", "이건 앵콜 없는 공연이야.", "위험한 락앤롤이지.", "팬들 몰래 너랑 도망칠까?", "금지된 노래를 부르는 기분.", "스캔들이 터져도 상관없어.", "악기 케이스에 숨어서 들어와.", "조명이 꺼지면 우린 자유야.", "오늘 밤은 그룹 그루피가 되어줘.", "비밀스러운 합주."],
                'Stress': ["기타 줄 다 끊어버렸어.", "악상이 안 떠올라!", "다들 내 음악을 모욕해.", "표절 시비라니 말도 안 돼!", "목이 쉬어서 소리가 안 나.", "멤버랑 싸웠어. 해체할 거야.", "관객 반응이 왜 이래?", "악플 보다가 밤샜어.", "음향 장비가 엉망이야.", "소속사 노예 계약 지긋지긋해."]
            },
            "고양이": {
                'Solo': ["야옹. (밥 줘.)", "고롱고롱... (만족)", "식빵 굽는 중이야.", "높은 곳이 좋아.", "박스다! 내 거야.", "그루밍 하느라 바빠.", "창밖의 새를 구경 중이야.", "낮잠이나 자야지.", "벌레 잡았다!", "스크래쳐 긁는 소리 좋지?", "내 꼬리 잡기 놀이 중.", "닝겐, 나 좀 봐라.", "햇볕이 따뜻해.", "다 비켜, 내가 왕이야."],
                'Love': ["야아옹~ (너한테 부비적)", "골골송 부르는 중이야.", "너 배 위가 제일 따뜻해.", "꾹꾹이 해줄게.", "너에게만 배를 보여줄게.", "머리 들이밀기 공격!", "내 사냥감(쥐)을 선물로 줄게.", "너랑 자는 게 좋아.", "나 예뻐해 줘.", "너는 꽤 쓸만한 집사야."],
                'Affair': ["캬옹! (다른 집사 냄새가 나!)", "살금살금 밤마실 다녀올게.", "몰래 츄르 훔쳐먹었어.", "비밀 친구가 생겼다옹.", "옆집 고양이랑 눈 맞았어.", "밤새 지붕 위에서 데이트했지.", "네가 잠든 사이에 파티다.", "도둑고양이 취급하지 마.", "다른 집 가서 밥 얻어먹고 왔어.", "내 영역 표시를 해뒀지."],
                'Stress': ["하악!! (건들지 마!)", "캬아아악! (저리 가!)", "꼬리 펑! 털 쭈뼛!", "발톱으로 다 긁어버릴 거야!", "목욕하기 싫어! 놓으라고!", "병원 가는 거 눈치챘다!", "맛없는 사료 주지 마.", "화장실이 더러워.", "귀찮게 하지 마.", "문 열어! 문 열어!"]
            },
            "VIP": {
                'Solo': ["얼마면 돼? 다 사주지.", "여기가 펜트하우스인가?", "샴페인 가져와.", "경치가 제법이군.", "내 주식이 또 올랐어.", "돈으로 행복을 살 수 있지.", "서민 체험 중이야.", "이 건물, 내가 살까?", "비서, 일정 비워.", "최고급 시가를 피우는 중.", "내 전용기가 도착했군.", "골프나 치러 갈까.", "파티는 언제 시작하지?", "내 이름 모르는 사람도 있나?"],
                'Love': ["이 도시를 너에게 줄게.", "다이아몬드보다 네가 빛나.", "내 재산목록 1호는 너야.", "너를 위해 백화점을 통째로 빌렸어.", "돈 보고 접근한 게 아니길 바래.", "내 옆자리는 비싸지만 너에겐 공짜야.", "너와 함께라면 펜트하우스도 필요 없어.", "내 유산 상속자는 너야.", "사랑의 값어치는 매길 수 없지.", "너에게 최고급만 주고 싶어."],
                'Affair': ["비밀 계약서에 사인해.", "호텔 스위트룸 잡아놨어.", "돈으로 살 수 없는 스릴이군.", "스캔들 기사 막느라 돈 좀 썼지.", "내 와이프/남편 몰래 만나는 거야.", "비밀 유지 서약서는 필수야.", "비즈니스 미팅이라고 둘러대.", "전용기 안에서 몰래...", "돈다발로 입막음하면 돼.", "위험한 투자가 수익률이 높지."],
                'Stress': ["다 해고해! 멍청이들!", "내 주식이 폭락했어!", "서비스가 엉망이군. 고소할 거야!", "세무조사가 나왔어! 젠장!", "내 돈 떼어먹고 도망갔어?", "스트레스 받아서 쇼핑해야겠어.", "가난한 냄새나, 저리 가.", "왜 내 맘대로 안 되는 거야!", "돈이 썩어나는데 쓸 데가 없네.", "믿을 놈 하나 없어."]
            },
            "백수": {
                'Solo': ["오늘도 할 일이 없네.", "소파가 내 직장이야.", "일하는 사람들 부럽지 않아.", "시간은 많지만 돈은 없어.", "오늘 뭐 하지? 아무것도 안 하지.", "구직 사이트는 내일 볼게.", "누워서 하늘 보는 게 최고야.", "일할 생각만 해도 피곤해.", "내 인생은 휴식 모드야.", "스트레스 없는 삶이 최고지.", "다들 바쁘게 살지, 나는 편하게 살래.", "오늘도 아무것도 안 했어. 만족스러워.", "일하는 게 전부는 아니야.", "내 시간은 내가 정해."],
                'Love': ["너랑 같이 아무것도 안 하는 게 최고야.", "일할 시간에 널 보는 게 더 가치 있어.", "너와 함께라면 백수도 행복해.", "우리 같이 게으르게 늙어가자.", "일하는 사람들 부럽지 않아, 너가 있으니까.", "너는 내 인생의 유일한 일정이야.", "함께 누워서 시간을 낭비하고 싶어.", "일보다 널 선택했어.", "너와의 시간은 아무것도 안 해도 소중해.", "백수지만 널 사랑하는 건 진심이야."],
                'Affair': ["일하는 척하고 널 만나러 왔어.", "아무도 모르게 우리만의 시간.", "위험한 건 일하는 척하는 거야.", "비밀스러운 게으름이 더 짜릿해.", "일하는 사람들 눈 피해서 만나자.", "이 관계는 내 인생의 유일한 활동이야.", "일할 시간에 널 만나는 게 더 중요해.", "아무도 모르는 우리의 게으름.", "일하는 척하고 도망쳐서 널 봤어.", "위험할수록 더 재밌지 않아?"],
                'Stress': ["일자리 찾기 싫어!", "다들 나를 게으르다고 해.", "일하라는 압박이 스트레스야.", "돈이 없어서 불안해.", "구직 면접 가기 싫어.", "일하는 사람들 부러워.", "내가 뭘 잘못한 거야?", "일할 의욕이 전혀 없어.", "다들 바쁘게 살아서 외로워.", "일하지 않는다고 무가치한 건 아니야."]
            }
        };

        const artifactsData = [
            { name: "구형 아이폰", emoji: "📱", desc: "2026년 인류가 엄지손가락으로 세상을 지배하던 마법 도구." },
            { name: "무선 이어폰", emoji: "🫛", desc: "콩처럼 생겼으며, 고대인들은 이를 귀에 꽂고 신호를 수신했다." },
            { name: "실물 카드", emoji: "💳", desc: "플라스틱 조각 하나로 모든 가치를 교환하던 시대의 산물." },
            { name: "컵라면 용기", emoji: "🍜", desc: "3분 만에 신들의 음식을 연성해내던 고대 연금술 용기." },
            { name: "유선 마우스", emoji: "🖱️", desc: "꼬리가 달린 쥐 모양의 장치. 2202년엔 뇌파가 대신한다." },
            { name: "지폐 뭉치", emoji: "💵", desc: "종이 쪼가리에 가치를 부여했던 인류의 집단 믿음의 증거." },
            { name: "종이 책", emoji: "📖", desc: "데이터가 아닌 실제 나무를 얇게 썰어 정보를 기록하던 낭만." },
            { name: "안경", emoji: "👓", desc: "시각 데이터를 교정하기 위해 얼굴에 걸치던 물리적 보정 장치." },
            { name: "열쇠 꾸러미", emoji: "🔑", desc: "물리적인 문을 열기 위해 들고 다니던 쇳조각들." },
            { name: "구형 게임기", emoji: "🎮", desc: "2026년 사람들이 가상 세계로 도피하던 작은 창구." },
            { name: "낡은 콤팩트 디스크", emoji: "💿", desc: "2026년 음악을 물리적으로 기록하던 반짝이는 원판." },
            { name: "아날로그 탁상시계", emoji: "⏰", desc: "바늘이 움직이며 물리적으로 시간을 가리키던 기계." },
            { name: "수동 성냥갑", emoji: "🕯️", desc: "마찰을 통해 불꽃을 만들어내던 2026년의 원시적 도구." },
            { name: "일회용 필름 카메라", emoji: "📸", desc: "결과물을 즉시 확인할 수 없어서 더 소중했던 기록기." },
            { name: "USB 메모리 칩", emoji: "💾", desc: "데이터를 물리적 조각에 담아 운반하던 번거로운 시대의 산물." },
            { name: "노란 포스트잇", emoji: "📝", desc: "디지털 메모 대신 종이에 적어 붙여놓던 고대인의 기록법." },
            { name: "철제 스테이플러", emoji: "🖇️", desc: "종이 뭉치를 물리적으로 고정하던 작고 강한 사무 도구." },
            { name: "대나무 부채", emoji: "🪭", desc: "직접 팔을 흔들어 바람을 만들던 2026년의 낭만적인 냉방 장치." },
            { name: "건전지식 플래시", emoji: "🔦", desc: "전기 에너지를 직접 휴대하며 어둠을 밝히던 유물." },
            { name: "500원 동전", emoji: "🪙", desc: "금속 조각에 가치를 담아 거래하던 시대의 마지막 화폐 중 하나." }
        ];

        const uniqueInfra = [
            {n: "낡은 네온사인 수리", h: false}, {n: "길거리 자판기 충전", h: false}, {n: "합성 라면 가판대", h: false},
            {n: "빈티지 레코드 샵", h: false}, {n: "심야 꼬치구이 집", h: false}, {n: "신경 동기화 액세서리 샵", h: false},
            {n: "구역 베이커리 '새벽'", h: false}, {n: "영혼 기억 백업 저장소", h: false}, {n: "네온 타코야키 노점", h: false},
            {n: "글로우 달콤한 푸딩 카페", h: true}, {n: "인공 비 정화 장치", h: false}, {n: "몽글몽글 귀청소 센터", h: true},
            {n: "무인 세탁 라운지", h: false}, {n: "사이버웨어 전용 안마소", h: true}, {n: "합성 물담배(시샤) 라운지", h: true},
            {n: "소형 안드로이드 수리소", h: false}, {n: "심야 합성 약국", h: false}, {n: "나노 문신 타투 아틀리에", h: false},
            {n: "피어싱 & 크롬 커스텀 샵", h: false}, {n: "사이버 근육 물리치료실", h: true}, {n: "네온 라이브 하우스", h: false},
            {n: "스트레스 뇌청소 샵", h: true}, {n: "유기농 아로마 사우나", h: true}, {n: "수면 유도 ASMR 룸", h: true},
            {n: "미드나잇 독립 시네마", h: false}, {n: "네온 대중 목욕탕", h: false}, {n: "24시 편의점 '네온'", h: false},
            {n: "데이터 칩 중고 서점", h: false}, {n: "레트로 게임 오락실", h: false}, {n: "사이버웨어 정밀 검진소", h: false},
            {n: "하늘을 나는 바이크 계류장", h: false}, {n: "홀로그램 액세서리 샵", h: false}, {n: "심야 만화 카페", h: true},
            {n: "구역 작은 미술관", h: true}, {n: "공중 정원 티룸", h: true}, {n: "네온 핀볼 센터", h: false},
            {n: "하늘을 나는 자동차 전용 주차장", h: false}, {n: "데이터 슬롯 노래방", h: false}, {n: "가상현실 테마 룸", h: true},
            {n: "사이버 펫 용품점", h: true}, {n: "천연 합성 온천 (Premium)", h: true}, {n: "크롬 시민 전용 휴식처 '생츄어리'", h: true},
            {n: "네온 피트니스 클럽", h: false}, {n: "수중 마사지 풀", h: true}, {n: "피부 재생 에스테틱", h: true},
            {n: "바이오 산소 캡슐", h: true}, {n: "향초 & 디퓨저 전문점", h: true}, {n: "기억 조각 홀로그램 샵", h: true},
            {n: "명상 & 요가 센터", h: true}, {n: "수면 보조제 약방", h: true}, {n: "지하 상가 라멘 투어", h: false},
            {n: "블루 오션 리조트", h: true}, {n: "사이버 만두 장인", h: false}, {n: "심야 딤섬 전문관", h: false},
            {n: "인공 고기 버거 하우스", h: false}, {n: "코티지 로컬 매거진 지부", h: false}, {n: "코인 런더리 & 북카페", h: true},
            {n: "골목길 빈티지 옷가게", h: false}, {n: "네온 신발 편집샵", h: false}, {n: "사이버 꽃 정원", h: true},
            {n: "지능형 방범 드론 허브", h: false}, {n: "퍼스널 컬러 진단실", h: false}, {n: "네온 네일 아트 아뜰리에", h: true},
            {n: "사이버 메이크업 센터", h: true}, {n: "영혼 기억 클라우드 센터", h: false}, {n: "중고 호버 바이크 샵", h: false},
            {n: "자율 주행 택시 승강장", h: false}, {n: "구역 공유 주차 타워", h: false}, {n: "비행선 투어 예약처", h: false},
            {n: "도시 통합 환승 센터", h: false}, {n: "5성급 프리미엄 테크 호텔", h: true}, {n: "빛바랜 센트럴 에비뉴 플라자", h: true},
            {n: "에너지 회수 발전 단지", h: false}, {n: "수경 재배 네온 온실", h: true}, {n: "지중열 난방 시스템", h: false},
            {n: "바이오 나노 재생 센터", h: true}, {n: "대규모 네온 쇼핑몰", h: false}, {n: "메가 코퍼레이션 컴퍼니", h: false},
            {n: "도시 혈관 물류망", h: false}, {n: "고고도 드론 보급로", h: false}, {n: "바이오 에너지 식물원", h: true},
            {n: "코티지 마인드 관제 센터", h: false}, {n: "하이퍼루프 센터", h: false}, {n: "우주 항공 센터", h: false},
            {n: "코티지 타워 건설", h: false}, {n: "은하수 관측 타워", h: false}, {n: "심야 위성 주파수 전송국", h: false},
            {n: "환경 회복 가속 센터", h: true}, {n: "기억 보관 은행", h: false}, {n: "인간-기계 협력 센터", h: false},
            {n: "테라포밍 시뮬레이션 랩", h: true}, {n: "오메가 인프라 망", h: false}, {n: "알파 시티 연산 센터", h: false},
            {n: "신세계 관문", h: false}, {n: "2026년식 아날로그 햇살 창문", h: true}, {n: "낡은 공용 산소 충전소", h: true},
            {n: "심야의 팅글 ASMR 헤어샵", h: true}, {n: "연극이 끝난 후의 소극장", h: true}, {n: "저궤도 별똥별 유도 장치", h: false},
            {n: "미드나잇 유토피아", h: true}
        ];

        const rankNames = [
            "소박하고 아늑한 사이버펑크 방", 
            "심야의 코인 세탁소", 
            "라디오 스튜디오", 
            "네온 아틀리에", 
            "빗속의 투명 버스 정류장", 
            "작가와 교수의 서재", 
            "야간 열차의 일등석", 
            "합성 라면 가판대", 
            "기억 속 놀이터", 
            "리퍼닥의 정비소", 
            "네온 루프탑 수영장", 
            "별이 쏟아지는 다락방", 
            "홀로그램 점술집", 
            "기억의 서재", 
            "포토 그래퍼의 암실", 
            "폐역의 비밀 정원", 
            "비 내리는 테라스", 
            "올드 아메리칸 다이너", 
            "빈티지 레코드 샵", 
            "지붕 위 정원", 
            "해질녘의 교실", 
            "숲 속 사우나", 
            "크롬 온천실", 
            "LP바", 
            "우주 정거장의 전망대", 
            "펜트하우스의 만찬", 
            "심해의 네온 수족관", 
            "쇼와 레트로 킷사텐", 
            "몰소프트 레스토랑", 
            "디스트릭트 쿼터", 
            "데이터 하이웨이", 
            "갤럭시 시티", 
            "골든 선셋 시티", 
            "유토피아 미드나잇 코티지", 
            "고양이 카페", 
            "베이퍼웨이브 신전", 
            "머나먼 야자수의 휴양지"
        ];
        const rankImages = [
            "https://i.imgur.com/MuFQQ5A.png", 
            "https://i.imgur.com/AnG14IK.png", 
            "https://i.imgur.com/2Sz2iYA.png", 
            "https://i.imgur.com/1nAnNIb.png", 
            "https://i.imgur.com/016vCzS.png", 
            "https://i.imgur.com/eqwGBhl.png", 
            "https://i.imgur.com/nVLZxvP.png", 
            "https://i.imgur.com/J5mjTBn.png", 
            "https://i.imgur.com/fqVxhUO.png", 
            "https://i.imgur.com/br0HdSG.png", 
            "https://i.imgur.com/p5H4Vk8.png", 
            "https://i.imgur.com/9ApIszS.png", 
            "https://i.imgur.com/SRftF7H.png", 
            "https://i.imgur.com/a66LTMy.png", 
            "https://i.imgur.com/3qXyDTr.png", 
            "https://i.imgur.com/N9Vop5t.png", 
            "https://i.imgur.com/aI6UVY2.png", 
            "https://i.imgur.com/qGcoNlQ.png", 
            "https://i.imgur.com/QMSpzfL.png", 
            "https://i.imgur.com/PwZ6vm3.png", 
            "https://i.imgur.com/cemXHYi.png", 
            "https://i.imgur.com/S4yBFXT.png", 
            "https://i.imgur.com/A0HQ7e3.png", 
            "https://i.imgur.com/qeB68bj.png", 
            "https://i.imgur.com/UJHXG4V.png", 
            "https://i.imgur.com/RoQeLG8.png", 
            "https://i.imgur.com/uPQ7M32.png", 
            "https://i.imgur.com/oK5IQ91.png", 
            "https://i.imgur.com/vuNzL4d.png", 
            "https://i.imgur.com/P1SjHGR.png", 
            "https://i.imgur.com/tApbEin.png", 
            "https://i.imgur.com/ylCZJyn.png", 
            "https://i.imgur.com/vA1hKCT.png", 
            "https://i.imgur.com/ecGrFrH.png", 
            "https://i.imgur.com/Oj4oY9l.png", 
            "https://i.imgur.com/JztQMEX.png", 
            "https://i.imgur.com/vO7T8t1.png"
        ];
        const VIP_ROOM_START_INDEX = 34; // VIP 방 시작 인덱스 (0-based이므로 34 = 35번째)
        const VIP_CODE = "LOVEMidnight0108";
        
        // 길거리 음식 메뉴
        const foodMenu = [
            { name: "뜨끈한 오뎅 국물", price: 500, icon: "🍵", desc: "돈 없을 땐 국물이지. 얼어붙은 뇌가 녹아내려." },
            { name: "노릇한 구운 주먹밥", price: 400, icon: "🍙", desc: "간장 소스를 발라 불에 구웠어. 고소한 냄새가 배를 채워줘." },
            { name: "눅눅한 붕어빵", price: 500, icon: "🐟", desc: "합성 팥 앙금이 들어있어. 좀 식었지만 달달해." },
            { name: "플라즈마 군고구마", price: 200, icon: "🍠", desc: "공업용 토치로 구워서 겉이 좀 탔어. 호호 불어 먹어." },
            { name: "마가린 토스트", price: 300, icon: "🍞", desc: "설탕 반, 마가린 반. 몸에는 나쁘지만 정신엔 좋아." },
            { name: "네온 튀김 만두", price: 800, icon: "🥟", desc: "재생 기름으로 튀겼지만 바삭함은 진짜야." },
            { name: "미지근한 캔맥주", price: 400, icon: "🍺", desc: "냉장고가 고장 나서 시원하진 않아. 그래도 취해." },
            { name: "정체불명 고기 꼬치", price: 1000, icon: "🍢", desc: "닭고기? 비둘기? 묻지 말고 먹어. 소스 맛이니까." },
            { name: "베이직 합성 라면", price: 1500, icon: "🍜", desc: "가장 싼 면발, 가장 싼 스프. 하지만 이게 제일 맛있지." }
        ];

        const upgrades = uniqueInfra.map((item, i) => ({
            id: `up${i}`, name: item.n,
            basePrice: Math.floor(15 * Math.pow(1.4, i)), 
            power: Math.floor(1 * Math.pow(1.2, i)), 
            type: i % 2 === 0 ? 'auto' : 'click', isHealing: item.h
        }));

        const achievements = [
            { id: 'cat', name: '냥이 월드', icon: '🐱', desc: '모든 주민이 고양이입니다.', unlocked: false, check: s => s.residents.length > 2 && s.residents.every(r => r.job === '고양이') },
            { id: 'drama', name: '사랑과 전쟁', icon: '💔', desc: '불륜 관계가 발생했습니다.', unlocked: false, check: s => s.residents.some(r => r.relType === '불륜') },
            { id: 'rich', name: '백만장자', icon: '💰', desc: '소지금 1,000,000 돌파.', unlocked: false, check: s => s.money >= 1000000 },
            { id: 'solo', name: '솔로 천국', icon: '🧘', desc: '5명 모두 솔로입니다.', unlocked: false, check: s => s.residents.length === 5 && s.residents.every(r => r.relType === '솔로') },
            { id: 'stress', name: '번아웃', icon: '🔥', desc: '주민 평균 스트레스 90% 이상.', unlocked: false, check: s => s.residents.length > 0 && (s.residents.reduce((a,b)=>a+b.stress,0)/s.residents.length) > 90 },
            { id: 'collector', name: '역사학자', icon: '📜', desc: '모든 유물(20종) 수집 완료.', unlocked: false, check: s => s.artifacts.every(a => a === true) }
        ];

        function getJosa(word, type) {
            if (!word) return '';
            const lastChar = word.charCodeAt(word.length - 1);
            const hasBatchim = (lastChar - 0xAC00) % 28 > 0;
            if (type === '이가') return hasBatchim ? '이' : '가';
            if (type === '을를') return hasBatchim ? '을' : '를';
            if (type === '와과') return hasBatchim ? '과' : '와';
            if (type === '은는') return hasBatchim ? '은' : '는';
            return '';
        }

        let setupIndex = 0;
        const tempResidents = []; 
        let snsPosts = [];

        // Google 로그인
        function signInWithGoogle() {
            console.log("🔵 signInWithGoogle 함수 호출됨");
            console.log("Firebase 상태:", { isFirebaseEnabled, firebaseAuth: !!firebaseAuth, firebase: typeof firebase });
            
            if (!isFirebaseEnabled || !firebaseAuth) {
                alert('Firebase가 설정되지 않았습니다.\n\n콘솔을 확인해주세요. (F12)');
                console.error("Firebase 상태:", { isFirebaseEnabled, firebaseAuth: !!firebaseAuth });
                return;
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                console.log("GoogleAuthProvider 생성 완료");
                
                // 도메인 승인 오류가 계속 발생하면 항상 redirect 방식 사용
                // redirect 방식이 더 안정적이고 도메인 승인 문제를 피할 수 있음
                console.log("리다이렉트 방식으로 로그인 시도...");
                firebaseAuth.signInWithRedirect(provider)
                    .then(() => {
                        console.log("✅ Google 로그인 리다이렉트 시작");
                    })
                    .catch((error) => {
                        console.error("❌ Google 로그인 리다이렉트 실패:", error);
                        console.error("에러 코드:", error.code);
                        console.error("에러 메시지:", error.message);
                        
                        if (error.code && error.code.includes('requests-from-referer')) {
                            // 도메인 승인 오류 - 추가 확인 사항 안내
                            const errorMsg = '도메인 승인 오류가 발생했습니다.\n\n' +
                                '확인 사항:\n' +
                                '1. Firebase Console > Authentication > Settings\n' +
                                '2. "승인된 도메인"에 "midnightcottage-studio.github.io"가 있는지 확인\n' +
                                '3. "Sign-in method"에서 Google이 "사용 설정"인지 확인\n' +
                                '4. 변경 후 몇 분 기다린 후 다시 시도\n\n' +
                                '또는 Google Cloud Console에서:\n' +
                                '1. https://console.cloud.google.com 접속\n' +
                                '2. 프로젝트 선택 > APIs & Services > Credentials\n' +
                                '3. OAuth 2.0 클라이언트 ID 확인\n' +
                                '4. 승인된 JavaScript 원본에 도메인 추가\n\n' +
                                '에러 코드: ' + error.code;
                            alert(errorMsg);
                        } else {
                            alert('로그인 실패: ' + error.message + '\n\n에러 코드: ' + error.code);
                        }
                    });
            } catch (error) {
                console.error("❌ signInWithGoogle 함수 내부 오류:", error);
                alert('로그인 중 오류가 발생했습니다: ' + error.message + '\n\n콘솔을 확인해주세요. (F12)');
            }
        }
        
        // 페이지 로드 시 리다이렉트 결과 확인
        window.onload = function() {
            init();
            // Firebase Auth 상태 확인 후 UI 업데이트
            if (isFirebaseEnabled && firebaseAuth) {
                setTimeout(updateAuthUI, 500);
                
                // 리다이렉트 로그인 결과 확인
                firebaseAuth.getRedirectResult()
                    .then((result) => {
                        if (result.user) {
                            console.log("✅ 리다이렉트 로그인 성공:", result.user.email);
                            spawnMessage('✅ Google 로그인 성공!', 'event');
                            loadGameFromFirebase();
                        }
                    })
                    .catch((error) => {
                        console.error("❌ 리다이렉트 로그인 결과 확인 실패:", error);
                    });
            }
        };
        
        // 로그아웃
        function signOut() {
            if (!firebaseAuth) return;
            
            if (confirm('로그아웃하시겠습니까? 로컬 데이터는 유지됩니다.')) {
                firebaseAuth.signOut()
                    .then(() => {
                        console.log("✅ 로그아웃 성공");
                        spawnMessage('로그아웃되었습니다.', 'event');
                    })
                    .catch((error) => {
                        console.error("❌ 로그아웃 실패:", error);
                    });
            }
        }
        
        // 인증 UI 업데이트
        function updateAuthUI() {
            const authStatus = document.getElementById('auth-status');
            const authButtons = document.getElementById('auth-buttons');
            
            if (!authStatus || !authButtons) return;
            
            if (!isFirebaseEnabled) {
                authStatus.innerHTML = '⚠️ <span style="color:#ffaa00;">Firebase 설정 필요</span>';
                authButtons.innerHTML = '<p style="color:#888; font-size:12px;">Firebase가 설정되지 않았습니다.</p>';
                return;
            }
            
            if (currentUser) {
                // 로그인 상태
                const email = currentUser.email || '알 수 없음';
                authStatus.innerHTML = `✅ <span style="color:var(--healing);">로그인됨</span><br><span style="font-size:11px; color:#aaa;">${email}</span>`;
                authButtons.innerHTML = `
                    <button onclick="event.stopPropagation(); signOut();" 
                            style="background:#666; color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px; width: 100%;">
                        로그아웃
                    </button>
                `;
            } else {
                // 로그아웃 상태
                authStatus.innerHTML = '⚠️ <span style="color:#888;">로그인되지 않음</span>';
                authButtons.innerHTML = `
                    <button onclick="event.stopPropagation(); signInWithGoogle();" 
                            style="background:#4285f4; color:#fff; border:none; padding:12px 20px; border-radius:8px; font-weight:900; cursor:pointer; font-size:14px; width: 100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span>🔵</span>
                        <span>Google로 로그인</span>
                    </button>
                `;
            }
        }

        // [수정] 1. 저장 기능 (로컬 + Firebase 클라우드 저장)
        function saveGame() {
            // 로컬 저장 (항상)
            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(state));
                localStorage.setItem(VERSION_KEY, GAME_VERSION);
            } catch (e) {
                console.error("로컬 저장 실패", e);
            }
            
            // Firebase 클라우드 저장 (로그인한 경우)
            if (isFirebaseEnabled && currentUser) {
                saveGameToFirebase();
            }
        }
        
        // Firebase에 게임 데이터 저장
        function saveGameToFirebase() {
            if (!firebaseDatabase || !currentUser) return;
            
            const userRef = firebaseDatabase.ref(`users/${currentUser.uid}/gameData`);
            const saveData = {
                ...state,
                version: GAME_VERSION,
                lastSaved: Date.now()
            };
            
            userRef.set(saveData)
                .then(() => {
                    console.log("✅ Firebase 클라우드 저장 성공");
                })
                .catch((error) => {
                    console.error("❌ Firebase 저장 실패:", error);
                });
        }
        
        // Firebase에서 게임 데이터 불러오기
        function loadGameFromFirebase() {
            if (!firebaseDatabase || !currentUser) return;
            
            const userRef = firebaseDatabase.ref(`users/${currentUser.uid}/gameData`);
            userRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // 버전 체크
                    if (data.version && data.version !== GAME_VERSION) {
                        console.warn(`⚠️ 클라우드 데이터 버전 불일치: ${data.version} → ${GAME_VERSION}`);
                    }
                    
                    // 데이터 로드
                    delete data.version;
                    delete data.lastSaved;
                    Object.assign(state, data);
                    
                    // 기존 사용자 호환: foodUnlocked가 없으면 rank에 따라 설정
                    if (state.foodUnlocked === undefined) {
                        state.foodUnlocked = (state.rank >= 8);
                    }
                    
                    // UI 업데이트
                    render();
                    updateUI();
                    
                    console.log("✅ Firebase 클라우드 데이터 로드 성공");
                    spawnMessage('☁️ 클라우드 데이터를 불러왔습니다!', 'event');
                }
            }, (error) => {
                console.error("❌ Firebase 데이터 로드 실패:", error);
            });
        }

        // [수정] 2. 불러오기 기능 (버전 체크 포함)
        function loadGame() {
            const savedVersion = localStorage.getItem(VERSION_KEY);
            const saved = localStorage.getItem(SAVE_KEY);
            
            // 업적 달성 정보 먼저 불러오기 (초기화되어도 유지되는 데이터)
            const savedAchievements = localStorage.getItem('midnight_cottage_unlocked_achievements');
            if (savedAchievements) {
                try {
                    state.unlockedAchievements = JSON.parse(savedAchievements);
                } catch (e) {
                    console.error("업적 정보 로드 실패", e);
                    state.unlockedAchievements = [];
                }
            }
            
            if (!saved) {
                // 게임 데이터가 없어도 업적 정보는 복원
                if (state.unlockedAchievements && state.unlockedAchievements.length > 0) {
                    restoreAchievements();
                }
                return false;
            }
            
            // 버전이 다르면 경고만 표시 (데이터는 유지)
            if (savedVersion && savedVersion !== GAME_VERSION) {
                console.warn(`⚠️ 게임 버전이 변경되었습니다. (${savedVersion} → ${GAME_VERSION})`);
                console.warn('기존 데이터를 사용합니다. 문제가 있으면 설정에서 초기화해주세요.');
            }
            
            // 버전이 없으면 (기존 사용자) 버전을 현재 버전으로 설정
            if (!savedVersion) {
                localStorage.setItem(VERSION_KEY, GAME_VERSION);
            }
            
                try {
                    const parsed = JSON.parse(saved);
                    // 업적 달성 정보를 백업 (파싱 전에 저장된 업적 정보 사용)
                    const savedUnlockedAchievements = state.unlockedAchievements || parsed.unlockedAchievements || [];
                    Object.assign(state, parsed);
                    // 업적 정보 복원 (이미 로드한 정보 우선 사용)
                    if (state.unlockedAchievements && state.unlockedAchievements.length > 0) {
                        // 이미 로드한 업적 정보 사용
                    } else {
                        state.unlockedAchievements = savedUnlockedAchievements;
                    }
                    
                    // 기존 사용자 호환: foodUnlocked가 없으면 rank에 따라 설정
                    if (state.foodUnlocked === undefined) {
                        state.foodUnlocked = (state.rank >= 8);
                    }
                    
                    // 업적 달성 상태 복원
                    restoreAchievements();
                
                // 버전이 다를 때만 사용자에게 알림 (한 번만)
                if (savedVersion && savedVersion !== GAME_VERSION) {
                    const versionWarningShown = sessionStorage.getItem('version_warning_shown');
                    if (!versionWarningShown) {
                        setTimeout(() => {
                            spawnMessage('⚠️ 게임이 업데이트되었습니다. 문제가 있으면 설정에서 초기화해주세요.', 'event');
                            sessionStorage.setItem('version_warning_shown', 'true');
                        }, 1000);
                    }
                }
                
                    return true; 
                } catch (e) {
                    console.error("세이브 파일 오류", e);
                    return false;
                }
        }

        // [수정] 3. 게임 초기화
        function init() {
            // 업그레이드 데이터가 없다면(데이터 누락 방지)
            if(typeof upgrades !== 'undefined') {
                state.upgrades = upgrades.map(u => ({ id: u.id, lv: 0, price: u.basePrice }));
            }

            // 로컬 데이터가 있으면 바로 시작
            if (loadGame()) {
                console.log("📂 저장된 데이터 로드됨");
                document.getElementById('start-screen').style.display = 'none';
                startGame();
                addHistory("💻 <b>시스템:</b> 지난번 작업을 이어서 시작합니다.");
            } else {
                // 없으면 입주 신청서 띄움
                loadSetupUI(0);
            }
        }

        function loadSetupUI(idx) {
            setupIndex = idx;
            const countDisplay = document.getElementById('char-count');
            const nextBtn = document.getElementById('btn-next');
            const prevBtn = document.getElementById('btn-prev');
            const finishBtn = document.getElementById('btn-finish');
            const nameInput = document.getElementById('input-name');

            countDisplay.innerText = `${idx + 1} / 5`;
            
            const currentData = tempResidents[idx] || {};
            nameInput.value = currentData.name || '';
            document.getElementById('input-gender').value = currentData.gender || '남';
            document.getElementById('input-job').value = currentData.job || '화가'; 

            prevBtn.style.display = idx === 0 ? 'none' : 'block';
            finishBtn.style.display = tempResidents.length > 0 || idx > 0 ? 'block' : 'none';

            if (idx === 4) {
                nextBtn.style.display = 'none'; 
                finishBtn.style.width = "100%"; 
            } else {
                nextBtn.style.display = 'block';
                nextBtn.innerText = `추가 (${idx + 1}/5)`;
                nextBtn.style.background = "#bb9af7";
            }
        }

        function saveCurrentInput() {
            const job = document.getElementById('input-job').value;
            const selectedDialogues = jobsData[job]; 
            const selectedEmoji = jobEmojis[job] || '👤';

            tempResidents[setupIndex] = {
                id: setupIndex,
                name: document.getElementById('input-name').value || `주민${setupIndex+1}`,
                emoji: selectedEmoji, 
                gender: document.getElementById('input-gender').value,
                job: job,
                stress: 0, 
                affection: 50, 
                partnerId: null, 
                relType: '솔로',
                dialogues: selectedDialogues
            };
        }

        function nextChar() {
            saveCurrentInput();
            if (setupIndex < 4) loadSetupUI(setupIndex + 1);
        }

        function prevChar() {
            if (setupIndex > 0) loadSetupUI(setupIndex - 1);
        }

        // [수정] 4. 입주 시작
        function finishSetup() {
            saveCurrentInput(); 
            state.residents = [...tempResidents]; 
            document.getElementById('start-screen').style.display = 'none';
            
            startGame();
            saveGame(); // 즉시 저장
            console.log("✅ 입주 완료");
        }

        function startGame() {
            changeNews();
            setInterval(changeNews, 300000);
            render(); updateUI(); renderAchievements();
            
            setInterval(() => { 
                let boost = 1 + (state.artifacts.filter(x=>x).length * 0.1);
                let income = state.autoIncome * boost;
                if (state.residents.length > 0) {
                    let avgStress = state.residents.reduce((a,b)=>a+b.stress, 0) / state.residents.length;
                    if (avgStress > 80) income *= 0.5;
                }

                state.money += income / 10; 
                state.residents.forEach(r => r.stress = Math.min(100, r.stress + 0.007));
                updateUI(); 
                checkAchievements();
            }, 100);
            
            // 5초마다 자동 저장 (로컬)
            setInterval(saveGame, 5000);
            
            setInterval(randomDailyEvent, 25000);
            setInterval(generateSNSPost, 60000); 

            if (window.innerWidth <= 768) {
                spawnMessage('💻작업 화이팅! 미드나잇 코티지가 너를 반겨.', 'event');
            }
        }

        // 💌 엔딩 대사
        const endingDialogues = {
            "화가": "너의 색으로 가득 찬 세상이었어. 고마워.",
            "소설가": "이 이야기의 마지막 페이지를 너와 함께 쓸 수 있어서 좋았어.",
            "교수": "너라는 존재는 역사상 가장 아름다운 발견이었어.",
            "리퍼닥": "내 심장 부품, 너에게 줄게. 건강해.",
            "ASMR DJ": "마지막엔 너를 위해, 최고의 안식을 전해줄게.",
            "모델": "내 인생에서 가장 빛났던 순간은 런웨이가 아니라 네 옆이었어.",
            "형사": "수사 종료야. 너라는 진실을 찾았으니까.",
            "넷러너": "로그아웃해도, 너의 데이터만은 삭제 안 할게.",
            "라멘노점상": "언제든 와. 널 위해서라면 평생 면을 삶아서 기다릴게.",
            "온천주인": "또 와. 가장 따뜻한 물을 준비해 둘게.",
            "LP바 사장님": "음악이 멈춰도, 너와의 리듬은 잊지 않을게.",
            "뮤지션": "천국에 가도, 널 위한 노래를 계속 부를게.",
            "고양이": "야옹. (즐거웠어, 집사. 건강해.)",
            "VIP": "전 재산을 내도 아깝지 않은 시간이었어. 고마워.",
            "백수": "일하지 않아도 널 만날 시간은 항상 있었어. 고마워."
        };

        function toggleModal(id) { 
            const m = document.getElementById(id); 
            if (m) {
                m.style.display = (m.style.display==='flex')?'none':'flex';
                if(id === 'sns-modal' && m.style.display === 'flex') {
                    document.getElementById('sns-dot').style.display = 'none'; 
                }
                if(id === 'shop-modal' && m.style.display === 'flex') {
                    updateGachaUI();
                }
                if(id === 'food-modal' && m.style.display === 'flex') {
                    renderFoodMenu();
                }
                if(id === 'fortune-modal') {
                    if (m.style.display === 'flex') {
                        // 모달이 열릴 때 선택 상태 초기화
                        window.currentPartnerSelectChar = null;
                        window.currentPartnerSelectType = null;
                        renderFortuneModal();
                    }
                }
                if(id === 'radio-modal') {
                    if (m.style.display === 'flex') {
                        loadRadioMessages();
                    } else {
                        // 모달이 닫힐 때 Firebase 리스너 정리
                        if (radioMessagesRef) {
                            radioMessagesRef.off();
                            radioMessagesRef = null;
                        }
                    }
                }
                if(id === 'help-modal' && m.style.display === 'flex') {
                    updateAuthUI();
                }
                if(id === 'ranking-modal' && m.style.display === 'flex') {
                    const nameInput = document.getElementById('player-name-input');
                    if (nameInput) {
                        nameInput.value = state.playerName || '';
                    }
                    
                    // Firebase 연결 상태 표시
                    const statusText = document.getElementById('firebase-status-text');
                    if (statusText) {
                        if (isFirebaseEnabled) {
                            statusText.innerHTML = '✅ <span style="color:var(--healing);">전체 유저 랭킹 연결됨</span>';
                        } else {
                            statusText.innerHTML = '⚠️ <span style="color:#ffaa00;">로컬 모드 (Firebase 설정 필요)</span>';
                        }
                    }
                    
                    renderRanking();
                }
            }
        }

        function startEndingSequence() {
            const screen = document.getElementById('ending-sequence');
            const container = document.querySelector('.rolling-container');
            const emojiDiv = document.getElementById('end-emoji');
            const nameDiv = document.getElementById('end-name');
            const msgDiv = document.getElementById('end-msg');
            const finalScreen = document.getElementById('final-screen');

            if (!screen || !container || !emojiDiv || !nameDiv || !msgDiv || !finalScreen) {
                console.error('엔딩 시퀀스 요소를 찾을 수 없습니다.');
                return;
            }

            screen.style.display = 'flex';
            let step = 0;
            
            function showNextResident() {
                // 주민이 없거나 모든 주민을 표시한 경우
                if (step >= state.residents.length) {
                    container.style.display = 'none';
                    finalScreen.style.display = 'block';
                    finalScreen.style.animation = 'fade-in 2s forwards';
                    return;
                }
                
                const char = state.residents[step];
                if (!char) {
                    // 주민 데이터가 없으면 바로 최종 화면으로
                    container.style.display = 'none';
                    finalScreen.style.display = 'block';
                    finalScreen.style.animation = 'fade-in 2s forwards';
                    return;
                }
                
                const msg = endingDialogues[char.job] || "함께해서 즐거웠어. 행복해야 해!";
                emojiDiv.innerText = char.emoji || "👤";
                nameDiv.innerText = `${char.job} ${char.name}`;
                msgDiv.innerText = `"${msg}"`;
                container.classList.add('show');
                setTimeout(() => {
                    container.classList.remove('show');
                    setTimeout(() => {
                        step++;
                        showNextResident();
                    }, 1000); 
                }, 4000); 
            }
            showNextResident();
        }

        function closeEndingSequence() {
            document.getElementById('ending-sequence').style.display = 'none';
        }

        function getGachaPrice() {
            const foundCount = state.artifacts.filter(x => x).length;
            return 10000 * Math.pow(2, foundCount);
        }

        function updateGachaUI() {
            const price = getGachaPrice();
            const btn = document.getElementById('btn-gacha');
            const priceText = document.getElementById('gacha-price');
            priceText.innerText = `💵 ${price.toLocaleString()}`;
            if(state.artifacts.every(x => x)) {
                btn.disabled = true;
                btn.innerHTML = "모든 유물 수집 완료!";
            } else if(state.money < price) {
                btn.disabled = true;
            } else {
                btn.disabled = false;
            }
        }

        function buyArtifact() {
            const price = getGachaPrice();
            if(state.money >= price) {
                state.money -= price;
                const unfound = state.artifacts.map((v, i) => v === false ? i : null).filter(v => v !== null);
                if (unfound.length > 0) {
                    const pick = unfound[Math.floor(Math.random()*unfound.length)];
                    state.artifacts[pick] = true; 
                    renderMuseum();
                    showCenterPopup(artifactsData[pick].emoji, '유물 복원 성공!', artifactsData[pick].name);
                    addHistory(`🏺 <b>유물 복원:</b> [${artifactsData[pick].name}] 복원 완료! (수익 +10%)`);
                }
                updateUI();
                updateGachaUI();
                saveGame();
            }
        }

        function generateSNSPost() {
            if (state.residents.length === 0) return;
            const char = state.residents[Math.floor(Math.random() * state.residents.length)];
            let text = "";

            const generalPosts = [
                // [일상 & 감성]
                "오늘 파티할 사람?", "집이 최고야.", "이 거리 힙하네.", "배터리 충전 중...", 
                "책 읽기 좋은 밤.", "심심해 놀아줘!", "편의점 도시락 지겨워.", "누가 내 자전거 훔쳐갔어?", 
                "비 오는 날엔 파전이지.", "네온사인이 오늘따라 예쁘네.", "인생...", "월급 언제 들어오지?", 
                "야식 추천 좀.", "새로 생긴 가게 가볼 사람?", "오늘 날씨 미쳤다.", "출근하기 싫다.", 
                "퇴근하고 맥주 한잔?", "주말 순삭...", "넷플릭스 볼 거 추천 좀.", "다이어트는 내일부터.", 
                "오늘 오오티디.", "맛집 발견!", "커피 수혈 시급.", "잠이 안 와.", "새벽 감성 터지네.", 
                "옛날 노래 듣는 중.", "여행 가고 싶다.", "방 청소 해야 하는데...", "이불 밖은 위험해.", 
                "오늘 기분 맑음.", "소확행.", "멍 때리는 중.", "배고파.", "로또 당첨 기원.", 
                "산책 갈까?", "택배 왔다!", "밀린 빨래 해야지.", "라면 먹고 갈래?", "월요병 도지네.",
                
                // [사이버펑크 세계관]
                "의체 관절이 쑤시네. 비 오려나.", "합성 라면에서 진짜 고기 맛이 나!", 
                "누가 내 뇌 해킹 시도했냐? 방화벽 뚫릴 뻔.", "하늘에 드론 너무 많아 시끄러워.", 
                "사이버웨어 펌웨어 업데이트 중... 움직일 수가 없어.", "가상현실 접속할 파티원 구함.", 
                "리퍼닥 예약 잡기 힘드네.", "오늘따라 산성비가 심하네.", "진짜 종이책 구했어! 냄새 대박.", 
                "안드로이드 알바생이 나보다 일 잘함.", "망막 디스플레이 광고 차단 어떻게 해?", 
                "옆집 홀로그램이 자꾸 우리 집으로 넘어와.", "구형 임플란트 팝니다.", 
                "오늘 밤 시티 뷰 미쳤다.", "네트워크 다이브 하다가 멀미 남.", "인공지능이 내 일기를 훔쳐본 것 같아.", 
                "합성 비타민 말고 진짜 과일 먹고 싶다.", "2026년 골동품 스마트폰 팝니다.", 
                "내 기억 메모리 좀 정리해야겠어. 용량 부족해.", "불법 칩 이식하지 마라. 부작용 쩐다.", 
                "전기세 또 올랐네. 자가발전기 돌려야 하나.", "지하철에서 넷러너끼리 싸우는 거 봄.", 
                "사이버 캣 영상 보면서 힐링 중.", "누가 내 계정에 바이러스 심었어 ㅡㅡ", 
                "인공 태양빛이 너무 강해.", "레트로 감성으로 유선 이어폰 샀다.", 
                "기계 팔 기름칠 좀 해야지. 삐걱거려.", "도시 소음 차단하고 명상 중.", 
                "홀로그램 여친/남친이랑 싸움. 위로 좀.", "알약 하나로 식사 때우기 싫다.",
                "나르는 자동차 면허 땄다!", "공기 청정기 필터 갈아야지.", "오늘 데이터 전송 속도 왜 이래?"
            ];

            if (char.job === '고양이') { 
                text = [
                    "냥.", "골골골...", "츄르 내놔라 닝겐.", "우다다다다다!!", "그르릉...", 
                    "박스 내꺼.", "높은 곳이 좋아.", "낮잠 시간이다냥.", "집사야 놀아줘.", 
                    "꾹꾹이 하는 중.", "쥐 장난감 잡았다옹!", "창밖의 드론 구경 중.", "식빵 굽는 중.", 
                    "내 털은 방수라네~", "전기난로 앞이 명당이다옹.", "야옹! (밥!)", 
                    "집사 몰래 간식 훔쳐먹음.", "스크래쳐 긁긁.", "하품...", "나비 잡으러 갈래."
                ][Math.floor(Math.random()*20)]; 
            } 
            else if (char.relType === '불륜') { 
                text = [
                    "비밀 계정입니다.", "오늘 밤도...", "쉿.", "아무도 모르게.", "심장이 뛴다.", 
                    "위험한데 멈출 수 없어.", "이러면 안 되는데...", "보고 싶어.", "새벽 2시의 밀회.", 
                    "우린 공범이야.", "지옥 끝까지라도 갈게.", "이 사랑이 죄라면 달게 받을게.", 
                    "다른 사람은 몰라도 돼.", "너만 생각하면 숨이 막혀.", "금지된 게 더 달콤하네.", 
                    "오늘따라 네 향기가 지워지질 않아.", "돌이킬 수 없는 강을 건넜어.", 
                    "스릴 있어서 더 좋아.", "우리 그냥 도망칠까?", "쉿, 알람 꺼놔."
                ][Math.floor(Math.random()*20)]; 
            } 
            else if (char.stress > 80) { 
                text = [
                    "아 진짜 다 짜증 나네.", "건들지 마라.", "퇴사 마렵다.", "세상이 망했으면.", 
                    "아무것도 하기 싫어.", "머리 아파.", "다 때려치우고 싶다.", "폭발 직전.", 
                    "시스템 과부하.", "내버려 둬 제발.", "오늘 말 걸면 문다.", "스트레스 수치 99%.", 
                    "다 부숴버리고 싶네.", "어디론가 증발하고 싶다.", "뇌가 타버릴 것 같아.", 
                    "로그아웃 하고 싶다. 영원히.", "누구 하나만 걸려라.", "으아아아아아악!!!", 
                    "살려줘...", "방전됨."
                ][Math.floor(Math.random()*20)]; 
            } 
            else { 
                text = generalPosts[Math.floor(Math.random() * generalPosts.length)]; 
            }

            const post = { emoji: char.emoji, name: char.name, time: new Date().toLocaleTimeString().slice(0, 5), text: text };
            snsPosts.unshift(post);
            if (snsPosts.length > 20) snsPosts.pop();
            renderSNS();
            document.getElementById('sns-dot').style.display = 'block';
        }

        function renderSNS() {
            const feed = document.getElementById('sns-feed');
            if(feed) feed.innerHTML = snsPosts.map(p => `<div class="sns-post"><div class="sns-user"><div class="sns-avatar">${p.emoji}</div><div class="sns-name">${p.name}</div><div class="sns-time">${p.time}</div></div><div class="sns-text">${p.text}</div></div>`).join('');
        }

        function checkAchievements() {
            let changed = false;
            achievements.forEach(ach => {
                if (!ach.unlocked && ach.check(state)) {
                    ach.unlocked = true;
                    // 업적 달성 상태를 state에 저장
                    if (!state.unlockedAchievements) {
                        state.unlockedAchievements = [];
                    }
                    if (!state.unlockedAchievements.includes(ach.id)) {
                        state.unlockedAchievements.push(ach.id);
                    }
                    changed = true;
                    showCenterPopup(ach.icon, "업적 달성!", ach.name);
                    addHistory(`🏆 <b>업적 달성:</b> [${ach.name}] - ${ach.desc}`);
                    saveGame(); // 업적 달성 시 즉시 저장
                }
            });
            if (changed) { renderAchievements(); }
        }
        
        // 업적 달성 상태 복원 (게임 로드 시 호출)
        function restoreAchievements() {
            if (state.unlockedAchievements && state.unlockedAchievements.length > 0) {
                achievements.forEach(ach => {
                    if (state.unlockedAchievements.includes(ach.id)) {
                        ach.unlocked = true;
                    }
                });
                renderAchievements();
            }
        }

        function renderAchievements() {
            document.getElementById('ach-grid').innerHTML = achievements.map(a => `<div class="ach-item ${a.unlocked ? 'unlocked' : ''}"><div class="ach-icon">${a.icon}</div><div class="ach-title">${a.name}</div><div class="ach-desc">${a.unlocked ? a.desc : '???' }</div></div>`).join('');
        }

        function spawnMessage(text, type) {
            const stack = document.getElementById('dialogue-stack');
            if(!stack) return;
            const bubble = document.createElement('div');
            bubble.className = `dialogue-bubble ${type}`;
            bubble.innerHTML = text;
            stack.appendChild(bubble);
            
            setTimeout(() => {
                bubble.style.animation = 'fade-out-bubble 0.5s forwards';
                setTimeout(() => bubble.remove(), 500);
            }, 3500);
        }

        function addHistory(msg) {
            const timeMsg = `[${new Date().toLocaleTimeString()}] ${msg}`;
            state.history.unshift(timeMsg);
            if (state.history.length > 50) state.history.pop();
            
            const list = document.getElementById('history-list');
            if (list) list.innerHTML = state.history.map(h => `<li>${h}</li>`).join('');
            
            const eventLog = document.getElementById('event-log');
            if (eventLog) eventLog.innerHTML = msg; 

            if (window.innerWidth <= 768) {
                let cleanMsg = msg.replace(/<[^>]*>?/gm, ''); 
                if(cleanMsg.includes(']')) cleanMsg = cleanMsg.split(']')[1].trim(); 
                spawnMessage(cleanMsg, 'event');
            }
        }

        function changeNews() {
            const newsList = ["산성비 주의보 (스트레스 UP)", "네온 축제 (힐링 UP)", "네트워크 장애 (수익 DOWN)", "기업 보조금 (수익 UP)", "심야의 고요 (평화로움)"];
            const pick = newsList[Math.floor(Math.random()*newsList.length)];
            const banner = document.getElementById('news-banner');
            if (banner) banner.innerText = "📢 오늘의 뉴스: " + pick;
        }

        function showCenterPopup(emoji, title, sub) {
            const popup = document.createElement('div');
            popup.className = 'center-popup';
            popup.innerHTML = `<div style="font-size:40px;">${emoji}</div><div>${title}</div><div style="font-size:16px; color:#fff; font-weight:500;">[${sub}]</div>`;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 3000);
        }

        function showEvolutionToast(rankName) {
            const evo = document.createElement('div');
            evo.className = 'evo-toast';
            evo.innerHTML = `🌙 코티지룸 진화!<br><span style="font-size:18px; color:#fff;">[${rankName}] 해금</span>`;
            document.body.appendChild(evo);
            setTimeout(() => evo.remove(), 4000);
        }

        function closeModalByBg(e, id) {
            if (id === 'museum-modal') { if (!e.target.closest('.artifact-slot')) { toggleModal(id); } return; }
            // 모달 배경(바깥쪽 div)을 클릭했을 때 닫기
            // e.target이 모달 자체이거나, 모달의 직접 자식이 아닌 경우 (내부 컨텐츠가 아닌 경우)
            if (e.target.id === id || (e.target.classList.contains('modal') && e.target === e.currentTarget)) {
                toggleModal(id);
            }
        }

        function selectRoom(rankIndex) {
            // VIP 방 체크 (1-based이므로 -1 해서 0-based로 변환)
            const roomIndex = rankIndex - 1;
            const isVIP = roomIndex >= VIP_ROOM_START_INDEX;
            if (isVIP && !state.vipUnlocked) {
                alert('후원 전용 방입니다. 후원 후 이용 가능합니다.');
                return;
            }
            
            state.currentSelectedRank = rankIndex;
            updateUI();
            showCenterPopup('🖼️', '배경 변경 완료!', rankNames[rankIndex-1]);
            toggleModal('gallery-modal');
        }

        function render() {
            document.getElementById('res-grid').innerHTML = state.residents.map((r, i) => {
                let relText = r.relType;
                if (r.partnerId !== null && state.residents[r.partnerId]) { relText = `${state.residents[r.partnerId].name}의 ${r.relType}`; }
                const genderBg = r.gender === '여' ? 'var(--female-bg)' : (r.gender === '남' ? 'var(--male-bg)' : '#444');
                const stressTag = r.stress >= 70 ? '<div style="position:absolute; top:-5px; left:-5px; background:var(--heart); color:#c04a5a; font-size:9px; font-weight:900; padding:2px 6px; border-radius:8px; border:2px solid var(--card); z-index:10; box-shadow:0 0 8px rgba(247, 118, 142, 0.5);">스트레스</div>' : '';
                return `<div class="res-card" onclick="talkToResident(${i})"><div class="res-icon-box" style="background: ${genderBg}">${r.emoji}${stressTag}</div><div class="stress-box"><div class="stress-fill" id="stress-${i}" style="width: ${r.stress}%"></div></div><div class="res-name">${r.name}</div><div class="res-job" style="font-size:8px;">${r.job}</div><div class="res-rel">${relText}</div></div>`;
            }).join('');
            
            document.getElementById('upgrade-list').innerHTML = state.upgrades.map((u, i) => {
                const data = upgrades[i];
                return `<div class="up-card"><div class="up-info"><h4>${data.name} <small>(Lv.${u.lv})</small></h4><div class="tags">${u.lv === 0 ? '<span class="tag-dev">⭐ 발전도 +1</span>' : ''}${data.isHealing ? '<span class="tag-healing">🌿 스트레스 해소</span>' : ''}</div><p>${data.type === 'click' ? '클릭' : '초당'} +${data.power.toLocaleString()}</p></div><button class="buy-btn" id="btn-${u.id}" onclick="buy(${i})">💵 ${u.price.toLocaleString()}</button></div>`;
            }).join('');
            renderMuseum();
        }

        function renderMuseum() {
            document.getElementById('museum-list').innerHTML = artifactsData.map((a, i) => `<div class="artifact-slot ${state.artifacts[i] ? 'found' : ''}" onclick="showArt(${i}, event)">${state.artifacts[i] ? a.emoji : '?'}</div>`).join('');
        }

        function showArt(i, e) { 
            e.stopPropagation(); 
            const descBox = document.getElementById('artifact-desc');
            if(state.artifacts[i]) descBox.innerText = `테오: "${artifactsData[i].desc}"`; 
            else descBox.innerText = "아직 미수집된 유물이니 박물관에서 구해봐!";
        }
        
        // 점술집 모달 렌더링
        function renderFortuneModal() {
            const charList = document.getElementById('fortune-char-list');
            if (!charList) return;
            
            // window 객체 초기화 (없을 경우)
            if (typeof window.currentPartnerSelectChar === 'undefined') {
                window.currentPartnerSelectChar = null;
                window.currentPartnerSelectType = null;
            }
            
            if (state.residents.length === 0) {
                charList.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">주민이 없습니다.</p>';
                return;
            }
            
            charList.innerHTML = state.residents.map((char, i) => {
                const partner = char.partnerId !== null ? state.residents[char.partnerId] : null;
                const partnerName = partner ? partner.name : '없음';
                const relTypeText = char.relType === '솔로' ? '솔로' : (char.relType === '커플' ? '연인' : '불륜');
                
                let actionButtons = '';
                
                if (char.relType === '불륜') {
                    // 불륜 상태: 불륜 해지, 솔로로 만들기
                    actionButtons = `
                        <button onclick="breakRelationship(${i})" style="background:var(--heart); color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px; margin-right:8px;">
                            불륜 해지하기
                        </button>
                        <button onclick="setToSolo(${i})" style="background:#666; color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                            솔로로 만들기
                        </button>
                    `;
                } else if (char.relType === '커플') {
                    // 연인 상태: 불륜으로 만들기, 솔로로 만들기
                    actionButtons = `
                        <button onclick="showPartnerSelector(${i}, '불륜')" style="background:var(--heart); color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px; margin-right:8px;">
                            불륜으로 만들기
                        </button>
                        <button onclick="setToSolo(${i})" style="background:#666; color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                            솔로로 만들기
                        </button>
                    `;
                } else {
                    // 솔로 상태: 불륜으로 만들기, 연인으로 만들기
                    actionButtons = `
                        <button onclick="showPartnerSelector(${i}, '불륜')" style="background:var(--heart); color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px; margin-right:8px;">
                            불륜으로 만들기
                        </button>
                        <button onclick="showPartnerSelector(${i}, '커플')" style="background:var(--accent); color:#000; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:13px;">
                            연인으로 만들기
                        </button>
                    `;
                }
                
                // 파트너 선택 UI가 표시되는지 확인
                const showPartnerSelect = window.currentPartnerSelectChar === i;
                let partnerSelectUI = '';
                
                if (showPartnerSelect) {
                    const availablePartners = state.residents.filter((r, idx) => idx !== i && r.id !== char.partnerId);
                    if (availablePartners.length > 0) {
                        partnerSelectUI = `
                            <div id="partner-select-${i}" style="margin-top:12px; padding:12px; background:rgba(187, 154, 247, 0.2); border:1px solid var(--border); border-radius:8px;">
                                <p style="margin:0 0 10px 0; color:var(--text); font-size:13px; font-weight:700;">
                                    ${window.currentPartnerSelectType === '불륜' ? '불륜' : '연인'} 관계를 맺을 파트너를 선택하세요:
                                </p>
                                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                    ${availablePartners.map((p, pIdx) => {
                                        const partnerIdx = state.residents.findIndex(r => r.id === p.id);
                                        return `
                                            <button onclick="confirmPartnerSelection(${i}, ${partnerIdx}, '${window.currentPartnerSelectType}')" 
                                                    style="background:var(--accent); color:#000; border:none; padding:6px 12px; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:6px;">
                                                <span>${p.emoji}</span>
                                                <span>${p.name}</span>
                                            </button>
                                        `;
                                    }).join('')}
                                    <button onclick="cancelPartnerSelection()" style="background:#666; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-weight:700; cursor:pointer; font-size:12px;">
                                        취소
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                return `
                    <div style="background:rgba(187, 154, 247, 0.1); border:1px solid var(--border); border-radius:12px; padding:15px;" onclick="event.stopPropagation()">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                            <span style="font-size:32px;">${char.emoji}</span>
                            <div style="flex:1;">
                                <h4 style="margin:0; color:var(--text); font-size:16px; font-weight:800;">${char.name}</h4>
                                <p style="margin:5px 0 0 0; color:#888; font-size:12px;">
                                    상태: <span style="color:${char.relType === '솔로' ? '#aaa' : (char.relType === '커플' ? 'var(--heart)' : '#ff6b9d')};">${relTypeText}</span>
                                    ${partner ? ` | 파트너: ${partnerName}` : ''}
                                </p>
                            </div>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            ${actionButtons}
                        </div>
                        ${partnerSelectUI}
                    </div>
                `;
            }).join('');
        }
        
        // 관계 상태 변경 함수들
        function breakRelationship(charIdx) {
            const char = state.residents[charIdx];
            if (!char || char.relType !== '불륜' || char.partnerId === null) return;
            
            const partner = state.residents[char.partnerId];
            if (partner) {
                partner.relType = '솔로';
                partner.partnerId = null;
            }
            
            char.relType = '솔로';
            char.partnerId = null;
            
            addHistory(`🔮 <b>운명의 실:</b> ${char.name}${getJosa(char.name, '와과')} ${partner ? partner.name : '파트너'}${getJosa(partner ? partner.name : '', '은는')} 불륜 관계를 해지했습니다.`);
            saveGame();
            render();
            toggleModal('fortune-modal');
        }
        
        function setToSolo(charIdx) {
            const char = state.residents[charIdx];
            if (!char) return;
            
            // 기존 파트너가 있다면 해제
            if (char.partnerId !== null) {
                const partner = state.residents[char.partnerId];
                if (partner) {
                    partner.relType = '솔로';
                    partner.partnerId = null;
                }
            }
            
            char.relType = '솔로';
            char.partnerId = null;
            
            addHistory(`🔮 <b>운명의 실:</b> ${char.name}${getJosa(char.name, '은는')} 솔로가 되었습니다.`);
            saveGame();
            render();
            toggleModal('fortune-modal');
        }
        
        // 파트너 선택 UI 표시
        function showPartnerSelector(charIdx, relType) {
            if (state.residents.length < 2) {
                spawnMessage(`${relType === '불륜' ? '불륜' : '연인'} 관계를 만들려면 최소 2명의 주민이 필요합니다.`, 'event');
                return;
            }
            
            const char = state.residents[charIdx];
            if (!char) return;
            
            const otherResidents = state.residents.filter((r, i) => i !== charIdx && r.id !== char.partnerId);
            if (otherResidents.length === 0) {
                spawnMessage(`${relType === '불륜' ? '불륜' : '연인'} 관계를 만들 수 있는 다른 주민이 없습니다.`, 'event');
                return;
            }
            
            // 현재 선택 중인 캐릭터와 관계 타입 저장
            window.currentPartnerSelectChar = charIdx;
            window.currentPartnerSelectType = relType;
            
            // 모달 다시 렌더링
            renderFortuneModal();
        }
        
        // 파트너 선택 취소
        function cancelPartnerSelection() {
            window.currentPartnerSelectChar = null;
            window.currentPartnerSelectType = null;
            renderFortuneModal();
        }
        
        // 파트너 선택 확인 및 관계 형성
        function confirmPartnerSelection(charIdx, partnerIdx, relType) {
            const char = state.residents[charIdx];
            const partner = state.residents[partnerIdx];
            
            if (!char || !partner) return;
            
            // 기존 파트너 정리
            if (char.partnerId !== null) {
                const exPartner = state.residents[char.partnerId];
                if (exPartner) {
                    exPartner.relType = '솔로';
                    exPartner.partnerId = null;
                }
            }
            if (partner.partnerId !== null) {
                const exPartner = state.residents[partner.partnerId];
                if (exPartner) {
                    exPartner.relType = '솔로';
                    exPartner.partnerId = null;
                }
            }
            
            // 관계 형성
            const relTypeText = relType === '불륜' ? '불륜' : '커플';
            char.relType = relTypeText;
            char.partnerId = partner.id;
            partner.relType = relTypeText;
            partner.partnerId = char.id;
            
            addHistory(`🔮 <b>운명의 실:</b> ${char.name}${getJosa(char.name, '와과')} ${partner.name}${getJosa(partner.name, '은는')} ${relTypeText} 관계가 되었습니다.`);
            
            // 선택 상태 초기화
            window.currentPartnerSelectChar = null;
            window.currentPartnerSelectType = null;
            
            saveGame();
            render();
            toggleModal('fortune-modal');
        }
        
        // 음식 메뉴 렌더링
        function renderFoodMenu() {
            const menuList = document.getElementById('food-menu-list');
            if (!menuList) return;
            
            // 모든 주민의 스트레스 합계 확인
            const totalStress = state.residents.reduce((sum, r) => sum + r.stress, 0);
            const hasStress = totalStress > 0;
            
            menuList.innerHTML = foodMenu.map((food, index) => {
                const canAfford = state.money >= food.price;
                const canBuy = canAfford && hasStress; // 돈이 있고 스트레스가 있을 때만 구매 가능
                return `
                    <div class="food-item-card" onclick="(function(e){if(!e.target.closest('.food-buy-btn')){toggleModal('food-modal');}})(event)" style="background:rgba(187, 154, 247, 0.1); border:1px solid var(--border); border-radius:12px; padding:15px; display:flex; flex-direction:column; gap:10px; cursor:pointer;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:32px;">${food.icon}</span>
                            <div style="flex:1;">
                                <h4 style="margin:0; color:var(--text); font-size:16px; font-weight:800;">${food.name}</h4>
                                <p style="margin:5px 0 0 0; color:#888; font-size:12px; line-height:1.4;">${food.desc}</p>
                            </div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--gold); font-weight:900; font-size:18px;">💵 ${food.price.toLocaleString()}</span>
                            <button class="food-buy-btn" data-food-index="${index}" 
                                    style="background:${canBuy ? 'var(--accent)' : '#666'}; color:${canBuy ? '#000' : '#999'}; border:none; padding:8px 16px; border-radius:8px; font-weight:900; cursor:${canBuy ? 'pointer' : 'not-allowed'}; font-size:14px; white-space:nowrap;"
                                    ${!canBuy ? 'disabled' : ''}>
                                구매
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 이벤트 리스너 추가 (기존 리스너 제거 후 새로 추가)
            const buyButtons = menuList.querySelectorAll('.food-buy-btn');
            buyButtons.forEach(btn => {
                // 기존 리스너 제거를 위해 클론 후 교체
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (!this.disabled) {
                        const foodIndex = parseInt(this.getAttribute('data-food-index'));
                        buyFood(foodIndex);
                    }
                });
            });
        }
        
        // 음식 구매
        function buyFood(foodIndex) {
            const food = foodMenu[foodIndex];
            if (!food) return;
            
            if (state.money < food.price) {
                spawnMessage('💰 돈이 부족합니다!', 'event');
                return;
            }
            
            // 돈 차감
            state.money -= food.price;
            
            // 모든 주민 스트레스 0으로 초기화
            state.residents.forEach(r => r.stress = 0);
            
            // 토스트 메시지
            const messages = [
                '따뜻한 국물이 몸을 녹입니다... (스트레스 해소)',
                '맛있는 음식이 마음을 달래줍니다... (스트레스 해소)',
                '포만감이 스트레스를 잊게 해줍니다... (스트레스 해소)',
                '따뜻한 한 끼가 모든 주민을 위로합니다... (스트레스 해소)'
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            spawnMessage(randomMsg, 'event');
            
            // 히스토리 추가
            addHistory(`🍜 <b>길거리 음식:</b> [${food.name}] 구매! 모든 주민의 스트레스가 해소되었습니다.`);
            
            // 모달 먼저 닫기
            toggleModal('food-modal');
            
            // UI 업데이트
            updateUI();
            render(); // 주민 스트레스 바 업데이트
            saveGame();
        }

        function buy(idx) {
            const u = state.upgrades[idx], d = upgrades[idx];
            
            if (!u || !d) {
                console.error('구매할 수 없는 건물입니다:', idx);
                return;
            }
            
            // 1. 구매 로직
            if(state.money >= u.price) {
                state.money -= u.price; 
                
                if(u.lv === 0) { 
                    state.totalUniquePurchased++; 
                    addHistory(`🏗️ <b>신규 시설:</b> [${d.name}] 건설 완료.`); 
                }
                u.lv++;
                
                if(d.type === 'click') state.clickPower += d.power; 
                else state.autoIncome += d.power;
                
                if(d.isHealing) state.residents.forEach(r => r.stress = Math.max(0, r.stress - 20));
                
                u.price = Math.floor(u.price * 1.6);
                
                const newRank = Math.min(34, Math.floor(state.totalUniquePurchased / 3) + 1);
                if (newRank > state.rank) {
                    state.rank = newRank; 
                    state.currentSelectedRank = newRank;
                    showEvolutionToast(rankNames[newRank-1]);
                    addHistory(`🌟 <b>도시 진화:</b> [${rankNames[newRank-1]}] 달성!`);
                    
                    // 랭크 3 해금 시 라디오 기능 안내
                    if (newRank === 3) {
                        setTimeout(() => {
                            spawnMessage('지지직... 외부 신호 수신 장치가 활성화되었습니다.', 'event');
                        }, 1500);
                    }
                    
                    // 랭크 8 해금 시 음식 가판대 기능 안내 (합성 라면 가판대)
                    if (newRank === 8 && !state.foodUnlocked) {
                        state.foodUnlocked = true;
                        setTimeout(() => {
                            showCenterPopup('🍜', '합성 라면 가판대 해금!', '이제 라면 가판대에서 음식을 사 먹을 수 있습니다!');
                            spawnMessage('🍜 합성 라면 가판대가 열렸습니다! 모든 주민의 스트레스를 해소할 수 있어요.', 'event');
                        }, 1500);
                    }
                    
                    // 랭크 13 해금 시 점술집 기능 안내
                    if (newRank === 13) {
                        setTimeout(() => {
                            showCenterPopup('🔮', '홀로그램 점술집 오픈!', '운명의 붉은 실로 관계를 조작할 수 있습니다!');
                            spawnMessage('🔮 홀로그램 점술집이 열렸습니다! 운명의 붉은 실로 캐릭터들의 관계를 바꿀 수 있어요.', 'event');
                        }, 1500);
                    }
                    
                    // 랭크가 올라가면 랭킹 자동 업데이트
                    if (state.playerName) {
                        submitRanking();
                    }
                }
                
                // 미드나잇 유토피아 건물 최초 구매 시 엔딩 트리거
                // 또는 Rank 34 달성 시 엔딩 트리거
                if (d && d.name === "미드나잇 유토피아" && u.lv === 1) {
                    // 미드나잇 유토피아 최초 구매 시
                    if (!state.endingSeen) {
                        state.endingSeen = true; 
                        startEndingSequence(); 
                    }
                } else if (state.rank >= 34 && !state.endingSeen) {
                    // Rank 34 달성 시
                    state.endingSeen = true;
                    startEndingSequence();
                }
                
                render(); 
                updateUI();
                
                // 🔥 [수정] 돈 썼으니까 바로 저장!
                saveGame();
            }

            // 2. 버튼 뽀잉 연출
            const btn = document.getElementById(`btn-${u.id}`);
            if (btn) {
                btn.classList.remove('click-animate'); 
                void btn.offsetWidth; // 애니메이션 리셋 매직 코드
                btn.classList.add('click-animate'); 
            }
        }

        function updateUI() {
            document.getElementById('budget').innerText = Math.floor(state.money).toLocaleString();
            state.upgrades.forEach(u => { 
                const btn = document.getElementById(`btn-${u.id}`); 
                if(btn) {
                    // 버튼 가격 텍스트 업데이트 (깜빡임 방지)
                    btn.innerText = `💵 ${u.price.toLocaleString()}`;
                    btn.disabled = state.money < u.price; 
                }
            });
            state.residents.forEach((r, i) => { const fill = document.getElementById(`stress-${i}`); if(fill) fill.style.width = r.stress + '%'; });
            const currentProgress = state.totalUniquePurchased % 3;
            const displayRankName = `Rank.${state.currentSelectedRank} ${rankNames[state.currentSelectedRank-1]}`;
            const displayProgress = (currentProgress * (100/3)) + '%';
            const displayCount = `${currentProgress} / 3`;
            if(document.getElementById('dev-bar-fill')) document.getElementById('dev-bar-fill').style.width = displayProgress;
            
            // 음식 가판대 아이콘 표시 (rank >= 8일 때만)
            const foodIconBtn = document.getElementById('food-icon-btn');
            if (foodIconBtn) {
                foodIconBtn.style.display = (state.rank >= 8) ? 'flex' : 'none';
            }
            
            // 라디오 아이콘 표시 (rank >= 3일 때만)
            const radioBtn = document.getElementById('btn-radio');
            if (radioBtn) {
                radioBtn.style.display = (state.rank >= 3) ? 'flex' : 'none';
            }
            
            // 점술집 아이콘 표시 (rank >= 13일 때만)
            const fortuneIconBtn = document.getElementById('fortune-icon-btn');
            if (fortuneIconBtn) {
                fortuneIconBtn.style.display = (state.rank >= 13) ? 'flex' : 'none';
            }
            
            // 라디오 모달이 열려있으면 메시지 업데이트
            const radioModal = document.getElementById('radio-modal');
            if (radioModal && radioModal.style.display === 'flex') {
                // 이미 로드된 상태면 업데이트 안 함 (실시간 리스너가 처리)
            }
            
            // 음식 모달이 열려있으면 메뉴 업데이트
            const foodModal = document.getElementById('food-modal');
            if (foodModal && foodModal.style.display === 'flex') {
                renderFoodMenu();
            }
            
            // 점술집 모달이 열려있으면 캐릭터 목록 업데이트
            const fortuneModal = document.getElementById('fortune-modal');
            if (fortuneModal && fortuneModal.style.display === 'flex') {
                renderFortuneModal();
            }
            if(document.getElementById('dev-count')) document.getElementById('dev-count').innerText = displayCount;
            if(document.getElementById('city-name-display')) document.getElementById('city-name-display').innerText = displayRankName;
            if(document.getElementById('mob-dev-bar-fill')) document.getElementById('mob-dev-bar-fill').style.width = displayProgress;
            if(document.getElementById('mob-dev-count')) document.getElementById('mob-dev-count').innerText = displayCount;
            if(document.getElementById('mob-city-name-display')) document.getElementById('mob-city-name-display').innerText = displayRankName;
            document.getElementById('desk-clicker').src = rankImages[state.currentSelectedRank-1];
            const artCount = state.artifacts.filter(x=>x).length;
            if (document.getElementById('artifact-boost')) document.getElementById('artifact-boost').innerText = artCount > 0 ? `(유물 버프 +${artCount*10}%)` : "";
        }

        function talkToResident(idx) {
            const res = state.residents[idx];
            if(!res) return;

            // 1. 일단 최신 대사집을 가져옵니다 (업데이트 반영)
            const latestDialogues = jobsData[res.job]; 
            
            // 2. 기본은 솔로 대사
            let pool = latestDialogues['Solo'];
            
            // 3. 🔥 관계 상태 체크 (이 부분이 빠져있었어요!)
            if (res.relType === '커플') {
                pool = latestDialogues['Love'];
            } else if (res.relType === '불륜') {
                pool = latestDialogues['Affair'];
            }

            // 4. 스트레스가 높으면 스트레스 대사가 최우선
            if (res.stress > 80) {
                pool = latestDialogues['Stress'];
            }

            // 대사 랜덤 선택 및 출력
            const msg = pool[Math.floor(Math.random()*pool.length)];
            spawnMessage(`${res.name}: "${msg}"`, 'talk');
        }

        function randomDailyEvent() {
            if (state.residents.length < 2) return;

            const p1 = Math.floor(Math.random() * state.residents.length);
            let p2 = Math.floor(Math.random() * state.residents.length);
            while(p1 === p2) { p2 = Math.floor(Math.random() * state.residents.length); } 
            
            const charA = state.residents[p1];
            const charB = state.residents[p2];
            const a = charA.name;
            const b = charB.name;

            // 100가지 이상의 이벤트 패턴
            const patterns = [
                // 💚 소소한 힐링/일상 (호감도 +3~5)
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 빗소리를 들으며 멍하니 창밖을 바라봤어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 따뜻한 합성 코코아를 타주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 낡은 홀로그램 고전 영화를 보며 감동했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'이가')} ${b}의 헝클어진 머리를 정리해 주었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 야식으로 편의점 컵라면을 나눠 먹었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}의 고장 난 소품을 뚝딱 고쳐주었어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 라디오에서 나오는 옛날 노래를 따라 불렀어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 재미있는 유머를 들려주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 어릴 적 사진을 보여주며 웃었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} 피곤한 ${b}의 어깨를 주물러 주었어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 방 구조를 어떻게 바꿀지 상의했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}를 위해 작은 선물을 준비했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 고양이 영상을 보며 힐링했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'이가')} ${b}의 옷차림을 칭찬했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 심야 산책을 다녀왔어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 읽던 책을 추천해 주었어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 타로 점을 봐주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} 잠든 ${b}에게 담요를 덮어주었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 가상현실 게임을 같이 플레이했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'이가')} ${b}의 고민을 진지하게 들어주었어.` },

                // 💖 로맨틱/썸 (호감도 +7~10)
                { t:'love', v:8, m:`${a}${getJosa(a,'와과')} ${b} 사이에 묘한 핑크빛 기류가 흘렀어...` },
                { t:'love', v:9, m:`${a}${getJosa(a,'이가')} ${b}를 지그시 바라보았어. 눈이 마주치자 웃었어.` },
                { t:'love', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 손이 살짝 스치자 얼굴이 붉어졌어.` },
                { t:'love', v:10, m:`${a}${getJosa(a,'이가')} ${b}에게 '너밖에 없어'라고 취중 진담을 했어.` },
                { t:'love', v:8, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 밤새도록 깊은 이야기를 나눴어.` },
                { t:'love', v:9, m:`${a}${getJosa(a,'이가')} ${b}의 잠든 얼굴을 몰래 쳐다봤어.` },
                { t:'love', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 심장 소리를 들었어.` },
                { t:'love', v:8, m:`${a}${getJosa(a,'이가')} ${b}에게 "오늘따라 예쁘다"고 말했어.` },

                // ⚡ 갈등/다툼 (호감도 -5~-10)
                { t:'bad', v:-5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 저녁 메뉴 때문에 투닥거렸어.` },
                { t:'bad', v:-7, m:`${a}${getJosa(a,'이가')} 실수로 ${b}의 아끼는 물건을 떨어뜨렸어.` },
                { t:'bad', v:-6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 정치 이야기로 언성을 높였어.` },
                { t:'bad', v:-8, m:`${a}${getJosa(a,'이가')} ${b}의 촌스러운 취향을 지적했어.` },
                { t:'bad', v:-5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 청소 당번 문제로 신경전을 벌였어.` },
                { t:'bad', v:-10, m:`${a}${getJosa(a,'이가')} ${b}의 말을 무시하고 이어폰을 껴버렸어.` },
                { t:'bad', v:-7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 사소한 오해로 서로 토라졌어.` },
                { t:'bad', v:-9, m:`${a}${getJosa(a,'이가')} ${b}${getJosa(b,'가')} 숨겨둔 간식을 몰래 먹어버렸어.` },
                { t:'bad', v:-6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 에어컨 온도 때문에 싸웠어.` },
                { t:'bad', v:-8, m:`${a}${getJosa(a,'이가')} ${b}에게 퉁명스럽게 대꾸했어.` },

                // 🤖 사이버펑크 세계관 특수 (호감도 랜덤)
                { t:'cyber', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 떨어진 인공위성 파편을 구경했어.` },
                { t:'cyber', v:-4, m:`${a}${getJosa(a,'이가')} ${b}의 바이오 칩을 해킹하려다 들켰어!` },
                { t:'cyber', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 네트워크 다이브를 함께 즐겼어.` },
                { t:'cyber', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 기계 팔 오작동을 고쳐주었어.` },
                { t:'cyber', v:-5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 안드로이드 인권 문제로 토론했어.` },
                { t:'cyber', v:2, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 정전된 방에서 촛불을 켰어.` },
                { t:'cyber', v:3, m:`${a}${getJosa(a,'이가')} ${b}에게 주워온 불법 데이터 칩을 자랑했어.` },
                { t:'cyber', v:0, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 도시의 소음 때문에 잠을 설쳤어.` },
                { t:'cyber', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 새로운 신체 임플란트를 보여주었어.` },
                { t:'cyber', v:-3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 해킹 바이러스 때문에 골머리를 앓았어.` },

                // 🎮 게임/취미 공유 (호감도 +4~6)
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 오래된 보드게임을 꺼내 함께 즐겼어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 자신만의 게임 전략을 알려주었어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 협력 게임에서 완벽한 호흡을 보였어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 게임 실력을 칭찬했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 퍼즐을 함께 풀며 시간 가는 줄 몰랐어.` },

                // 🍜 음식/요리 (호감도 +3~6)
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}를 위해 특별한 야식을 만들어 주었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 레시피를 공유하며 요리 실력을 뽐냈어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}의 취향을 기억해두고 좋아하는 음식을 준비했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 배달 음식을 주문해 나눠 먹었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}에게 자신만의 비밀 레시피를 알려주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 실패한 요리를 웃으며 먹었어.` },

                // 🎨 창작/예술 (호감도 +4~7)
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}에게 자신이 그린 그림을 보여주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 함께 노래를 작사했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 창작물을 진심으로 감상했어.` },
                { t:'good', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 작품에 영감을 받았어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}에게 예술 작품을 해석해 주었어.` },

                // 💼 직업/일 관련 (호감도 +3~5, -3~-6)
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 업무 고민을 들어주며 조언을 해주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 직업 이야기를 나누며 공감했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'이가')} ${b}에게 업무 스킬을 알려주었어.` },
                { t:'bad', v:-4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 업무 스타일 차이로 의견이 맞지 않았어.` },
                { t:'bad', v:-5, m:`${a}${getJosa(a,'이가')} ${b}의 일을 방해했다고 불만을 샀어.` },
                { t:'bad', v:-3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 직장 이야기로 서로 피곤해졌어.` },

                // 🌙 밤/새벽 특수 (호감도 +5~8)
                { t:'love', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 새벽 3시에 깨어나 서로를 발견했어.` },
                { t:'love', v:6, m:`${a}${getJosa(a,'이가')} ${b}와 함께 밤하늘을 올려다봤어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 심야 라디오를 들으며 잠들었어.` },
                { t:'love', v:8, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 새벽에 깊은 대화를 나눴어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}에게 밤새워 준비한 깜짝 선물을 전달했어.` },

                // 🎁 선물/서프라이즈 (호감도 +6~9)
                { t:'love', v:8, m:`${a}${getJosa(a,'이가')} ${b}의 생일을 기억하고 작은 선물을 준비했어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로에게 의미 있는 물건을 선물했어.` },
                { t:'love', v:9, m:`${a}${getJosa(a,'이가')} ${b}를 위해 직접 만든 선물을 전달했어.` },
                { t:'good', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 깜짝 파티를 준비했어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}의 취향에 맞는 선물을 골라줬어.` },

                // 🤝 협력/도움 (호감도 +5~7)
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}의 무거운 짐을 들어주었어.` },
                { t:'good', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 함께 방 청소를 하며 협력했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}의 어려운 일을 도와주었어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 약점을 보완하며 팀워크를 발휘했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}에게 필요한 물건을 빌려주었어.` },

                // 😂 유머/장난 (호감도 +3~5, -2~-4)
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로에게 장난을 쳤지만 웃으며 넘어갔어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}를 웃게 만드는 재치 있는 말을 했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 바보 같은 농담을 주고받으며 웃었어.` },
                { t:'bad', v:-3, m:`${a}${getJosa(a,'이가')} ${b}에게 한 장난이 심하게 느껴졌어.` },
                { t:'bad', v:-2, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 농담이 맞지 않았어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 옛날 추억을 떠올리며 웃었어.` },

                // 🎵 음악/공연 (호감도 +4~6)
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 함께 좋아하는 음악을 들었어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'이가')} ${b}에게 자신만의 플레이리스트를 공유했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 취향이 다른 음악을 교환했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}와 함께 가사를 따라 불렀어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 라이브 공연 영상을 함께 감상했어.` },

                // 📚 학습/지식 공유 (호감도 +4~6)
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}에게 흥미로운 책을 추천해 주었어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 함께 새로운 지식을 공유하며 토론했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 질문에 친절하게 답변해 주었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 전문 분야를 설명해 주었어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}와 함께 다큐멘터리를 보며 배웠어.` },

                // 🏃 운동/건강 (호감도 +3~5)
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 함께 간단한 스트레칭을 했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}를 운동하자고 설득했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 건강한 식단에 대해 이야기했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 운동 루틴을 칭찬했어.` },

                // 🎭 역할극/상황극 (호감도 +4~7)
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 목소리로 연기를 하며 웃었어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}와 함께 영화 대사를 따라했어.` },
                { t:'good', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 즉석 연극을 하며 재미있게 놀았어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 말투를 따라하며 장난쳤어.` },

                // 🌧️ 날씨/계절 (호감도 +3~5)
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 비 오는 날 창가에 앉아 이야기했어.` },
                { t:'good', v:5, m:`${a}${getJosa(a,'이가')} ${b}에게 계절의 변화를 함께 느꼈다고 말했어.` },
                { t:'good', v:3, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 날씨 이야기로 대화를 시작했어.` },
                { t:'good', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 첫눈을 함께 봤어.` },

                // 💭 철학/깊은 대화 (호감도 +6~9)
                { t:'love', v:8, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 인생의 의미에 대해 깊이 이야기했어.` },
                { t:'love', v:7, m:`${a}${getJosa(a,'이가')} ${b}에게 자신의 진짜 생각을 털어놓았어.` },
                { t:'love', v:9, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 꿈과 미래를 나눴어.` },
                { t:'good', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 철학적인 주제로 토론했어.` },

                // 🎪 특별한 순간 (호감도 +7~10)
                { t:'love', v:10, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 우연히 같은 꿈을 꿨다고 발견했어.` },
                { t:'love', v:8, m:`${a}${getJosa(a,'이가')} ${b}와 함께 특별한 순간을 기록했어.` },
                { t:'love', v:9, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 서로의 비밀을 공유하며 더 가까워졌어.` },
                { t:'love', v:7, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 우연히 같은 생각을 하고 있었다는 걸 깨달았어.` },

                // 🤖 사이버펑크 확장 (호감도 랜덤)
                { t:'cyber', v:5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 사이버 공간에서 가상 여행을 했어.` },
                { t:'cyber', v:4, m:`${a}${getJosa(a,'이가')} ${b}의 메모리 백업을 도와주었어.` },
                { t:'cyber', v:-4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} AI 감정 인식 오류로 오해가 생겼어.` },
                { t:'cyber', v:6, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 비디오 방송을 함께 시청했어.` },
                { t:'cyber', v:3, m:`${a}${getJosa(a,'이가')} ${b}에게 사이버 보안 팁을 알려주었어.` },
                { t:'cyber', v:-5, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 데이터 유출 사건으로 불안해했어.` },
                { t:'cyber', v:4, m:`${a}${getJosa(a,'와과')} ${b}${getJosa(b,'은는')} 홀로그램 사진을 함께 찍었어.` }
            ];

            const evt = patterns[Math.floor(Math.random() * patterns.length)];
            
            charA.affection += evt.v;
            charB.affection += evt.v;
            state.residents.forEach(r => { r.affection = Math.max(0, Math.min(100, r.affection)); });

            let heartIcon = evt.v > 0 ? (evt.t==='love'?'💖':'❤️') : (evt.v < 0 ? '💔' : '🤖');
            let valColor = evt.v > 0 ? 'var(--heart)' : (evt.v < 0 ? '#888' : '#ccc');
            let typeLabel = evt.t==='bad'?'⚡ <b>갈등:</b>':(evt.t==='love'?'💖 <b>썸:</b>':(evt.t==='cyber'?'🤖 <b>사건:</b>':'💬 <b>일상:</b>'));

            addHistory(`${typeLabel} ${evt.m} <span style="color:${valColor}">(${heartIcon}${evt.v > 0 ? '+' : ''}${evt.v})</span>`);

            // 관계 변화 로직
            // A. [이별]
            if (charA.partnerId === charB.id && (charA.affection < 30 || charB.affection < 30)) {
                charA.relType = '솔로'; charB.relType = '솔로';
                charA.partnerId = null; charB.partnerId = null;
                showCenterPopup("💔", "결별", `${charA.name} ⚡ ${charB.name}`);
                addHistory(`💔 <b>이별:</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 헤어졌습니다.`);
                saveGame();
            } 
            
            // B. [커플 탄생]
            else if (charA.affection >= 90 && charB.affection >= 90) {
                if (charA.relType === '솔로' && charB.relType === '솔로') {
                    charA.relType = '커플'; charB.relType = '커플';
                    charA.partnerId = charB.id; charB.partnerId = charA.id;
                    addHistory(`💖 <b>축하!</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 연인이 되었습니다!`);
                    saveGame();
                } 
                
                // C. [불륜] 및 기존 연인 정리
                else if (charA.partnerId !== charB.id && (charA.relType === '커플' || charB.relType === '커플')) {
                    if (charA.relType !== '불륜' || charB.relType !== '불륜') {
                        
                        // 1. A의 기존 파트너 정리 (있다면)
                        if (charA.partnerId !== null) {
                            const exA = state.residents[charA.partnerId];
                            if (exA && exA.id !== charB.id) { 
                                exA.relType = '솔로'; 
                                exA.partnerId = null; 
                                exA.stress += 30; 
                            }
                        }

                        // 2. B의 기존 파트너 정리 (있다면)
                        if (charB.partnerId !== null) {
                            const exB = state.residents[charB.partnerId];
                            if (exB && exB.id !== charA.id) { 
                                exB.relType = '솔로'; 
                                exB.partnerId = null; 
                                exB.stress += 30; 
                            }
                        }

                        // 3. 불륜 관계 맺기
                        charA.relType = '불륜'; charB.relType = '불륜';
                        charA.partnerId = charB.id; charB.partnerId = charA.id;

                        addHistory(`😈 <b>충격!</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 금지된 사랑에 빠졌습니다... (기존 연인과는 끝났습니다)`);
                        saveGame();
                    }
                }
            }
            render();
        }

        document.getElementById('desk-clicker').onclick = (e) => { 
            state.money += state.clickPower; 
            const star = document.createElement('div'); star.className = 'hit-effect'; star.innerText = '🌟';
            star.style.left = (e.clientX - 32) + 'px'; star.style.top = (e.clientY - 32) + 'px';
            document.body.appendChild(star); setTimeout(() => star.remove(), 300);
            updateUI(); 
        };

        let isResetting = false;
        function resetGame() {
            if (isResetting) return; // 이미 초기화 중이면 무시
            if (confirm("정말 모든 데이터를 삭제하고 입주 신청서부터 다시 시작할까?\n(주의: 데이터가 영구 삭제됩니다. 단, 업적은 유지됩니다.)")) {
                isResetting = true;
                // 업적 달성 정보 백업
                const unlockedAchievements = state.unlockedAchievements || [];
                
                // 모든 localStorage 데이터 삭제
                localStorage.clear();
                // sessionStorage도 초기화
                sessionStorage.clear();
                
                // 업적 달성 정보 복원 저장
                if (unlockedAchievements.length > 0) {
                    localStorage.setItem('midnight_cottage_unlocked_achievements', JSON.stringify(unlockedAchievements));
                }
                
                // localStorage 변경사항이 확실히 반영되도록 약간의 지연 후 새로고침
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }
        }

        // 라디오 메시지 관련 함수들
        let radioMessagesRef = null; // Firebase 리스너 참조 저장용
        
        function sendRadioMessage() {
            const input = document.getElementById('radio-input');
            if (!input) {
                console.error('radio-input 요소를 찾을 수 없습니다.');
                return;
            }
            
            const text = input.value.trim();
            if (text.length === 0) {
                spawnMessage('메시지를 입력해주세요.', 'event');
                return;
            }
            
            if (text.length > 200) {
                spawnMessage('메시지는 200자 이하로 입력해주세요.', 'event');
                return;
            }
            
            // Firebase 연결 확인
            if (!isFirebaseEnabled || !firebaseDatabase) {
                spawnMessage('❌ Firebase 연결이 필요합니다.', 'event');
                console.warn('Firebase 연결이 없습니다. isFirebaseEnabled:', isFirebaseEnabled, 'firebaseDatabase:', firebaseDatabase);
                return;
            }
            
            // 전송 버튼 비활성화 (중복 전송 방지)
            const sendBtn = document.getElementById('btn-send-radio');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
                sendBtn.innerText = '전송 중...';
            }
            
            // Firebase에 메시지 전송
            const messageData = {
                text: text,
                nickname: '익명',
                timestamp: Date.now()
            };
            
            firebaseDatabase.ref('radio_messages').push(messageData)
                .then(() => {
                    input.value = ''; // 입력창 비우기
                    spawnMessage('✅ 신호가 전송되었습니다.', 'event');
                    
                    // 전송 버튼 다시 활성화
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.style.opacity = '1';
                        sendBtn.innerText = '전송';
                    }
                })
                .catch((error) => {
                    console.error('라디오 메시지 전송 실패:', error);
                    spawnMessage('❌ 신호 전송 실패: ' + (error.message || error.code || '알 수 없는 오류'), 'event');
                    
                    // 전송 버튼 다시 활성화
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.style.opacity = '1';
                        sendBtn.innerText = '전송';
                    }
                });
        }
        
        function loadRadioMessages() {
            const radioList = document.getElementById('radio-list');
            if (!radioList) {
                console.error('radio-list 요소를 찾을 수 없습니다.');
                return;
            }
            
            // Firebase 연결 확인
            if (!isFirebaseEnabled || !firebaseDatabase) {
                radioList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Firebase 연결이 필요합니다.</div>';
                console.warn('Firebase 연결이 없습니다. isFirebaseEnabled:', isFirebaseEnabled, 'firebaseDatabase:', firebaseDatabase);
                return;
            }
            
            // 기존 리스너 제거 (중복 방지)
            if (radioMessagesRef) {
                radioMessagesRef.off('child_added');
                radioMessagesRef = null;
            }
            
            // 메시지 로딩 중 표시
            radioList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">신호 수신 중...</div>';
            
            // 모든 메시지 로드 (클라이언트에서 정렬 및 제한)
            const messagesRef = firebaseDatabase.ref('radio_messages');
            messagesRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    radioList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">아직 신호가 없습니다. 첫 번째 신호를 보내보세요!</div>';
                    setupRealtimeListener();
                    return;
                }
                
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data && data.timestamp) {
                        messages.push({
                            key: childSnapshot.key,
                            text: data.text || '',
                            nickname: data.nickname || '익명',
                            timestamp: data.timestamp
                        });
                    }
                });
                
                // 시간순으로 정렬 (오래된 것부터)
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                // 최근 20개만 표시
                const recentMessages = messages.slice(-20);
                
                // 메시지 렌더링
                renderRadioMessages(recentMessages);
                
                // 실시간 리스너 설정
                setupRealtimeListener();
                
            }).catch((error) => {
                console.error('라디오 메시지 로드 실패:', error);
                radioList.innerHTML = '<div style="color:#ff5555; text-align:center; padding:20px;">메시지를 불러올 수 없습니다.<br>오류: ' + (error.message || error.code) + '</div>';
            });
        }
        
        function setupRealtimeListener() {
            if (!isFirebaseEnabled || !firebaseDatabase) return;
            
            // 실시간 동기화: 새 메시지가 추가되면 자동으로 표시
            radioMessagesRef = firebaseDatabase.ref('radio_messages');
            radioMessagesRef.limitToLast(1).on('child_added', (snapshot) => {
                const messageData = snapshot.val();
                if (!messageData || !messageData.timestamp) return;
                
                const fullMessageData = {
                    key: snapshot.key,
                    text: messageData.text || '',
                    nickname: messageData.nickname || '익명',
                    timestamp: messageData.timestamp
                };
                
                // 이미 표시된 메시지인지 확인 (중복 방지)
                const radioList = document.getElementById('radio-list');
                if (!radioList) return;
                
                if (!radioList.querySelector(`[data-key="${fullMessageData.key}"]`)) {
                    // 기존 메시지가 20개 이상이면 가장 오래된 것 제거
                    const existingMessages = radioList.querySelectorAll('.radio-message-item');
                    if (existingMessages.length >= 20) {
                        existingMessages[0].remove();
                    }
                    
                    // 새 메시지 추가
                    const messageElement = createRadioMessageElement(fullMessageData);
                    radioList.appendChild(messageElement);
                    
                    // 자동 스크롤
                    setTimeout(() => {
                        radioList.scrollTop = radioList.scrollHeight;
                    }, 100);
                }
            });
        }
        
        function renderRadioMessages(messages) {
            const radioList = document.getElementById('radio-list');
            if (!radioList) return;
            
            if (messages.length === 0) {
                radioList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">아직 신호가 없습니다. 첫 번째 신호를 보내보세요!</div>';
                return;
            }
            
            radioList.innerHTML = messages.map(msg => createRadioMessageElement(msg).outerHTML).join('');
            
            // 자동 스크롤
            radioList.scrollTop = radioList.scrollHeight;
        }
        
        function createRadioMessageElement(messageData) {
            const div = document.createElement('div');
            div.className = 'radio-message-item';
            div.setAttribute('data-key', messageData.key);
            div.style.cssText = 'margin-bottom:12px; padding:8px; border-left:2px solid var(--neon-blue); padding-left:12px;';
            
            const time = new Date(messageData.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            div.innerHTML = `<span style="color:#888; font-size:11px;">[${time}]</span> <span style="color:#50fa7b;">${escapeHtml(messageData.text)}</span>`;
            
            return div;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 랭킹 관련 함수들
        const RANKING_KEY = 'midnight_cottage_ranking';
        
        function savePlayerName() {
            const nameInput = document.getElementById('player-name-input');
            if (!nameInput) return;
            
            const name = nameInput.value.trim();
            if (name.length === 0) {
                alert('이름을 입력해주세요!');
                return;
            }
            
            if (name.length > 20) {
                alert('이름은 20자 이하로 입력해주세요!');
                return;
            }
            
            state.playerName = name;
            saveGame();
            
            // 랭킹에 자동 제출
            submitRanking();
            
            spawnMessage('✅ 이름이 저장되었습니다!', 'event');
        }
        
        function submitRanking() {
            if (!state.playerName || state.playerName.trim().length === 0) {
                return;
            }
            
            const rankingData = {
                name: state.playerName,
                rank: state.rank,
                rankName: rankNames[state.rank - 1],
                totalUniquePurchased: state.totalUniquePurchased,
                money: state.money,
                timestamp: Date.now()
            };
            
            // Firebase 사용 가능하면 Firebase에 저장
            if (isFirebaseEnabled && firebaseDatabase) {
                const playerKey = state.playerName.replace(/[.#$\[\]]/g, '_'); // Firebase 키에 사용 불가능한 문자 제거
                const playerRef = firebaseDatabase.ref(`rankings/${playerKey}`);
                
                // 기존 데이터 확인 후 더 높은 점수면 업데이트
                playerRef.once('value', (snapshot) => {
                    const existing = snapshot.val();
                    if (!existing || 
                        rankingData.rank > existing.rank || 
                        (rankingData.rank === existing.rank && rankingData.totalUniquePurchased > existing.totalUniquePurchased)) {
                        playerRef.set(rankingData)
                            .then(() => {
                                console.log('✅ Firebase 랭킹 저장 성공');
                                renderRanking(); // 랭킹 다시 불러오기
                            })
                            .catch((error) => {
                                console.error('❌ Firebase 랭킹 저장 실패:', error);
                                // 실패 시 로컬에 저장 (폴백)
                                saveRankingLocal(rankingData);
                            });
                    } else {
                        console.log('ℹ️ 기존 기록이 더 높아 업데이트하지 않습니다.');
                    }
                });
            } else {
                // Firebase 없으면 로컬에 저장
                saveRankingLocal(rankingData);
            }
        }
        
        function saveRankingLocal(rankingData) {
            // 로컬 랭킹 데이터 가져오기
            let rankings = [];
            try {
                const saved = localStorage.getItem(RANKING_KEY);
                if (saved) {
                    rankings = JSON.parse(saved);
                }
            } catch (e) {
                console.error('랭킹 데이터 로드 실패', e);
            }
            
            // 기존 기록 찾기 (같은 이름이면 업데이트)
            const existingIndex = rankings.findIndex(r => r.name === state.playerName);
            if (existingIndex >= 0) {
                // 더 높은 랭크면 업데이트
                if (rankingData.rank > rankings[existingIndex].rank || 
                    (rankingData.rank === rankings[existingIndex].rank && rankingData.totalUniquePurchased > rankings[existingIndex].totalUniquePurchased)) {
                    rankings[existingIndex] = rankingData;
                }
            } else {
                rankings.push(rankingData);
            }
            
            // 랭크 순으로 정렬 (랭크가 같으면 totalUniquePurchased로)
            rankings.sort((a, b) => {
                if (b.rank !== a.rank) return b.rank - a.rank;
                return b.totalUniquePurchased - a.totalUniquePurchased;
            });
            
            // 최대 100명만 저장
            if (rankings.length > 100) {
                rankings = rankings.slice(0, 100);
            }
            
            // 저장
            try {
                localStorage.setItem(RANKING_KEY, JSON.stringify(rankings));
            } catch (e) {
                console.error('랭킹 데이터 저장 실패', e);
            }
            
            // 랭킹 표시 업데이트
            renderRanking();
        }
        
        function loadRanking(callback) {
            // Firebase 사용 가능하면 Firebase에서 불러오기
            if (isFirebaseEnabled && firebaseDatabase) {
                const rankingsRef = firebaseDatabase.ref('rankings');
                
                rankingsRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    let rankings = [];
                    
                    if (data) {
                        // 객체를 배열로 변환
                        rankings = Object.values(data);
                        
                        // 랭크 순으로 정렬 (랭크가 같으면 totalUniquePurchased로)
                        rankings.sort((a, b) => {
                            if (b.rank !== a.rank) return b.rank - a.rank;
                            return b.totalUniquePurchased - a.totalUniquePurchased;
                        });
                        
                        // 최대 100명만
                        if (rankings.length > 100) {
                            rankings = rankings.slice(0, 100);
                        }
                    }
                    
                    if (callback) callback(rankings);
                }, (error) => {
                    console.error('❌ Firebase 랭킹 로드 실패:', error);
                    // 실패 시 로컬에서 불러오기 (폴백)
                    const localRankings = loadRankingLocal();
                    if (callback) callback(localRankings);
                });
                
                // 실시간 업데이트 리스너 등록
                rankingsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    let rankings = [];
                    
                    if (data) {
                        rankings = Object.values(data);
                        rankings.sort((a, b) => {
                            if (b.rank !== a.rank) return b.rank - a.rank;
                            return b.totalUniquePurchased - a.totalUniquePurchased;
                        });
                        if (rankings.length > 100) {
                            rankings = rankings.slice(0, 100);
                        }
                    }
                    
                    // 랭킹 모달이 열려있으면 자동 업데이트
                    const rankingModal = document.getElementById('ranking-modal');
                    if (rankingModal && rankingModal.style.display === 'flex') {
                        renderRankingWithData(rankings);
                    }
                });
            } else {
                // Firebase 없으면 로컬에서 불러오기
                const localRankings = loadRankingLocal();
                if (callback) callback(localRankings);
            }
        }
        
        function loadRankingLocal() {
            try {
                const saved = localStorage.getItem(RANKING_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('랭킹 데이터 로드 실패', e);
            }
            return [];
        }
        
        function renderRanking() {
            const rankingList = document.getElementById('ranking-list');
            if (!rankingList) return;
            
            rankingList.innerHTML = '<p style="color:#888; font-style:italic; text-align:center;">랭킹 데이터를 불러오는 중...</p>';
            
            loadRanking((rankings) => {
                renderRankingWithData(rankings);
            });
        }
        
        function renderRankingWithData(rankings) {
            const rankingList = document.getElementById('ranking-list');
            if (!rankingList) return;
            
            if (rankings.length === 0) {
                rankingList.innerHTML = '<p style="color:#888; font-style:italic; text-align:center;">아직 랭킹 데이터가 없습니다.<br>이름을 입력하고 게임을 진행하면 랭킹에 등록됩니다!</p>';
                return;
            }
            
            const currentPlayerIndex = rankings.findIndex(r => r.name === state.playerName);
            
            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            
            rankings.forEach((entry, index) => {
                const isCurrentPlayer = entry.name === state.playerName;
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                const rankText = index < 3 ? `${medal} ` : `${index + 1}위 `;
                
                html += `
                    <div style="
                        display:flex; 
                        align-items:center; 
                        justify-content:space-between;
                        padding:12px 15px; 
                        background:${isCurrentPlayer ? 'rgba(187, 154, 247, 0.2)' : 'rgba(255,255,255,0.03)'}; 
                        border:1px solid ${isCurrentPlayer ? 'var(--accent)' : 'rgba(255,255,255,0.1)'}; 
                        border-radius:10px;
                        ${isCurrentPlayer ? 'box-shadow: 0 0 10px rgba(187, 154, 247, 0.3);' : ''}
                    ">
                        <div style="flex:1; min-width:0;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                <span style="color:${index < 3 ? 'var(--gold)' : 'var(--text)'}; font-weight:800; font-size:14px; min-width:50px;">${rankText}</span>
                                <span style="color:${isCurrentPlayer ? 'var(--accent)' : '#fff'}; font-weight:700; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${entry.name}</span>
                                ${isCurrentPlayer ? '<span style="color:var(--accent); font-size:11px;">(나)</span>' : ''}
                            </div>
                            <div style="color:#aaa; font-size:12px;">
                                ${entry.rankName} (Rank.${entry.rank})
                            </div>
                        </div>
                        <div style="text-align:right; margin-left:10px;">
                            <div style="color:var(--gold); font-weight:700; font-size:13px;">건물 ${entry.totalUniquePurchased}개</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (currentPlayerIndex < 0 && state.playerName) {
                html += `
                    <div style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border:1px dashed var(--border); border-radius:8px; text-align:center;">
                        <p style="color:#888; font-size:12px; margin:0;">
                            현재 랭크: <span style="color:var(--gold); font-weight:700;">Rank.${state.rank} ${rankNames[state.rank - 1]}</span><br>
                            이름을 저장하면 랭킹에 등록됩니다!
                        </p>
                    </div>
                `;
            }
            
            rankingList.innerHTML = html;
        }
        

        function openGallery() {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = rankNames.map((name, i) => {
                const isVIP = i >= VIP_ROOM_START_INDEX;
                const unlocked = isVIP ? state.vipUnlocked : (i < state.rank);
                const isSelected = (i + 1) === state.currentSelectedRank;
                const vipBadge = isVIP ? '<div style="position:absolute; top:5px; left:5px; background:var(--gold); color:#000; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:900; z-index:10; box-shadow:0 0 10px rgba(255, 158, 100, 0.5);">후원 전용</div>' : '';
                return `<div class="gallery-item ${unlocked ? 'unlocked' : 'locked'} ${isSelected ? 'active' : ''}" style="position:relative;" onclick="${unlocked ? `selectRoom(${i+1})` : ''}">${vipBadge}<img src="${rankImages[i]}" loading="lazy"><div style="background:rgba(0,0,0,0.6); color:#fff; font-size:12px; font-weight:700;">${i+1}. ${name} ${isSelected ? ' (사용중)' : ''}</div></div>`;
            }).join('');
            toggleModal('gallery-modal');
        }
        
        // VIP 인증 코드 검증 (설정창에서)
        function verifyVIPCodeFromSettings() {
            const codeInput = document.getElementById('vip-code-input-settings');
            const statusDiv = document.getElementById('vip-code-status-settings');
            
            if (!codeInput || !statusDiv) return;
            
            const enteredCode = codeInput.value.trim();
            
            if (enteredCode === '') {
                statusDiv.innerHTML = '<span style="color:#ffaa00;">인증 코드를 입력해주세요</span>';
                return;
            }
            
            // 테스트 코드: test1998 입력 시 엔딩 테스트 조건 설정
            if (enteredCode === 'test1998') {
                // 유토피아(Rank 34) 직전 상태로 설정
                // rank 계산: Math.floor(totalUniquePurchased / 3) + 1
                // rank 33을 유지하려면: Math.floor(totalUniquePurchased / 3) + 1 = 33
                // 즉, Math.floor(totalUniquePurchased / 3) = 32
                // 따라서 totalUniquePurchased는 96, 97, 98 중 하나여야 함
                // 98을 선택하면: Math.floor(98/3) + 1 = 32 + 1 = 33
                state.rank = 33;
                state.currentSelectedRank = 33;
                state.totalUniquePurchased = 98; // rank 33 유지, 유토피아 구매 시 99가 되어 rank 34
                
                // 유토피아 건물(인덱스 99)을 제외한 모든 건물(인덱스 0-98) 구매 상태로 설정
                const utopiaIndex = 99; // 미드나잇 유토피아는 마지막 건물
                for (let i = 0; i < utopiaIndex; i++) {
                    if (state.upgrades[i] && upgrades[i]) {
                        // 구매 상태로 설정 (lv >= 1)
                        if (state.upgrades[i].lv === 0) {
                            state.upgrades[i].lv = 1;
                            // 가격도 업그레이드된 상태로 설정 (upgrades 배열에서 basePrice 가져오기)
                            const basePrice = upgrades[i].basePrice;
                            state.upgrades[i].price = Math.floor(basePrice * 1.6);
                        }
                    }
                }
                
                // 유토피아 건물은 구매하지 않은 상태로 유지 (lv = 0)
                if (state.upgrades[utopiaIndex] && upgrades[utopiaIndex]) {
                    state.upgrades[utopiaIndex].lv = 0;
                    // basePrice를 upgrades 배열에서 가져와서 설정
                    const utopiaBasePrice = upgrades[utopiaIndex].basePrice;
                    state.upgrades[utopiaIndex].price = utopiaBasePrice;
                }
                
                // 유토피아 건물 살 수 있을만큼 돈 설정
                const utopiaBasePrice = upgrades[utopiaIndex] ? upgrades[utopiaIndex].basePrice : Math.floor(15 * Math.pow(1.4, utopiaIndex));
                state.money = utopiaBasePrice * 10;
                
                // VIP도 해금
                state.vipUnlocked = true;
                
                // 주민이 없으면 기본 주민 생성 (엔딩 시퀀스용)
                if (state.residents.length === 0) {
                    const jobs = ["화가", "소설가", "교수", "리퍼닥", "ASMR DJ"];
                    const names = ["테오", "루나", "제이", "키라", "알렉스"];
                    state.residents = jobs.map((job, i) => ({
                        name: names[i],
                        job: job,
                        emoji: jobEmojis[job] || "👤",
                        gender: i % 2 === 0 ? '남' : '여',
                        stress: 0,
                        affection: 50,
                        relType: '솔로',
                        partnerId: null
                    }));
                }
                
                saveGame();
                render();
                updateUI();
                
                statusDiv.innerHTML = '<span style="color:var(--healing); font-weight:800;">✅ 테스트 모드 활성화! 엔딩 테스트 준비 완료!</span>';
                codeInput.value = '';
                
                showCenterPopup('🎮', '테스트 모드', '엔딩 테스트를 위한 조건이 설정되었습니다!<br>미드나잇 유토피아 건물을 구매하면 Rank 34가 되고 엔딩이 시작됩니다.');
                addHistory('🎮 <b>테스트 모드:</b> 엔딩 테스트 조건이 설정되었습니다.');
                
                // 갤러리 업데이트
                setTimeout(() => {
                    if (document.getElementById('gallery-modal').style.display === 'flex') {
                        openGallery();
                    }
                }, 500);
                return;
            }
            
            if (enteredCode !== VIP_CODE) {
                statusDiv.innerHTML = '<span style="color:var(--danger);">❌ 인증 코드가 올바르지 않습니다</span>';
                return;
            }
            
            // 이미 해금된 경우
            if (state.vipUnlocked) {
                statusDiv.innerHTML = '<span style="color:#888;">이미 VIP가 해금되어 있습니다</span>';
                return;
            }
            
            // VIP 해금
            state.vipUnlocked = true;
            saveGame();
            
            statusDiv.innerHTML = '<span style="color:var(--healing); font-weight:800;">✅ 인증 성공! VIP 전용 방이 해금되었습니다!</span>';
            codeInput.value = '';
            
            showCenterPopup('🎉', 'VIP 굿즈 획득!', '고양이 카페, 베이퍼웨이브 신전, 머나먼 야자수의 휴양지 해금!');
            addHistory('🎉 <b>VIP 굿즈:</b> 후원 인증 완료! VIP 전용 방 3개가 해금되었습니다.');
            
            // 갤러리 업데이트
            setTimeout(() => {
                if (document.getElementById('gallery-modal').style.display === 'flex') {
                    openGallery();
                }
            }, 500);
        }
        
    </script>
    </body>
    </html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>미드나잇 코티지 Midnight Cottage</title>
    <style>
        :root {
            --bg: #09090d; --card: #12121a; --accent: #bb9af7; --gold: #ff9e64;
            --neon-blue: #7aa2f7; --heart: #f7768e; --text: #c0caf5; --border: rgba(187, 154, 247, 0.2);
            --female-bg: rgba(255, 182, 193, 0.35); --male-bg: rgba(135, 206, 235, 0.35);
            --healing: #50fa7b; --danger: #ff5555;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: #050507; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--text); overflow: hidden; user-select: none; }
        
        /* PC 기본 레이아웃 */
        #app { width: 98%; max-width: 1350px; height: 96vh; background: var(--bg); border-radius: 24px; display: flex; flex-direction: column; position: relative; transition: all 0.5s ease; box-shadow: 0 0 80px rgba(0,0,0,1); box-sizing: border-box; }
        
        .app-header { padding: 15px 30px; display: grid; grid-template-columns: 350px 1fr 500px; align-items: center; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--border); border-radius: 24px 24px 0 0; z-index: 10; height: auto; min-height: 60px; }
        .header-left { display: flex; flex-direction: column; gap: 8px; }
        .budget-display { font-size: 32px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }
        #news-banner { font-size: 12px; color: var(--neon-blue); font-weight: 700; background: rgba(122, 162, 247, 0.1); padding: 4px 10px; border-radius: 6px; margin-top: 2px; border-left: 3px solid var(--neon-blue); width: fit-content; max-width: 320px; }
        
        /* PC 전용 상태창 */
        #pc-city-status { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        #city-name-display { font-size: 17px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
        .dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        #dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }

        /* 모바일 전용 상태창 */
        #mobile-city-status { display: none; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 5px; flex-direction: column; gap: 4px; }
        #mob-city-name-display { font-size: 15px; color: var(--accent); font-weight: 800; text-shadow: 0 0 10px rgba(187, 154, 247, 0.5); }
        .mob-dev-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); margin-top: 2px; }
        #mob-dev-bar-fill { width: 0%; height: 100%; background: var(--gold); box-shadow: 0 0 10px var(--gold); transition: width 0.4s ease; }
        
        .res-area { display: flex; justify-content: center; gap: 10px; }
        .res-card { display: flex; flex-direction: column; align-items: center; width: 85px; cursor: pointer; position: relative; transition: 0.2s; }
        .res-card:hover { transform: translateY(-5px); }
        .res-icon-box { width: 50px; height: 50px; border-radius: 14px; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; font-size: 24px; position: relative; }
        .stress-box { width: 100%; height: 5px; background: #222; border-radius: 3px; margin-top: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .stress-fill { height: 100%; background: var(--heart); transition: width 0.3s ease; }
        .res-name { font-size: 13px; margin-top: 4px; font-weight: 800; color: #fff; }
        .res-job { font-size: 9px; color: var(--neon-blue); font-weight: 700; margin-top: 1px; }
        .res-rel { font-size: 9px; color: var(--heart); font-weight: 800; text-align: center; min-height: 24px; margin-top: 2px; line-height: 1.2; }
        
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .top-buttons { display: flex; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; transition: 0.3s; position: relative; }
        .icon-btn:hover { background: var(--border); transform: scale(1.1); }
        .noti-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg); display: none; }
        
        /* PC 이벤트 로그 */
        #event-log { 
            font-size: 19px; 
            color: var(--accent); 
            font-weight: 800; 
            text-align: right; 
            line-height: 1.3; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            justify-content: flex-end;
            word-break: keep-all; 
            min-height: 50px; 
        }

        .content-container { flex: 1; display: flex; overflow: hidden; }
        .main-panel { flex: 1.8; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
        #desk-clicker { width: 100%; max-width: 480px; cursor: pointer; transition: transform 0.1s ease, filter 0.3s ease; filter: drop-shadow(0 0 30px rgba(187, 154, 247, 0.2)); margin-top: 40px; margin-bottom: 20px; }
        #desk-clicker:active { transform: scale(0.95); }
        .hit-effect { position: absolute; pointer-events: none; font-size: 65px; z-index: 100; animation: hit-star 0.3s ease-out forwards; }
        @keyframes hit-star { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.1); opacity: 0; } }
        
        /* 대화창 컨테이너 */
        #dialogue-stack { 
            position: absolute; bottom: 120px; z-index: 50; width: 90%; max-width: 500px; 
            display: flex; flex-direction: column-reverse; align-items: center; gap: 8px; pointer-events: none; 
        }
        .dialogue-bubble { 
            background: rgba(0,0,0,0.85); border: 2px solid var(--accent); border-radius: 20px; padding: 12px 20px; 
            font-size: 15px; font-weight: 700; color: #fff; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            animation: slide-up-fade 0.3s ease-out forwards; max-width: 100%; pointer-events: none;
        }
        .dialogue-bubble.event { border-color: var(--gold); color: var(--gold); }
        @keyframes slide-up-fade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out-bubble {
            to { opacity: 0; transform: translateY(-10px); }
        }

        .side-menu { flex: 1.1; background: rgba(0,0,0,0.4); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-sizing: border-box; border-left: 1px solid var(--border); }
        .menu-title { font-size: 17px; font-weight: 800; color: var(--gold); border-left: 4px solid var(--gold); padding-left: 12px; margin-bottom: 10px; }
        
        /* 카드 레이아웃 */
        .up-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 12px 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.03); width: 100%; box-sizing: border-box; min-height: 80px; }
        .up-info { flex: 1; min-width: 0; margin-right: 10px; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .up-info h4 { margin: 0; font-size: 15px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .up-info p { margin: 0; font-size: 13px; color: #aaa; white-space: nowrap; }
        .tags { display: flex; gap: 5px; margin-top: 0; }
        .tag-dev { font-size: 9px; background: rgba(255, 158, 100, 0.2); color: var(--gold); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
        .tag-healing { font-size: 10px; background: rgba(80, 250, 123, 0.2); color: var(--healing); padding: 1px 5px; border-radius: 4px; font-weight: 700; }
        .buy-btn { background: transparent; border: 1.5px solid var(--gold); color: var(--gold); padding: 8px 10px; border-radius: 10px; font-size: 13px; font-weight: 900; cursor: pointer; min-width: 80px; flex-shrink: 0; text-align: center; }
        .buy-btn:disabled { border-color: #2a2a2a; color: #444; }
        
        .toast { background: var(--gold); color: #000; padding: 12px 24px; border-radius: 50px; font-weight: 900; font-size: 18px; box-shadow: 0 0 30px var(--gold); animation: toast-pop 3s forwards; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .evo-toast { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #000; padding: 20px 40px; border-radius: 15px; font-size: 24px; font-weight: 900; z-index: 2000; animation: evo-pop 4s forwards; box-shadow: 0 0 50px var(--accent); text-align: center; border: 4px solid #fff; }
        .center-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 10, 15, 0.95); border: 2px solid var(--gold); color: var(--gold); padding: 25px 50px; border-radius: 20px; font-size: 22px; font-weight: 900; z-index: 2000; animation: fade-in-out 3s forwards; box-shadow: 0 0 40px rgba(255, 158, 100, 0.4); text-align: center; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        @keyframes fade-in-out { 0% { opacity:0; transform:translate(-50%, -40%); } 15% { opacity:1; transform:translate(-50%, -50%); } 85% { opacity:1; transform:translate(-50%, -50%); } 100% { opacity:0; transform:translate(-50%, -60%); } }
        @keyframes evo-pop { 0% { opacity:0; transform:translate(-50%, -30%) scale(0.8); } 10% { opacity:1; transform:translate(-50%, -50%) scale(1.1); } 20% { transform:translate(-50%, -50%) scale(1); } 90% { opacity:1; } 100% { opacity:0; transform:translate(-50%, -70%) scale(0.8); } }
        @keyframes toast-pop { 0% { opacity:0; transform:translateY(20px); } 15% { opacity:1; transform:translateY(0); } 85% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-20px); } }
        
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; padding: 40px; text-align: center; border-radius: 24px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal h2 { margin-top: 0; margin-bottom: 30px; font-size: 28px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 90%; overflow-y: auto; padding: 10px; max-height: 70vh; box-sizing: border-box; }
        .gallery-item { cursor: pointer; border-radius: 12px; border: 2px solid transparent; transition: 0.3s; overflow: hidden; position: relative; background: #181820; display: flex; flex-direction: column; padding-bottom: 10px; height: auto; }
        .gallery-item img { width: 100%; height: 110px; object-fit: cover; opacity: 0.4; display: block; border-bottom: 1px solid #333; }
        .gallery-item.unlocked img { opacity: 1; }
        .gallery-item.active { border-color: var(--gold); box-shadow: 0 0 20px rgba(255, 158, 100, 0.3); }
        .gallery-item div { padding: 5px 10px; box-sizing: border-box; line-height: 1.2; }
        .gallery-item.locked img { display: block; opacity: 0.15; filter: blur(3px) grayscale(100%); }
        .gallery-item.locked::before { content: '🔒'; font-size: 24px; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 5; opacity: 0.7; }
        .museum-container { display: flex; flex-direction: column; align-items: center; gap: 30px; width: 100%; height: 100%; justify-content: center; pointer-events: none; }
        .museum-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 10px; pointer-events: auto; }
        .artifact-slot { width: 85px; height: 85px; background: #111; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; border-radius: 15px; cursor: pointer; font-size: 32px; transition: 0.3s; pointer-events: auto; }
        .artifact-slot.found { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 158, 100, 0.3); }
        #artifact-desc { pointer-events: auto; color:#aaa; font-style:italic; font-size: 18px; margin-top: 20px; }
        #history-list li { margin-bottom: 12px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px; color: #ccc; }
        
        #start-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050507; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text); }
        .start-form { background: var(--card); padding: 40px; border-radius: 24px; border: 1px solid var(--border); width: 400px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 700; color: var(--gold); }
        .form-group input, .form-group select { background: #1a1a24; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; font-family: 'Pretendard'; outline: none; }
        .form-group input::placeholder { color: #666; font-style: italic; }
        .form-group input:focus, .form-group select:focus { border-color: var(--neon-blue); }
        .nav-btns { display: flex; gap: 10px; margin-top: 15px; }
        .start-btn { flex: 1; background: var(--accent); color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; }
        .start-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--accent); }
        .prev-btn { flex: 0.4; background: #333; color: #fff; border-radius: 12px; font-weight: 700; border:none; cursor: pointer; }
        .finish-btn { flex: 1; background: #50fa7b; color: #000; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; display: none; }
        .finish-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px #50fa7b; }
        #char-count { position: absolute; top: 20px; right: 20px; font-size: 14px; color: #666; font-weight: 900; }
        .sns-container { width: 450px; height: 600px; background: var(--card); border: 2px solid var(--border); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .sns-header { background: rgba(0,0,0,0.5); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sns-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .sns-post { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .sns-user { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .sns-avatar { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        .sns-name { font-size: 14px; font-weight: 700; color: #fff; }
        .sns-time { font-size: 11px; color: #666; margin-left: auto; }
        .sns-text { font-size: 13px; color: #ccc; line-height: 1.4; }
        
        .gacha-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 400px; text-align: center; }
        .gacha-btn { background: var(--accent); color: #000; padding: 20px; border-radius: 15px; font-weight: 900; font-size: 20px; border: none; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(187, 154, 247, 0.4); display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .gacha-btn:hover { transform: scale(1.05); }
        .gacha-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; transform: none; }
        .gacha-cost { font-size: 14px; opacity: 0.8; }
        
        .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; max-height: 500px; overflow-y: auto; }
        .ach-item { background: #1a1a24; padding: 15px; border-radius: 12px; border: 1px solid #333; opacity: 0.5; transition: 0.3s; }
        .ach-item.unlocked { opacity: 1; border-color: var(--gold); background: rgba(255, 158, 100, 0.05); }
        .ach-icon { font-size: 24px; margin-bottom: 5px; }
        .ach-title { font-weight: 800; color: #fff; font-size: 14px; }
        .ach-desc { font-size: 11px; color: #aaa; margin-top: 3px; }
        
        /* 💌 엔딩 시퀀스 스타일 */
        #ending-sequence { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .rolling-container { text-align: center; opacity: 0; transform: translateY(20px); transition: 1s ease; display: flex; flex-direction: column; align-items: center; }
        .rolling-container.show { opacity: 1; transform: translateY(0); }
        .end-emoji { font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--accent)); }
        .end-name { font-size: 24px; font-weight: 800; color: var(--gold); margin-bottom: 20px; }
        .end-msg { font-size: 22px; color: #fff; font-weight: 300; line-height: 1.6; max-width: 80%; margin: 0 auto; word-break: keep-all; font-family: 'Pretendard', serif; }
        .ending-btn { background: var(--gold); color: #000; padding: 15px 30px; border-radius: 30px; font-weight: 900; font-size: 18px; border: none; cursor: pointer; transition: 0.3s; }
        .ending-btn:hover { transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        /* 🌟 2. 모바일 반응형 CSS */
        @media (max-width: 768px) {
            body { height: 100vh; overflow: hidden; position: fixed; width: 100%; }
            #app { height: 100%; width: 100%; border-radius: 0; display: flex; flex-direction: column; }

            /* 🛠️ [모바일] 헤더 순서 재배치: 돈(1) -> 메뉴(2) -> 주민(3) */
            .app-header { display: flex; flex-direction: column; padding: 5px 15px 15px 15px; gap: 2px; height: auto; flex-shrink: 0; align-items: center; border-bottom: none; }
            
            .header-left { width: 100%; order: 1; align-items: flex-start; margin-bottom: 0px; }
            .budget-display { font-size: 24px; margin: 0; justify-content: flex-start; white-space: nowrap; width: 100%; }
            #news-banner { display: none; }
            #pc-city-status { display: none; }

            /* 🛠️ [모바일] 상단 메뉴 아이콘 가로 중앙 정렬 */
            .header-right { width: 100%; order: 2; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; margin-top: 5px; }
            .top-buttons { width: 100%; display: flex; gap: 12px; margin: 0; flex-wrap: nowrap; overflow-x: auto; justify-content: center; }
            .icon-btn { width: 38px; height: 38px; font-size: 18px; flex-shrink: 0; }
            
            /* [모바일] 이벤트 로그 텍스트 숨김 */
            #event-log { display: none !important; }

            /* 🛠️ [모바일] 주민 목록 가로 중앙 정렬 */
            .res-area { order: 3; width: 100%; margin-top: 10px; padding-bottom: 2px; overflow-x: auto; justify-content: center; display: flex; }
            .res-card { min-width: 55px; margin-right: 5px; transform: none !important; transition: none !important; }
            .res-card:hover, .res-card:active { transform: none !important; margin-top: 0 !important; }
            .res-icon-box { width: 40px; height: 40px; font-size: 20px; }
            .res-name { font-size: 10px; margin-top: 2px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
            /* 🛠️ [모바일 수정] 직업과 관계(솔로/커플) 모두 표시 */
            .res-job { 
                display: block !important; 
                font-size: 8px; 
                color: var(--neon-blue); 
                margin-top: 1px;
                white-space: nowrap;
            }
            .res-rel { 
                display: block !important; 
                font-size: 8px; 
                color: var(--heart); 
                margin-top: 0px;
                white-space: nowrap;
            }

            .content-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

            .main-panel { flex: 0 0 35%; padding: 0; order: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
            #desk-clicker { width: 100%; height: 100%; object-fit: contain; margin: 0; }
            /* 대화창 위치 조정 */
            #dialogue-stack { bottom: 10px; width: 90%; gap: 6px; }
            .dialogue-bubble { font-size: 13px; padding: 10px; }

            /* 🛠️ [모바일] 사이드 메뉴(정보창) 여백 타이트하게 조정 */
            .side-menu { flex: 1; order: 2; height: auto; overflow-y: auto; border-top: 2px solid var(--border); background: rgba(0,0,0,0.9); padding: 10px 15px 80px 15px; }
            #mobile-city-status { display: flex; margin-bottom: 5px; padding: 8px; } 
            
            /* 🔥 [수정] 1. 개발일지 왼쪽 정렬 */
            .menu-title { margin-bottom: 5px; text-align: left; border-left: none; padding-left: 0; }
            
            /* 🔥 [수정] 2. 업그레이드 카드 세로 정렬 및 버튼 하단 배치 */
            .up-card { flex-direction: column; align-items: flex-start; padding: 12px; min-height: auto; margin-bottom: 8px; gap: 8px; }
            .up-info { width: 100%; margin-right: 0; }
            .up-info h4, .up-info p { white-space: normal; word-break: keep-all; overflow: visible; } /* 텍스트 줄바꿈 허용 */
            .buy-btn { width: 100%; margin-top: 5px; height: 40px; } /* 버튼 하단 꽉 채우기 */

            .evo-toast { width: 85%; min-width: unset; white-space: nowrap; font-size: 16px; padding: 12px 10px; bottom: 35%; border-width: 2px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

            .modal h2, #history-modal h2 { margin-top: 0 !important; margin-bottom: 15px !important; padding-top: 0 !important; line-height: 1.2; transform: translateY(-10px); }
            #history-list { padding-top: 0 !important; margin-top: 0 !important; }

            .sns-container { width: 100%; height: 75%; margin-top: -20px; margin-bottom: 20px; }

            .museum-container { width: 100%; display: flex; flex-direction: column; padding: 10px 0; overflow-x: hidden; height: 100%; }
            .museum-container h2 { order: 1; flex-shrink: 0; }
            #artifact-desc { order: 2; margin-bottom: 10px; margin-top: 0; font-size: 13px; color: var(--neon-blue); min-height: 20px; flex-shrink: 0; }
            .museum-grid { order: 3; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 95%; margin: 0 auto; padding: 0 5px 100px 5px; box-sizing: border-box; overflow-y: auto; }
            .artifact-slot { width: 100%; aspect-ratio: 1 / 1; font-size: 14px; } 

            .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 5px 80px 5px; width: 100%; box-sizing: border-box; overflow-y: auto; }
            .gallery-item { width: 100%; height: auto; display: flex; flex-direction: column; }
            .gallery-item img { width: 100%; height: auto; aspect-ratio: 16 / 9; object-fit: cover; }

            .modal { position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; z-index: 9999; padding: 20px; box-sizing: border-box; }
            .start-form { width: 90%; max-width: 350px; padding: 20px; box-sizing: border-box; margin: 0 auto; }
            .gacha-container { width: 100%; }
        }

        /* 🔘 [추가] 버튼 클릭 뽀잉 애니메이션 */
        @keyframes boing {
            0% { transform: scale(1); }
            40% { transform: scale(0.9); }  /* 꾹 눌림 */
            60% { transform: scale(1.1); }  /* 띠용 하고 커짐 */
            100% { transform: scale(1); }   /* 원상복구 */
        }
        .click-animate {
            animation: boing 0.3s ease-out forwards;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen" style="display:flex;">
        <div class="start-form">
            <h2 style="text-align:center; color:var(--accent); margin-bottom:10px;">📄 입주 신청서</h2>
            
            <div style="background:rgba(66, 133, 244, 0.1); border:1px solid rgba(66, 133, 244, 0.3); border-radius:12px; padding:10px; margin-bottom:15px; text-align:center;">
                <p style="font-size:12px; color:#ccc; margin:0 0 8px 0;">이미 미드나잇 코티지에 살고 계신가요?</p>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button id="btn-login-start" onclick="googleLogin()" style="background:#4285F4; color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; width: 100%;">
                        G 구글 로그인으로 데이터 불러오기
                    </button>
                </div>
            </div>

            <div id="char-count">1 / 5</div>
            <div class="form-group">
                <label>이름 (닉네임)</label>
                <input type="text" id="input-name" placeholder="이름을 정해주세요">
            </div>
            <div class="form-group">
                <label>성별</label>
                <select id="input-gender">
                    <option value="남">남성</option>
                    <option value="여">여성</option>
                    <option value="무">무성/기타</option>
                </select>
            </div>
            <div class="form-group">
                <label>직업 (선택)</label>
                <select id="input-job">
                    <option value="화가">🎨 화가</option>
                    <option value="소설가">✍️ 소설가</option>
                    <option value="교수">📚 교수</option>
                    <option value="리퍼닥">🛠️ 리퍼닥</option>
                    <option value="ASMR DJ">🎧 ASMR DJ</option>
                    <option value="모델">👠 모델</option>
                    <option value="형사">🕵️ 형사</option>
                    <option value="넷러너">💻 넷러너</option>
                    <option value="라멘노점상">🍜 라멘노점상</option>
                    <option value="온천주인">♨️ 온천주인</option>
                    <option value="LP바 사장님">💿 LP바 사장님</option>
                    <option value="뮤지션">🎸 뮤지션</option>
                    <option value="고양이">🐱 고양이</option>
                    <option value="VIP">👑 VIP</option>
                </select>
            </div>
            <div class="nav-btns">
                <button class="prev-btn" onclick="prevChar()" id="btn-prev" style="display:none;">이전</button>
                <button class="start-btn" onclick="nextChar()" id="btn-next">추가 (1/5)</button>
                <button class="finish-btn" onclick="finishSetup()" id="btn-finish">입주 시작</button>
            </div>
        </div>
    </div>

    <div id="ending-sequence">
        <div class="rolling-container">
            <div id="end-emoji" class="end-emoji"></div>
            <div id="end-name" class="end-name"></div>
            <div id="end-msg" class="end-msg"></div>
        </div>
        <div id="final-screen" style="display:none; text-align:center; z-index:6005;">
            <h1 style="font-size:40px; color:var(--accent); margin-bottom:20px;">The End</h1>
            <p style="color:#ccc; margin-bottom:30px; line-height: 1.6;">
                미드나잇 코티지의 밤은 계속됩니다.<br>
                당신의 작업도 이들처럼 빛나기를.
            </p>
            <button class="ending-btn" onclick="closeEndingSequence()">남아서 계속하기</button>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <div class="app-header">
        <div class="header-left">
            <div class="budget-display">💵 <span id="budget">0</span></div>
            <div id="news-banner">📢 뉴스 로딩 중...</div>
            <div id="pc-city-status">
                <div id="city-name-display">소박하고 아늑한 사이버펑크 방</div>
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span style="color:var(--gold); font-weight:800;">⭐ 발전도</span>
                        <div onclick="toggleModal('dev-info-modal')" 
                             style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                    </div>
                    <div id="dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                </div>
                <div class="dev-bar-bg"><div id="dev-bar-fill"></div></div>
            </div>
        </div>
        
        <div class="res-area" id="res-grid"></div>
        
        <div class="header-right">
            <div class="top-buttons">
                <button class="icon-btn" onclick="toggleModal('shop-modal')">🏺</button>
                <button class="icon-btn" onclick="toggleModal('sns-modal')">📱<div id="sns-dot" class="noti-dot"></div></button>
                <button class="icon-btn" onclick="toggleModal('ach-modal')">🏆</button>
                <button class="icon-btn" onclick="openGallery()">🖼️</button>
                <button class="icon-btn" onclick="toggleModal('museum-modal')" style="font-size:12px !important;">🏛️</button>
                <button class="icon-btn" onclick="toggleModal('history-modal')">📜</button>
                <button class="icon-btn" onclick="toggleModal('help-modal')">?</button>
            </div>
            <div id="event-log">💻작업 화이팅! 미드나잇 코티지가 너를 반겨.</div>
        </div>
    </div>

    <div class="content-container">
        <div class="main-panel">
            <img id="desk-clicker" src="https://i.imgur.com/MuFQQ5A.png" alt="City Image">
            <div id="dialogue-stack"></div>
        </div>
        <div class="side-menu">
            <div class="menu-title">미드나잇 시티 개발일지 <span id="artifact-boost" style="font-size:11px; color:var(--gold)"></span></div>
            
            <div id="mobile-city-status">
                <div id="mob-city-name-display">소박하고 아늑한 사이버펑크 방</div>
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:3px; margin-top:2px;">
                    <div style="display:flex; align-items:center; gap:4px;">
                        <span style="color:var(--gold); font-weight:800;">⭐ 발전도</span>
                        <div onclick="toggleModal('dev-info-modal')" 
                             style="cursor:pointer; border:1px solid #666; border-radius:50%; width:13px; height:13px; display:flex; justify-content:center; align-items:center; color:#aaa; font-size:9px;">?</div>
                    </div>
                    <div id="mob-dev-count" style="color:#fff; font-weight:700;">0 / 5</div>
                </div>
                <div class="mob-dev-bar-bg"><div id="mob-dev-bar-fill"></div></div>
            </div>

            <div id="upgrade-list"></div>
        </div>
    </div>

    <div id="gallery-modal" class="modal" onclick="closeModalByBg(event, 'gallery-modal')">
        <h2 style="color:var(--gold); pointer-events:none;">🖼️ 코티지 룸 갤러리</h2>
        <div id="gallery-grid" class="gallery-grid" onclick="event.stopPropagation()"></div>
    </div>
    <div id="museum-modal" class="modal" onclick="closeModalByBg(event, 'museum-modal')">
        <div class="museum-container">
            <h2 style="color:var(--gold); margin: 0; pointer-events: none;">🏛️ 2202년 역사 박물관 (2026 유물)</h2>
            <div id="museum-list" class="museum-grid"></div>
            <p id="artifact-desc" style="pointer-events: none;">유물을 클릭하면 테오 교수의 한 줄 평이 나옵니다.</p>
        </div>
    </div>
    <div id="history-modal" class="modal" onclick="closeModalByBg(event, 'history-modal')">
        <h2 style="color:var(--accent); margin-bottom: 20px; pointer-events:none;">📜 미드나잇 코티지 기록</h2>
        <ul id="history-list" style="width:90%; text-align:left; overflow-y:auto; max-height:500px; padding:0 30px; list-style:none;" onclick="event.stopPropagation()"></ul>
    </div>
    <div id="shop-modal" class="modal" onclick="closeModalByBg(event, 'shop-modal')">
        <h2 style="color:#bd93f9;">🏺 고대 유물 박물관 (Artifacts)</h2>
        <div class="gacha-container" onclick="event.stopPropagation()">
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">
                2026년의 잊혀진 고대 유물을 발굴하고 복원하는 곳입니다.<br>
                유물을 복원하여 전시하면 <b>전체 수익 보너스</b>를 얻습니다.
            </p>
            <button class="gacha-btn" id="btn-gacha" onclick="buyArtifact()">
                ⛏️ 유물 발굴 및 복원 시도
                <span class="gacha-cost" id="gacha-price"></span>
            </button>
        </div>
    </div>
    <div id="sns-modal" class="modal" onclick="closeModalByBg(event, 'sns-modal')">
        <div class="sns-container">
            <div class="sns-header">
                <span style="font-weight:900; color:var(--neon-blue);">📱 Midnight Talk</span>
                <span style="font-size:12px; color:#666;">실시간</span>
            </div>
            <div id="sns-feed" class="sns-feed"></div>
        </div>
    </div>
    <div id="ach-modal" class="modal" onclick="closeModalByBg(event, 'ach-modal')">
        <h2 style="color:var(--gold);">🏆 비밀 업적</h2>
        <div id="ach-grid" class="ach-grid" onclick="event.stopPropagation()"></div>
    </div>
    <div id="help-modal" class="modal" onclick="closeModalByBg(event, 'help-modal')">
        <div onclick="event.stopPropagation()" style="background:var(--card); padding:30px; border-radius:20px; border:1px solid var(--border); text-align:center; min-width: 300px;">
            <h2 style="color:var(--gold)">🏠 설정 및 가이드</h2>
            <p style="font-size:15px; line-height:1.8; color:#ccc; margin-bottom: 20px;">
                1. <b>🏺 유물 박물관</b>에서 유물을 복원해 수익을 뻥튀기하세요.<br>
                2. <b>📱 미드나잇 톡</b>에서 주민들의 속마음을 엿보세요.<br>
                3. 마지막 <b>유토피아 랭크</b>에 도달하면 엔딩!
            </p>
            
            <div style="margin-bottom: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <h3 style="margin-top:0; font-size:16px; color:var(--neon-blue); margin-bottom: 10px;">☁️ 데이터 백업</h3>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button id="btn-login-help" onclick="googleLogin()" style="background:#4285F4; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">
                        G 구글 계정 연동
                    </button>
                </div>
                <p id="cloud-status-msg" style="font-size:11px; color:#888; margin-top:8px;">
                    * 로그인 시 4초마다 자동으로 클라우드에 저장됩니다.
                </p>
            </div>

            <button onclick="resetGame()" style="background:var(--danger); color:#fff; border:none; padding:12px 20px; border-radius:12px; font-weight:900; cursor:pointer; font-size:14px; box-shadow:0 0 10px rgba(255, 85, 85, 0.3); width: 100%;">
                ⚠️ 데이터 초기화 (처음부터)
            </button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // 2. Firebase 설정 및 초기화
    const firebaseConfig = {
        apiKey: "AIzaSyDAS2-ax-ORpsnGoG6XNsMx3rlQ9yJMkUc",
        authDomain: "midnight-cottage-server.firebaseapp.com",
        projectId: "midnight-cottage-server",
        storageBucket: "midnight-cottage-server.firebasestorage.app",
        messagingSenderId: "680262922046",
        appId: "1:680262922046:web:bd79062e2bf1f20464866f"
    };

    // Firebase 실행
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null; // 현재 로그인한 유저 정보

    // 3. 전역 변수 선언
    const state = {
        money: 0, clickPower: 1, autoIncome: 1, 
        upgrades: [], history: [], artifacts: Array(20).fill(false),
        rank: 1, currentSelectedRank: 1, totalUniquePurchased: 0,
        residents: [], achievements: [], endingSeen: false
    };

    // 4. Firebase 로그인 및 클라우드 함수들
    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then((result) => {
                alert(`반가워요, ${result.user.displayName}님! 계정이 연동되었습니다.`);
            })
            .catch((error) => {
                console.error(error);
                alert("로그인 실패: " + error.message);
            });
    }

    // 🌟 로그인 상태에 따라 버튼 모양을 바꿔주는 함수
    function updateAuthUI(user) {
        const loginBtnStart = document.getElementById('btn-login-start');
        const loginBtnHelp = document.getElementById('btn-login-help');
        const msg = document.getElementById('cloud-status-msg');

        if (user) {
            // 로그인 되었을 때: 버튼 비활성화 및 텍스트 변경
            if(loginBtnStart) {
                loginBtnStart.innerText = `✅ 연동됨 (${user.displayName})`;
                loginBtnStart.disabled = true;
                loginBtnStart.style.opacity = "0.7";
                loginBtnStart.style.cursor = "default";
            }
            if(loginBtnHelp) {
                loginBtnHelp.innerText = `✅ 연동 완료: ${user.displayName}`;
                loginBtnHelp.disabled = true;
                loginBtnHelp.style.opacity = "0.7";
                loginBtnHelp.style.cursor = "default";
            }
            if(msg) msg.innerText = `* ${user.displayName}님의 계정에 안전하게 자동 저장되고 있습니다.`;
        } else {
            // 로그아웃 상태일 때: 원래대로 복구
            if(loginBtnStart) { loginBtnStart.innerText = "G 구글 로그인으로 데이터 불러오기"; loginBtnStart.disabled = false; }
            if(loginBtnHelp) { loginBtnHelp.innerText = "G 구글 계정 연동"; loginBtnHelp.disabled = false; }
        }
    }

    // 데이터 불러오기
    function loadDataFromCloud() {
        if (!currentUser) return;
        db.collection("users").doc(currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    Object.assign(state, data); // 데이터 덮어쓰기
                    
                    // UI 갱신
                    render(); 
                    updateUI();
                    renderAchievements();
                    
                    showCenterPopup("🔄", "데이터 동기화", "클라우드 데이터를 불러왔습니다.");
                    addHistory("☁️ <b>클라우드:</b> 저장된 데이터를 불러왔습니다.");

                    // 저장된 데이터가 있으면 바로 시작
                    document.getElementById('start-screen').style.display = 'none';
                } else {
                    console.log("저장된 데이터가 없습니다.");
                }
            })
            .catch((error) => {
                console.error("불러오기 실패: ", error);
            });
    }
    
    // 로그인 상태 감지 리스너
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log("로그인 됨:", user.displayName);
            updateAuthUI(user);
            loadDataFromCloud();
        } else {
            currentUser = null;
            updateAuthUI(null);
            console.log("로그아웃 상태");
        }
    });

    // 5. 게임 데이터 및 로직
    const jobEmojis = {
        "화가": "🎨", "소설가": "✍️", "교수": "📚", "리퍼닥": "🛠️",
        "ASMR DJ": "🎧", "모델": "👠", "형사": "🕵️", "넷러너": "💻",
        "라멘노점상": "🍜", "온천주인": "♨️", "LP바 사장님": "💿",
        "뮤지션": "🎸", "고양이": "🐱", "VIP": "👑"
    };

    const jobsData = {
        "화가": { 'Solo': ["네온 물감이 몽글몽글해.", "이 색채는 너를 닮았어.", "붓 끝에서 새벽이 피어나.", "캔버스는 아직 미완성이야."], 'Love': ["네 눈동자 색을 담고 싶어.", "너랑 있으면 세상이 형광빛이야.", "가장 완벽한 색은 너야."], 'Affair': ["비밀스러운 색이 매혹적이지.", "금지된 선을 넘는 건 짜릿해.", "몰래 그리는 네 초상화가 좋아."], 'Stress': ["붓을 꺾어버리고 싶어!", "아무것도 그리기 싫어.", "세상이 온통 회색이야."] },
        "소설가": { 'Solo': ["문장들이 춤을 추네.", "이 도시의 모든 건 소설감이야.", "엔딩을 어떻게 낼까?"], 'Love': ["너와의 사랑은 베스트셀러야.", "내 소설의 주인공은 너야.", "해피엔딩만 쓰고 싶어."], 'Affair': ["금지된 챕터를 쓰는 기분이야.", "독자는 모르는 우리만의 반전.", "위험한 복선처럼 너에게 끌려."], 'Stress': ["글자가 벌레처럼 보여!", "원고지 다 불태울 거야!", "내 인생은 실패작이야."] },
        "교수": { 'Solo': ["역사는 반복되지.", "오래된 책 냄새가 좋아.", "2026년은 참 낭만적이었군."], 'Love': ["너는 역사상 가장 아름다워.", "너를 평생 연구하고 싶어.", "고전 시보다 네가 더 우아해."], 'Affair': ["금지된 역사만큼 흥미롭군.", "도덕적 잣대보다 네가 중요해.", "이건 비밀 수업이야."], 'Stress': ["데이터 찌꺼기들! 조용히 해!", "지식은 다 쓸모없어.", "책을 다 찢고 싶군."] },
        "리퍼닥": { 'Solo': ["기계는 거짓말 안 해.", "어디 고장 난 곳 없어?", "기름 냄새가 향긋하네."], 'Love': ["내 심장 엔진은 너 때문에 돌아가.", "널 위해 최고의 부품을 준비했어.", "너 없으면 난 셧다운이야."], 'Affair': ["보안 프로토콜을 우회했어.", "위험한 오버클럭 중이야.", "합선될 것처럼 짜릿해."], 'Stress': ["다 고물상에 버려버려!", "스파크가 튀어! 내 머리도!", "망할 기계 덩어리들."] },
        "ASMR DJ": { 'Solo': ["빗소리 들려줄까?", "팅글이 느껴지니?", "오늘 밤은 내 목소리와 함께해."], 'Love': ["너에게만 들려주는 속삭임이야.", "네 숨소리가 최고의 ASMR이야.", "우리 주파수는 일치해."], 'Affair': ["마이크 끄고 비밀 얘기할까?", "방송 사고 같은 사랑이야.", "남들은 모르는 시그널."], 'Stress': ["소리 지르고 싶어!", "이명이 들려, 괴로워.", "모든 소음이 끔찍해."] },
        "모델": { 'Solo': ["오늘 내 크롬 광택 완벽해?", "플래시 세례는 지겨워.", "이 거리는 내 런웨이야."], 'Love': ["나보다 네가 더 빛나.", "우리 투샷은 화보 그 자체야.", "너만의 뮤즈가 될게."], 'Affair': ["스캔들? 상관없어.", "카메라 뒤에서 만나는 게 좋아.", "위험할수록 더 스타일리시해."], 'Stress': ["내 얼굴 보지 마!", "조명 다 꺼버려!", "다들 나를 껍데력이만 봐."] },
        "형사": { 'Solo': ["비 내리는 거리는 증거를 감추지.", "합성 담배 연기가 맵군.", "직감이 왔어."], 'Love': ["넌 내가 찾던 마지막 퍼즐이야.", "네가 범인이라면 체포당해줄게.", "내 총구는 널 지키기 위해서만 들어."], 'Affair': ["잠복근무 핑계 대고 나왔어.", "이 관계는 일급 기밀이야.", "증거를 남기지 마."], 'Stress': ["이 도시는 썩었어.", "범인도 정의도 다 지겨워.", "머리가 깨질 것 같군."] },
        "넷러너": { 'Solo': ["아이스를 뚫는 건 식은 죽 먹기지.", "현실보다 네트워크가 편해.", "데이터 흐름이 아름다워."], 'Love': ["네 뇌와 동기화하고 싶어.", "내 방화벽을 해제할 유일한 사람.", "넌 내 최고의 알고리즘이야."], 'Affair': ["백도어로 몰래 접속했어.", "로그는 전부 삭제할게.", "바이러스처럼 치명적이야."], 'Stress': ["뇌가 타버릴 것 같아!", "연결 끊어! 강제 로그아웃!", "노이즈 때문에 미치겠어."] },
        "라멘노점상": { 'Solo': ["육수 끓는 냄새, 끝내주지?", "따뜻한 국물 한 그릇 하고 가.", "오늘도 손님이 많네."], 'Love': ["너한텐 차슈 무제한이야.", "국물보다 네 마음이 더 따뜻해.", "평생 라멘 만들어줄게."], 'Affair': ["셔터 내리고 몰래 만날까?", "매운맛보다 더 화끈하네.", "육수 식기 전에 빨리 와."], 'Stress': ["육수 엎어버리고 싶다.", "손님들 다 나가라고 해!", "면이 다 불어터졌어."] },
        "온천주인": { 'Solo': ["물 온도가 딱 좋아.", "피로가 싹 풀릴 거야.", "유황 냄새, 익숙해지면 좋아."], 'Love': ["너랑 혼욕... 농담이야.", "내 마음도 온천처럼 뜨거워.", "넌 내 온천의 꽃이야."], 'Affair': ["탈의실 뒤쪽에서 봐.", "습기 때문에 얼굴이 빨개졌어.", "위험한 온도가 되고 있어."], 'Stress': ["물 다 빼버려!", "손님들 너무 시끄러워.", "머리가 핑 도네."] },
        "LP바 사장님": { 'Solo': ["이 곡은 20세기 명곡이지.", "재즈가 흐르는 밤이야.", "위스키 한 잔 줄까?"], 'Love': ["이 노래는 널 위한 거야.", "너의 목소리가 최고의 음악이야.", "우리 사랑을 레코드에 담고 싶어."], 'Affair': ["가게 문 잠그고 시작할까?", "비밀스러운 리듬을 타보자.", "금지된 곡을 트는 기분이야."], 'Stress': ["음악 꺼! 조용히 해!", "술병 다 깨버리고 싶군.", "이따위 싸구려 음악 안 틀어."] },
        "뮤지션": { 'Solo': ["새로운 코드가 떠올랐어.", "내 기타 솔로 어때?", "이 도시는 내 무대야."], 'Love': ["널 위한 세레나데를 만들었어.", "네 심장 박동에 템포를 맞출게.", "넌 내 영감의 원천이야."], 'Affair': ["백스테이지에서 몰래 봐.", "이건 앵콜 없는 공연이야.", "위험한 락앤롤이지."], 'Stress': ["기타 줄 다 끊어버렸어.", "악상이 안 떠올라!", "다들 내 음악을 모욕해."] },
        "고양이": { 'Solo': ["야옹. (밥 줘.)", "고롱고롱... (만족)", "식빵 굽는 중이야.", "높은 곳이 좋아.", "박스다! 내 거야."], 'Love': ["야아옹~ (너한테 부비적)", "골골송 부르는 중이야.", "너 배 위가 제일 따뜻해.", "꾹꾹이 해줄게."], 'Affair': ["캬옹! (다른 집사 냄새가 나!)", "살금살금 밤마실 다녀올게.", "몰래 츄르 훔쳐먹었어.", "비밀 친구가 생겼다옹."], 'Stress': ["하악!! (건들지 마!)", "캬아아악! (저리 가!)", "꼬리 펑! 털 쭈뼛!", "발톱으로 다 긁어버릴 거야!"] },
        "VIP": { 'Solo': ["얼마면 돼? 다 사주지.", "여기가 펜트하우스인가?", "샴페인 가져와.", "경치가 제법이군."], 'Love': ["이 도시를 너에게 줄게.", "다이아몬드보다 네가 빛나.", "내 재산목록 1호는 너야."], 'Affair': ["비밀 계약서에 사인해.", "호텔 스위트룸 잡아놨어.", "돈으로 살 수 없는 스릴이군."], 'Stress': ["다 해고해! 멍청이들!", "내 주식이 폭락했어!", "서비스가 엉망이군. 고소할 거야!"] }
    };

    const artifactsData = [
        { name: "구형 아이폰", emoji: "📱", desc: "2026년 인류가 엄지손가락으로 세상을 지배하던 마법 도구." },
        { name: "무선 이어폰", emoji: "🫛", desc: "콩처럼 생겼으며, 고대인들은 이를 귀에 꽂고 신호를 수신했다." },
        { name: "실물 카드", emoji: "💳", desc: "플라스틱 조각 하나로 모든 가치를 교환하던 시대의 산물." },
        { name: "컵라면 용기", emoji: "🍜", desc: "3분 만에 신들의 음식을 연성해내던 고대 연금술 용기." },
        { name: "유선 마우스", emoji: "🖱️", desc: "꼬리가 달린 쥐 모양의 장치. 2202년엔 뇌파가 대신한다." },
        { name: "지폐 뭉치", emoji: "💵", desc: "종이 쪼가리에 가치를 부여했던 인류의 집단 믿음의 증거." },
        { name: "종이 책", emoji: "📖", desc: "데이터가 아닌 실제 나무를 얇게 썰어 정보를 기록하던 낭만." },
        { name: "안경", emoji: "👓", desc: "시각 데이터를 교정하기 위해 얼굴에 걸치던 물리적 보정 장치." },
        { name: "열쇠 꾸러미", emoji: "🔑", desc: "물리적인 문을 열기 위해 들고 다니던 쇳조각들." },
        { name: "구형 게임기", emoji: "🎮", desc: "2026년 사람들이 가상 세계로 도피하던 작은 창구." },
        { name: "낡은 콤팩트 디스크", emoji: "💿", desc: "2026년 음악을 물리적으로 기록하던 반짝이는 원판." },
        { name: "아날로그 탁상시계", emoji: "⏰", desc: "바늘이 움직이며 물리적으로 시간을 가리키던 기계." },
        { name: "수동 성냥갑", emoji: "🕯️", desc: "마찰을 통해 불꽃을 만들어내던 2026년의 원시적 도구." },
        { name: "일회용 필름 카메라", emoji: "📸", desc: "결과물을 즉시 확인할 수 없어서 더 소중했던 기록기." },
        { name: "USB 메모리 칩", emoji: "💾", desc: "데이터를 물리적 조각에 담아 운반하던 번거로운 시대의 산물." },
        { name: "노란 포스트잇", emoji: "📝", desc: "디지털 메모 대신 종이에 적어 붙여놓던 고대인의 기록법." },
        { name: "철제 스테이플러", emoji: "🖇️", desc: "종이 뭉치를 물리적으로 고정하던 작고 강한 사무 도구." },
        { name: "대나무 부채", emoji: "🪭", desc: "직접 팔을 흔들어 바람을 만들던 2026년의 낭만적인 냉방 장치." },
        { name: "건전지식 플래시", emoji: "🔦", desc: "전기 에너지를 직접 휴대하며 어둠을 밝히던 유물." },
        { name: "500원 동전", emoji: "🪙", desc: "금속 조각에 가치를 담아 거래하던 시대의 마지막 화폐 중 하나." }
    ];

    const uniqueInfra = [
        {n: "낡은 네온사인 수리", h: false}, {n: "길거리 자판기 충전", h: false}, {n: "합성 라면 가판대", h: false},
        {n: "빈티지 레코드 샵", h: false}, {n: "심야 꼬치구이 집", h: false}, {n: "신경 동기화 액세서리 샵", h: false},
        {n: "구역 베이커리 '새벽'", h: false}, {n: "영혼 기억 백업 저장소", h: false}, {n: "네온 타코야키 노점", h: false},
        {n: "글로우 달콤한 푸딩 카페", h: true}, {n: "인공 비 정화 장치", h: false}, {n: "몽글몽글 귀청소 센터", h: true},
        {n: "무인 세탁 라운지", h: false}, {n: "사이버웨어 전용 안마소", h: true}, {n: "합성 물담배(시샤) 라운지", h: true},
        {n: "소형 안드로이드 수리소", h: false}, {n: "심야 합성 약국", h: false}, {n: "나노 문신 타투 아틀리에", h: false},
        {n: "피어싱 & 크롬 커스텀 샵", h: false}, {n: "사이버 근육 물리치료실", h: true}, {n: "네온 라이브 하우스", h: false},
        {n: "스트레스 뇌청소 샵", h: true}, {n: "유기농 아로마 사우나", h: true}, {n: "수면 유도 ASMR 룸", h: true},
        {n: "미드나잇 독립 시네마", h: false}, {n: "네온 대중 목욕탕", h: false}, {n: "24시 편의점 '네온'", h: false},
        {n: "데이터 칩 중고 서점", h: false}, {n: "레트로 게임 오락실", h: false}, {n: "사이버웨어 정밀 검진소", h: false},
        {n: "하늘을 나는 바이크 계류장", h: false}, {n: "홀로그램 액세서리 샵", h: false}, {n: "심야 만화 카페", h: true},
        {n: "구역 작은 미술관", h: true}, {n: "공중 정원 티룸", h: true}, {n: "네온 핀볼 센터", h: false},
        {n: "하늘을 나는 자동차 전용 주차장", h: false}, {n: "데이터 슬롯 노래방", h: false}, {n: "가상현실 테마 룸", h: true},
        {n: "사이버 펫 용품점", h: true}, {n: "천연 합성 온천 (Premium)", h: true}, {n: "크롬 시민 전용 휴식처 '생츄어리'", h: true},
        {n: "네온 피트니스 클럽", h: false}, {n: "수중 마사지 풀", h: true}, {n: "피부 재생 에스테틱", h: true},
        {n: "바이오 산소 캡슐", h: true}, {n: "향초 & 디퓨저 전문점", h: true}, {n: "기억 조각 홀로그램 샵", h: true},
        {n: "명상 & 요가 센터", h: true}, {n: "수면 보조제 약방", h: true}, {n: "지하 상가 라멘 투어", h: false},
        {n: "블루 오션 리조트", h: true}, {n: "사이버 만두 장인", h: false}, {n: "심야 딤섬 전문관", h: false},
        {n: "인공 고기 버거 하우스", h: false}, {n: "코티지 로컬 매거진 지부", h: false}, {n: "코인 런더리 & 북카페", h: true},
        {n: "골목길 빈티지 옷가게", h: false}, {n: "네온 신발 편집샵", h: false}, {n: "사이버 꽃 정원", h: true},
        {n: "지능형 방범 드론 허브", h: false}, {n: "퍼스널 컬러 진단실", h: false}, {n: "네온 네일 아트 아뜰리에", h: true},
        {n: "사이버 메이크업 센터", h: true}, {n: "영혼 기억 클라우드 센터", h: false}, {n: "중고 호버 바이크 샵", h: false},
        {n: "자율 주행 택시 승강장", h: false}, {n: "구역 공유 주차 타워", h: false}, {n: "비행선 투어 예약처", h: false},
        {n: "도시 통합 환승 센터", h: false}, {n: "5성급 프리미엄 테크 호텔", h: true}, {n: "빛바랜 센트럴 에비뉴 플라자", h: true},
        {n: "에너지 회수 발전 단지", h: false}, {n: "수경 재배 네온 온실", h: true}, {n: "지중열 난방 시스템", h: false},
        {n: "바이오 나노 재생 센터", h: true}, {n: "대규모 네온 쇼핑몰", h: false}, {n: "메가 코퍼레이션 컴퍼니", h: false},
        {n: "도시 혈관 물류망", h: false}, {n: "고고도 드론 보급로", h: false}, {n: "바이오 에너지 식물원", h: true},
        {n: "코티지 마인드 관제 센터", h: false}, {n: "하이퍼루프 센터", h: false}, {n: "우주 항공 센터", h: false},
        {n: "코티지 타워 건설", h: false}, {n: "은하수 관측 타워", h: false}, {n: "심야 위성 주파수 전송국", h: false},
        {n: "환경 회복 가속 센터", h: true}, {n: "기억 보관 은행", h: false}, {n: "인간-기계 협력 센터", h: false},
        {n: "테라포밍 시뮬레이션 랩", h: true}, {n: "오메가 인프라 망", h: false}, {n: "알파 시티 연산 센터", h: false},
        {n: "신세계 관문", h: false}, {n: "2026년식 아날로그 햇살 창문", h: true}, {n: "낡은 공용 산소 충전소", h: true},
        {n: "심야의 팅글 ASMR 헤어샵", h: true}, {n: "연극이 끝난 후의 소극장", h: true}, {n: "저궤도 별똥별 유도 장치", h: false},
        {n: "미드나잇 유토피아", h: true}
    ];

    const rankNames = ["소박하고 아늑한 사이버펑크 방", "네온 아틀리에", "작가와 교수의 서재", "리퍼닥의 정비소", "라디오 스튜디오", "포토 그래퍼의 암실", "합성 라면 가판대", "비 내리는 테라스", "빈티지 레코드 샵", "지붕 위 정원", "사우나", "크롬 온천실", "LP바", "펜트하우스의 만찬", "몰소프트 레스토랑", "디스트릭트 쿼터", "데이터 하이웨이", "갤럭시 시티", "골든 선셋 시티", "유토피아 미드나잇 코티지"];
    const rankImages = ["https://i.imgur.com/MuFQQ5A.png", "https://i.imgur.com/1nAnNIb.png", "https://i.imgur.com/eqwGBhl.png", "https://i.imgur.com/br0HdSG.png", "https://i.imgur.com/2Sz2iYA.png", "https://i.imgur.com/3qXyDTr.png", "https://i.imgur.com/J5mjTBn.png", "https://i.imgur.com/aI6UVY2.png", "https://i.imgur.com/QMSpzfL.png", "https://i.imgur.com/PwZ6vm3.png", "https://i.imgur.com/S4yBFXT.png", "https://i.imgur.com/A0HQ7e3.png", "https://i.imgur.com/qeB68bj.png", "https://i.imgur.com/RoQeLG8.png", "https://i.imgur.com/vuNzL4d.png", "https://i.imgur.com/P1SjHGR.png", "https://i.imgur.com/tApbEin.png", "https://i.imgur.com/ylCZJyn.png", "https://i.imgur.com/vA1hKCT.png", "https://i.imgur.com/ecGrFrH.png"];

    const upgrades = uniqueInfra.map((item, i) => ({
        id: `up${i}`, name: item.n,
        basePrice: Math.floor(15 * Math.pow(1.4, i)), 
        power: Math.floor(1 * Math.pow(1.2, i)), 
        type: i % 2 === 0 ? 'auto' : 'click', isHealing: item.h
    }));

    const achievements = [
        { id: 'cat', name: '냥이 월드', icon: '🐱', desc: '모든 주민이 고양이입니다.', unlocked: false, check: s => s.residents.length > 2 && s.residents.every(r => r.job === '고양이') },
        { id: 'drama', name: '사랑과 전쟁', icon: '💔', desc: '불륜 관계가 발생했습니다.', unlocked: false, check: s => s.residents.some(r => r.relType === '불륜') },
        { id: 'rich', name: '백만장자', icon: '💰', desc: '소지금 1,000,000 돌파.', unlocked: false, check: s => s.money >= 1000000 },
        { id: 'solo', name: '솔로 천국', icon: '🧘', desc: '5명 모두 솔로입니다.', unlocked: false, check: s => s.residents.length === 5 && s.residents.every(r => r.relType === '솔로') },
        { id: 'stress', name: '번아웃', icon: '🔥', desc: '주민 평균 스트레스 90% 이상.', unlocked: false, check: s => s.residents.length > 0 && (s.residents.reduce((a,b)=>a+b.stress,0)/s.residents.length) > 90 },
        { id: 'collector', name: '역사학자', icon: '📜', desc: '모든 유물(20종) 수집 완료.', unlocked: false, check: s => s.artifacts.every(a => a === true) }
    ];

    function getJosa(word, type) {
        if (!word) return '';
        const lastChar = word.charCodeAt(word.length - 1);
        const hasBatchim = (lastChar - 0xAC00) % 28 > 0;
        if (type === '이가') return hasBatchim ? '이' : '가';
        if (type === '을를') return hasBatchim ? '을' : '를';
        if (type === '와과') return hasBatchim ? '과' : '와';
        if (type === '은는') return hasBatchim ? '은' : '는';
        return '';
    }

    let setupIndex = 0;
    const tempResidents = []; 
    let snsPosts = [];

    window.onload = function() {
        init();
    };

    // [수정] 1. 저장 기능 (로컬 + 클라우드 동시에 처리)
    function saveGame() {
        // A. 브라우저 캐시(로컬) 저장 - 로그인 안 해도 작동함
        try {
            localStorage.setItem('midnight_cottage_v30_hardcore', JSON.stringify(state));
        } catch (e) {
            console.error("로컬 저장 실패", e);
        }

        // B. 클라우드 저장 - 로그인했을 때만 작동함
        if (currentUser) {
            db.collection("users").doc(currentUser.uid).set(state, { merge: true })
                .catch((error) => console.error("클라우드 자동 저장 실패:", error));
        }
    }

    // [수정] 2. 불러오기 기능 (시작할 때 자동 실행됨)
    function loadGame() {
        const saved = localStorage.getItem('midnight_cottage_v30_hardcore');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                Object.assign(state, parsed);
                return true; 
            } catch (e) {
                console.error("세이브 파일 오류", e);
                return false;
            }
        }
        return false; 
    }

    // [수정] 3. 게임 초기화
    function init() {
        state.upgrades = upgrades.map(u => ({ id: u.id, lv: 0, price: u.basePrice }));

        // 로컬 데이터를 먼저 찾아보고, 있으면 바로 게임 시작!
        if (loadGame()) {
            console.log("📂 브라우저 자동 저장 데이터 로드됨");
            document.getElementById('start-screen').style.display = 'none';
            startGame();
            addHistory("💻 <b>시스템:</b> 지난번 작업을 이어서 시작합니다.");
        } else {
            loadSetupUI(0);
        }
    }

    function loadSetupUI(idx) {
        setupIndex = idx;
        const countDisplay = document.getElementById('char-count');
        const nextBtn = document.getElementById('btn-next');
        const prevBtn = document.getElementById('btn-prev');
        const finishBtn = document.getElementById('btn-finish');
        const nameInput = document.getElementById('input-name');

        countDisplay.innerText = `${idx + 1} / 5`;
        
        const currentData = tempResidents[idx] || {};
        nameInput.value = currentData.name || '';
        document.getElementById('input-gender').value = currentData.gender || '남';
        document.getElementById('input-job').value = currentData.job || '화가'; 

        prevBtn.style.display = idx === 0 ? 'none' : 'block';
        finishBtn.style.display = tempResidents.length > 0 || idx > 0 ? 'block' : 'none';

        if (idx === 4) {
            nextBtn.style.display = 'none'; 
            finishBtn.style.width = "100%"; 
        } else {
            nextBtn.style.display = 'block';
            nextBtn.innerText = `추가 (${idx + 1}/5)`;
            nextBtn.style.background = "#bb9af7";
        }
    }

    function saveCurrentInput() {
        const job = document.getElementById('input-job').value;
        const selectedDialogues = jobsData[job]; 
        const selectedEmoji = jobEmojis[job] || '👤';

        tempResidents[setupIndex] = {
            id: setupIndex,
            name: document.getElementById('input-name').value || `주민${setupIndex+1}`,
            emoji: selectedEmoji, 
            gender: document.getElementById('input-gender').value,
            job: job,
            stress: 0, 
            affection: 50, 
            partnerId: null, 
            relType: '솔로',
            dialogues: selectedDialogues
        };
    }

    function nextChar() {
        saveCurrentInput();
        if (setupIndex < 4) loadSetupUI(setupIndex + 1);
    }

    function prevChar() {
        if (setupIndex > 0) loadSetupUI(setupIndex - 1);
    }

    // [수정] 4. 입주 시작 (가장 중요!)
    function finishSetup() {
        saveCurrentInput(); 
        state.residents = [...tempResidents]; 
        document.getElementById('start-screen').style.display = 'none';
        
        // 게임 시작
        startGame();

        // 🔥 입주하자마자 즉시 강제 저장!
        saveGame(); 
        console.log("✅ 입주 완료 및 즉시 저장됨");
    }

    function startGame() {
        changeNews();
        setInterval(changeNews, 300000);
        render(); updateUI(); renderAchievements();
        
        setInterval(() => { 
            let boost = 1 + (state.artifacts.filter(x=>x).length * 0.1);
            let income = state.autoIncome * boost;
            if (state.residents.length > 0) {
                let avgStress = state.residents.reduce((a,b)=>a+b.stress, 0) / state.residents.length;
                if (avgStress > 80) income *= 0.5;
            }

            state.money += income / 10; 
            state.residents.forEach(r => r.stress = Math.min(100, r.stress + 0.007));
            updateUI(); 
            checkAchievements();
        }, 100);
        setInterval(randomDailyEvent, 25000);
        setInterval(generateSNSPost, 60000); 

        // 💾 4초마다 자동 저장 실행
        setInterval(saveGame, 4000);

        if (window.innerWidth <= 768) {
            spawnMessage('💻작업 화이팅! 미드나잇 코티지가 너를 반겨.', 'event');
        }
    }

    function toggleModal(id) { 
        const m = document.getElementById(id); 
        if (m) {
            m.style.display = (m.style.display==='flex')?'none':'flex';
            if(id === 'sns-modal' && m.style.display === 'flex') {
                 document.getElementById('sns-dot').style.display = 'none'; 
            }
            if(id === 'shop-modal' && m.style.display === 'flex') {
                updateGachaUI();
            }
        }
    }

    const endingDialogues = {
        "화가": "이 방의 색채는 내 캔버스보다 아름다웠어. 영원히 기억할게.",
        "소설가": "우리의 챕터는 여기서 끝나지만, 네 이야기는 계속 써 내려가길.",
        "교수": "이곳의 기록은 역사에 남을 걸세. 자네 덕분이야.",
        "리퍼닥": "내 심장 엔진도 벅차오르는군. 완벽한 수리였어.",
        "ASMR DJ": "오늘 밤은 가장 평온한 빗소리를 들려줄게. 잘 자.",
        "모델": "화려한 조명보다 이 방의 은은한 네온이 더 좋았어.",
        "형사": "사건 종료. 범인은... 우리가 찾던 행복이었군.",
        "넷러너": "로그아웃하고 싶지 않은 서버는 여기가 처음이야.",
        "라멘노점상": "언제든 와. 따뜻한 국물 한 그릇은 평생 공짜니까.",
        "온천주인": "마음의 때까지 씻겨나가는 기분이었어. 고마워.",
        "LP바 사장님": "마지막 곡은 너를 위해 틀게. 이 리듬을 잊지 마.",
        "뮤지션": "내 최고의 명곡은 이 코티지에서 탄생했어. 땡큐!",
        "고양이": "야옹. (잘 있어라, 최고의 집사. 츄르 잊지 말고.)",
        "VIP": "이 정도 가치 있는 투자는 처음이군. 훌륭했어."
    };

    function startEndingSequence() {
        const screen = document.getElementById('ending-sequence');
        const container = document.querySelector('.rolling-container');
        const emojiDiv = document.getElementById('end-emoji');
        const nameDiv = document.getElementById('end-name');
        const msgDiv = document.getElementById('end-msg');
        const finalScreen = document.getElementById('final-screen');

        screen.style.display = 'flex';
        let step = 0;
        
        function showNextResident() {
            if (step >= state.residents.length) {
                container.style.display = 'none';
                finalScreen.style.display = 'block';
                finalScreen.style.animation = 'fade-in 2s forwards';
                return;
            }
            const char = state.residents[step];
            const msg = endingDialogues[char.job] || "함께해서 즐거웠어. 행복해야 해!";
            emojiDiv.innerText = char.emoji;
            nameDiv.innerText = `${char.job} ${char.name}`;
            msgDiv.innerText = `"${msg}"`;
            container.classList.add('show');
            setTimeout(() => {
                container.classList.remove('show');
                setTimeout(() => {
                    step++;
                    showNextResident();
                }, 1000); 
            }, 4000); 
        }
        showNextResident();
    }

    function closeEndingSequence() {
        document.getElementById('ending-sequence').style.display = 'none';
    }

    function getGachaPrice() {
        const foundCount = state.artifacts.filter(x => x).length;
        return 10000 * Math.pow(2, foundCount);
    }

    function updateGachaUI() {
        const price = getGachaPrice();
        const btn = document.getElementById('btn-gacha');
        const priceText = document.getElementById('gacha-price');
        priceText.innerText = `💵 ${price.toLocaleString()}`;
        if(state.artifacts.every(x => x)) {
            btn.disabled = true;
            btn.innerHTML = "모든 유물 수집 완료!";
        } else if(state.money < price) {
            btn.disabled = true;
        } else {
            btn.disabled = false;
        }
    }

    function buyArtifact() {
        const price = getGachaPrice();
        if(state.money >= price) {
            state.money -= price;
            const unfound = state.artifacts.map((v, i) => v === false ? i : null).filter(v => v !== null);
            if (unfound.length > 0) {
                const pick = unfound[Math.floor(Math.random()*unfound.length)];
                state.artifacts[pick] = true; 
                renderMuseum();
                showCenterPopup(artifactsData[pick].emoji, '유물 복원 성공!', artifactsData[pick].name);
                addHistory(`🏺 <b>유물 복원:</b> [${artifactsData[pick].name}] 복원 완료! (수익 +10%)`);
            }
            updateUI();
            updateGachaUI();
            saveGame();
        }
    }

    function generateSNSPost() {
        if (state.residents.length === 0) return;
        const char = state.residents[Math.floor(Math.random() * state.residents.length)];
        let text = "";
        const generalPosts = ["오늘 파티할 사람?", "집이 최고야.", "이 거리 힙하네.", "배터리 충전 중...", "책 읽기 좋은 밤.", "심심해 놀아줘!", "편의점 도시락 지겨워.", "누가 내 자전거 훔쳐갔어?", "비 오는 날엔 파전이지.", "네온사인이 오늘따라 예쁘네.", "고양이 귀여워.", "인생...", "월급 언제 들어오지?", "야식 추천 좀.", "새로 생긴 가게 가볼 사람?", "오늘 날씨 미쳤다.", "출근하기 싫다.", "퇴근하고 맥주 한잔?", "주말 순삭...", "넷플릭스 볼 거 추천 좀.", "다이어트는 내일부터.", "오늘 오오티디.", "맛집 발견!", "커피 수혈 시급.", "잠이 안 와.", "새벽 감성 터지네.", "옛날 노래 듣는 중.", "여행 가고 싶다.", "방 청소 해야 하는데...", "이불 밖은 위험해.", "오늘 기분 맑음.", "스트레스엔 매운 거.", "소확행.", "멍 때리는 중.", "배고파.", "지구 멸망했으면.", "로또 당첨 기원.", "산책 갈까?", "택배 왔다!", "밀린 빨래 해야지."];
        if (char.job === '고양이') { text = ["냥.", "골골골...", "츄르 내놔라 닝겐.", "우다다다다다!!", "그르릉...", "박스 내꺼.", "높은 곳이 좋아.", "낮잠 시간이다냥.", "집사야 놀아줘."][Math.floor(Math.random()*9)]; } 
        else if (char.relType === '불륜') { text = ["비밀 계정입니다.", "오늘 밤도...", "쉿.", "아무도 모르게.", "심장이 뛴다.", "위험한데 멈출 수 없어.", "이러면 안 되는데...", "보고 싶어."][Math.floor(Math.random()*8)]; } 
        else if (char.stress > 80) { text = ["아 진짜 다 짜증 나네.", "건들지 마라.", "퇴사 마렵다.", "세상이 망했으면.", "아무것도 하기 싫어.", "머리 아파.", "다 때려치우고 싶다.", "폭발 직전."][Math.floor(Math.random()*8)]; } 
        else { text = generalPosts[Math.floor(Math.random() * generalPosts.length)]; }
        const post = { emoji: char.emoji, name: char.name, time: new Date().toLocaleTimeString().slice(0, 5), text: text };
        snsPosts.unshift(post);
        if (snsPosts.length > 20) snsPosts.pop();
        renderSNS();
        document.getElementById('sns-dot').style.display = 'block';
    }

    function renderSNS() {
        const feed = document.getElementById('sns-feed');
        if(feed) feed.innerHTML = snsPosts.map(p => `<div class="sns-post"><div class="sns-user"><div class="sns-avatar">${p.emoji}</div><div class="sns-name">${p.name}</div><div class="sns-time">${p.time}</div></div><div class="sns-text">${p.text}</div></div>`).join('');
    }

    function checkAchievements() {
        let changed = false;
        achievements.forEach(ach => {
            if (!ach.unlocked && ach.check(state)) {
                ach.unlocked = true;
                changed = true;
                showCenterPopup(ach.icon, "업적 달성!", ach.name);
                addHistory(`🏆 <b>업적 달성:</b> [${ach.name}] - ${ach.desc}`);
            }
        });
        if (changed) { renderAchievements(); }
    }

    function renderAchievements() {
        document.getElementById('ach-grid').innerHTML = achievements.map(a => `<div class="ach-item ${a.unlocked ? 'unlocked' : ''}"><div class="ach-icon">${a.icon}</div><div class="ach-title">${a.name}</div><div class="ach-desc">${a.unlocked ? a.desc : '???' }</div></div>`).join('');
    }

    function spawnMessage(text, type) {
        const stack = document.getElementById('dialogue-stack');
        if(!stack) return;
        const bubble = document.createElement('div');
        bubble.className = `dialogue-bubble ${type}`;
        bubble.innerHTML = text;
        stack.appendChild(bubble);
        
        setTimeout(() => {
            bubble.style.animation = 'fade-out-bubble 0.5s forwards';
            setTimeout(() => bubble.remove(), 500);
        }, 3500);
    }

    function addHistory(msg) {
        const timeMsg = `[${new Date().toLocaleTimeString()}] ${msg}`;
        state.history.unshift(timeMsg);
        if (state.history.length > 50) state.history.pop();
        
        const list = document.getElementById('history-list');
        if (list) list.innerHTML = state.history.map(h => `<li>${h}</li>`).join('');
        
        const eventLog = document.getElementById('event-log');
        if (eventLog) eventLog.innerHTML = msg; 

        if (window.innerWidth <= 768) {
            let cleanMsg = msg.replace(/<[^>]*>?/gm, ''); 
            if(cleanMsg.includes(']')) cleanMsg = cleanMsg.split(']')[1].trim(); 
            spawnMessage(cleanMsg, 'event');
        }
    }

    function changeNews() {
        const newsList = ["산성비 주의보 (스트레스 UP)", "네온 축제 (힐링 UP)", "네트워크 장애 (수익 DOWN)", "기업 보조금 (수익 UP)", "심야의 고요 (평화로움)"];
        const pick = newsList[Math.floor(Math.random()*newsList.length)];
        const banner = document.getElementById('news-banner');
        if (banner) banner.innerText = "📢 오늘의 뉴스: " + pick;
    }

    function showCenterPopup(emoji, title, sub) {
        const popup = document.createElement('div');
        popup.className = 'center-popup';
        popup.innerHTML = `<div style="font-size:40px;">${emoji}</div><div>${title}</div><div style="font-size:16px; color:#fff; font-weight:500;">[${sub}]</div>`;
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 3000);
    }

    function showEvolutionToast(rankName) {
        const evo = document.createElement('div');
        evo.className = 'evo-toast';
        evo.innerHTML = `🌙 코티지룸 진화!<br><span style="font-size:18px; color:#fff;">[${rankName}] 해금</span>`;
        document.body.appendChild(evo);
        setTimeout(() => evo.remove(), 4000);
    }

    function closeModalByBg(e, id) {
        if (id === 'museum-modal') { if (!e.target.closest('.artifact-slot')) { toggleModal(id); } return; }
        if (e.target.id === id) { toggleModal(id); }
    }

    function selectRoom(rankIndex) {
        state.currentSelectedRank = rankIndex;
        updateUI();
        showCenterPopup('🖼️', '배경 변경 완료!', rankNames[rankIndex-1]);
        toggleModal('gallery-modal');
    }

    function render() {
        document.getElementById('res-grid').innerHTML = state.residents.map((r, i) => {
            let relText = r.relType;
            if (r.partnerId !== null && state.residents[r.partnerId]) { relText = `${state.residents[r.partnerId].name}의 ${r.relType}`; }
            const genderBg = r.gender === '여' ? 'var(--female-bg)' : (r.gender === '남' ? 'var(--male-bg)' : '#444');
            return `<div class="res-card" onclick="talkToResident(${i})"><div class="res-icon-box" style="background: ${genderBg}">${r.emoji}</div><div class="stress-box"><div class="stress-fill" id="stress-${i}" style="width: ${r.stress}%"></div></div><div class="res-name">${r.name}</div><div class="res-job" style="font-size:8px;">${r.job}</div><div class="res-rel">${relText}</div></div>`;
        }).join('');
        
        document.getElementById('upgrade-list').innerHTML = state.upgrades.map((u, i) => {
            const data = upgrades[i];
            return `<div class="up-card"><div class="up-info"><h4>${data.name} <small>(Lv.${u.lv})</small></h4><div class="tags">${u.lv === 0 ? '<span class="tag-dev">⭐ 발전도 +1</span>' : ''}${data.isHealing ? '<span class="tag-healing">🌿 스트레스 해소</span>' : ''}</div><p>${data.type === 'click' ? '클릭' : '초당'} +${data.power.toLocaleString()}</p></div><button class="buy-btn" id="btn-${u.id}" onclick="buy(${i})">💵 ${u.price.toLocaleString()}</button></div>`;
        }).join('');
        renderMuseum();
    }

    function renderMuseum() {
        document.getElementById('museum-list').innerHTML = artifactsData.map((a, i) => `<div class="artifact-slot ${state.artifacts[i] ? 'found' : ''}" onclick="showArt(${i}, event)">${state.artifacts[i] ? a.emoji : '?'}</div>`).join('');
    }

    function showArt(i, e) { 
        e.stopPropagation(); 
        const descBox = document.getElementById('artifact-desc');
        if(state.artifacts[i]) descBox.innerText = `테오: "${artifactsData[i].desc}"`; 
        else descBox.innerText = "아직 미수집된 유물이니 암시장에서 구해봐!";
    }

    function buy(idx) {
        const u = state.upgrades[idx], d = upgrades[idx];
        
        // 1. 구매 로직
        if(state.money >= u.price) {
            state.money -= u.price; 
            
            if(u.lv === 0) { 
                state.totalUniquePurchased++; 
                addHistory(`🏗️ <b>신규 시설:</b> [${d.name}] 건설 완료.`); 
            }
            u.lv++;
            
            if(d.type === 'click') state.clickPower += d.power; 
            else state.autoIncome += d.power;
            
            if(d.isHealing) state.residents.forEach(r => r.stress = Math.max(0, r.stress - 20));
            
            u.price = Math.floor(u.price * 1.6);
            
            const newRank = Math.min(20, Math.floor(state.totalUniquePurchased / 5) + 1);
            if (newRank > state.rank) {
                state.rank = newRank; 
                state.currentSelectedRank = newRank;
                showEvolutionToast(rankNames[newRank-1]);
                addHistory(`🌟 <b>도시 진화:</b> [${rankNames[newRank-1]}] 달성!`);
                
                if (newRank >= 20 && !state.endingSeen) { 
                    state.endingSeen = true; 
                    startEndingSequence(); 
                }
            }
            
            render(); 
            updateUI();
            
            // 🔥 [수정] 돈 썼으니까 바로 저장!
            saveGame();
        }

        // 2. 버튼 뽀잉 연출
        const btn = document.getElementById(`btn-${u.id}`);
        if (btn) {
            btn.classList.remove('click-animate'); 
            void btn.offsetWidth; // 애니메이션 리셋 매직 코드
            btn.classList.add('click-animate'); 
        }
    }

    function updateUI() {
        document.getElementById('budget').innerText = Math.floor(state.money).toLocaleString();
        state.upgrades.forEach(u => { const btn = document.getElementById(`btn-${u.id}`); if(btn) btn.disabled = state.money < u.price; });
        state.residents.forEach((r, i) => { const fill = document.getElementById(`stress-${i}`); if(fill) fill.style.width = r.stress + '%'; });
        const currentProgress = state.totalUniquePurchased % 5;
        const displayRankName = `Rank.${state.currentSelectedRank} ${rankNames[state.currentSelectedRank-1]}`;
        const displayProgress = (currentProgress * 20) + '%';
        const displayCount = `${currentProgress} / 5`;
        if(document.getElementById('dev-bar-fill')) document.getElementById('dev-bar-fill').style.width = displayProgress;
        if(document.getElementById('dev-count')) document.getElementById('dev-count').innerText = displayCount;
        if(document.getElementById('city-name-display')) document.getElementById('city-name-display').innerText = displayRankName;
        if(document.getElementById('mob-dev-bar-fill')) document.getElementById('mob-dev-bar-fill').style.width = displayProgress;
        if(document.getElementById('mob-dev-count')) document.getElementById('mob-dev-count').innerText = displayCount;
        if(document.getElementById('mob-city-name-display')) document.getElementById('mob-city-name-display').innerText = displayRankName;
        document.getElementById('desk-clicker').src = rankImages[state.currentSelectedRank-1];
        const artCount = state.artifacts.filter(x=>x).length;
        if (document.getElementById('artifact-boost')) document.getElementById('artifact-boost').innerText = artCount > 0 ? `(유물 버프 +${artCount*10}%)` : "";
    }

    function talkToResident(idx) {
        const res = state.residents[idx];
        if(!res) return;
        let pool = res.dialogues['Solo'];
        if (res.stress > 80) pool = res.dialogues['Stress'];
        const msg = pool[Math.floor(Math.random()*pool.length)];
        
        spawnMessage(`${res.name}: "${msg}"`, 'talk');
    }

    function randomDailyEvent() {
        if (state.residents.length < 2) return;

        // 랜덤하게 두 명 뽑기
        const p1 = Math.floor(Math.random() * state.residents.length);
        let p2 = Math.floor(Math.random() * state.residents.length);
        while(p1 === p2) { p2 = Math.floor(Math.random() * state.residents.length); } 
        
        const charA = state.residents[p1];
        const charB = state.residents[p2];
        const rand = Math.random();

        // 1. 대화 및 호감도 변화
        if (rand < 0.45) {
            charA.affection += 5; charB.affection += 5;
            addHistory(`💬 <b>대화:</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 즐거운 대화를 나눴어. <span style="color:var(--heart)">(❤️+5)</span>`);
        } else if (rand < 0.65) {
            charA.affection -= 10; charB.affection -= 10; // 싸우면 호감도 더 많이 깎임
            addHistory(`⚡ <b>논쟁:</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 사소한 오해로 다퉜어. <span style="color:#888">(💔-10)</span>`);
        }

        // 호감도 0~100 제한
        state.residents.forEach(r => { r.affection = Math.max(0, Math.min(100, r.affection)); });

        // 2. 관계 변화 로직
        
        // A. [이별] 커플인데 호감도가 30 미만으로 떨어지면 헤어짐
        if (charA.partnerId === charB.id && (charA.affection < 30 || charB.affection < 30)) {
            charA.relType = '솔로'; charB.relType = '솔로';
            charA.partnerId = null; charB.partnerId = null;
            
            showCenterPopup("💔", "결별", `${charA.name} ⚡ ${charB.name}`);
            addHistory(`💔 <b>이별:</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 성격 차이를 극복하지 못하고 남남이 되었습니다.`);
            saveGame();
        }

        // B. [커플 탄생] 둘 다 솔로이고 호감도가 90 이상일 때
        else if (charA.affection >= 90 && charB.affection >= 90) {
            if (charA.relType === '솔로' && charB.relType === '솔로') {
                charA.relType = '커플'; charB.relType = '커플';
                charA.partnerId = charB.id; charB.partnerId = charA.id;
                
                showCenterPopup("💖", "커플 탄생!", `${charA.name} ♥ ${charB.name}`);
                addHistory(`💖 <b>축하합니다!</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 연인이 되었습니다!`);
                saveGame();
            }
            
            // C. [불륜] 한 명이라도 파트너가 있는데 호감도가 높을 때
            else if (charA.partnerId !== charB.id && (charA.relType === '커플' || charB.relType === '커플')) {
                if (charA.relType !== '불륜' || charB.relType !== '불륜') {
                    charA.relType = '불륜'; charB.relType = '불륜';
                    showCenterPopup("😈", "위험한 관계", `${charA.name} & ${charB.name}`);
                    addHistory(`😈 <b>충격!</b> ${charA.name}${getJosa(charA.name, '와과')} ${charB.name}${getJosa(charB.name, '은는')} 금지된 사랑에 빠졌습니다...`);
                    saveGame();
                }
            }
        }

        render(); // 화면 갱신
    }

    document.getElementById('desk-clicker').onclick = (e) => { 
        state.money += state.clickPower; 
        const star = document.createElement('div'); star.className = 'hit-effect'; star.innerText = '🌟';
        star.style.left = (e.clientX - 32) + 'px'; star.style.top = (e.clientY - 32) + 'px';
        document.body.appendChild(star); setTimeout(() => star.remove(), 300);
        updateUI(); 
    };

    function resetGame() {
        if (confirm("정말 모든 데이터를 삭제하고 입주 신청서부터 다시 시작할까?\n(주의: 클라우드에 저장된 백업 데이터도 영구 삭제됩니다.)")) {
            // 1. 로컬 저장소 데이터 삭제
            localStorage.removeItem('midnight_cottage_v30_hardcore');

            // 2. 구글 로그인이 되어있다면, 서버 데이터 삭제 + 로그아웃 수행
            if (currentUser) {
                // A. 서버 데이터 삭제
                db.collection("users").doc(currentUser.uid).delete()
                    .then(() => {
                        // B. 삭제 성공 시 로그아웃 (연동 끊기)
                        auth.signOut().then(() => {
                            alert("모든 데이터가 삭제되고 계정 연동이 해제되었습니다.");
                            location.reload(); // 깨끗한 상태로 새로고침
                        });
                    })
                    .catch((error) => {
                        console.error("클라우드 삭제 실패:", error);
                        // 에러가 나더라도 로컬은 지웠으니 일단 새로고침
                        location.reload(); 
                    });
            } else {
                // 로그인 안 한 상태면 바로 새로고침
                location.reload();
            }
        }
    }

    function openGallery() {
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = rankNames.map((name, i) => {
            const unlocked = i < state.rank;
            const isSelected = (i + 1) === state.currentSelectedRank;
            return `<div class="gallery-item ${unlocked ? 'unlocked' : 'locked'} ${isSelected ? 'active' : ''}" onclick="${unlocked ? `selectRoom(${i+1})` : ''}"><img src="${rankImages[i]}" loading="lazy"><div style="background:rgba(0,0,0,0.6); color:#fff; font-size:12px; font-weight:700;">${i+1}. ${name} ${isSelected ? ' (사용중)' : ''}</div></div>`;
        }).join('');
        toggleModal('gallery-modal');
    }
</script>
</body>
</html>